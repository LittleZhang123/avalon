define(["avalon","text!./avalon.timer.html","css!../chameleon/oniui-common.css","css!./avalon.timer.css","../dialog/avalon.dialog"],function(e,t){function a(e){var t=e.getElementsByTagName("div"),n=null,r=null,i=null,s=null,o="";for(var u=0,a=t.length;u<a;u++)n=t[u],o=n.className,o.indexOf("oni-timer-date")!=-1?r=n:o.indexOf("oni-timer-hour")!=-1?i=n:o.indexOf("oni-timer-minute")!=-1&&(s=n);return[r,i,s]}function f(e,t){e=String(e);for(var n=0,r=t-e.length;n<r;n++)e="0"+e;return e}function l(e){var t=new Date,n=t,r=[],i="",s=0,o=0,u=0,a=[],l="",c=[],h="",p,d=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];if(!(a=e.getHours())){a=[];for(p=0;p<24;p++)l=f(p,2),a.push({hour:l,_hour:p,color:"rgba(51, 51, 51, 1)"})}if(!(c=e.getMinutes())){c=[];for(p=0;p<60;p+=5)h=f(p,2),c.push({minute:h,_minute:p,color:"rgba(51, 51, 51, 1)"})}if(!(r=e.getDates())){r=[];for(p=1;p<60;p++)s=t.getFullYear(),o=t.getMonth(),u=t.getDate(),i=(e.showYears?s+"年":"")+f(o+1,2)+"月"+f(u,2)+"日"+d[t.getDay()],t=new Date(n.setDate(n.getDate()+p)),n=new Date,r.push({date:i,year:s,month:o,day:u,color:"rgba(51, 51, 51, 1)"})}return{dates:r,minutes:c,hours:a}}function c(e,t){var n="",r="";t.forEach(function(t,s){e==="mousewheel"?(n="ms-on-mousewheel",r='_eventCallback("'+e+'", $event)'):(n="ms-on-"+i.eStart,r='_eventCallback("start", $event)'),t.setAttribute(n,r)})}function h(e,t,n,r){var i=e._initIndex,s=-t+i,o,u=0,a=0,f=0,l=0;e[r]=s,o=e[n],l=o.length;if(s<0||s>=l)return;o[s].color="rgb(51, 51, 51)";for(var c=i;c>0;c--)u=s-c,a=s+c,f=.2*(4-c+1),f>=1?f=.9:f<=0&&(f=.1),u>-1&&u<l&&(o[u].color="rgba(51, 51, 51, "+f+")"),a>-1&&a<l&&(o[a].color="rgba(51, 51, 51, "+f+")")}function p(e,t,n,r,i){var s=e._name;if(!t[s]){t[s]=new v(n.$model),t[s][r](e,i,n);return}t[s][r](e,i,n)}var n=null,r=typeof window.ontouchstart!="undefined",i={eStart:r?"touchstart":"mousedown",eMove:r?"touchmove":"mousemove",eEnd:r?"touchend":"mouseup"},s=t.split("MS_OPTION_TEXTBOX"),t=s[1],o=s[0],u=e.ui.timer=function(n,r,i){var s=r.timerOptions,u={},f=0,h,d=null;s.template=s.getTemplate(t,s),e.mix(s,l(s)),f=Math.floor(s.showItems/2);var v=e.define(r.timerId,function(r){e.mix(r,s),r.widgetElement=n,r.$skipArray=["widgetElement","eventType","_initIndex","dialog","_dialog","textbox"],r._initIndex=f,r._timerHeight=0,r._timerWidth=0,r._hourLeft=0,r._minuteLeft=0,r._currentDateIndex=f,r._currentHourIndex=f,r._currentMinuteIndex=f,r._dialog=null,r._timeTextColor="#999999",r.timeDate=null,r._toggleDialog=function(){var e=v._dialog;e&&!e.toggle&&(e.toggle=!0)},r.dialog.onInit=function(t){v._dialog=t,t.$watch("toggle",function(t){if(t){var n=0,r=0,i=a(h),s=i[0],o=i[1],f=i[2];s._name="date",o._name="hour",f._name="minute",p(s,u,v,"_initPosition"),p(o,u,v,"_initPosition"),p(f,u,v,"_initPosition"),n=e(s).outerWidth(),v._hourLeft=n,r=v._minuteLeft=n+e(o).outerWidth(),v._timerWidth=r+e(f).outerWidth()}})},r.dialog.onConfirm=function(){var e=v.getTime();v.timeDate=e,v._timeTextColor="#333"},r._eventCallback=function(e,t){var n=this;switch(e){case"mousewheel":p(n,u,v,"_wheel",t);break;case"start":p(n,u,v,"_"+e,t)}},r.getTime=function(){var e=v.dates[v._currentDateIndex],t=v.hours[v._currentHourIndex]._hour,n=v.minutes[v._currentMinuteIndex]._minute;return new Date(e.year,e.month,e.day,t,n)},r.$init=function(){var r=[],u=document.createElement("span");n.style.display="none",h=e.parseHTML(t).firstChild,n.parentNode.insertBefore(u,n),d=e.parseHTML(o).firstChild,u.parentNode.replaceChild(d,u),e.scan(d,v),document.body.appendChild(h),v._timerHeight=30*s.showItems,h.setAttribute("ms-widget","dialog"),r=a(h),c(s.eventType,r),e.scan(h,[v].concat(i)),typeof s.onInit=="function"&&s.onInit.call(n,v,s,i)},r.$remove=function(){h.innerHTML=h.textContent="",h.parentNode.removeChild(h),d.innerHTML=d.textContent="",d.parentNode.removeChild(d)}});return v};u.defaults={showItems:9,width:180,placeHolder:"请选择时间",getTimeText:function(e,t){var n=t;return e&&(n=e.toLocaleString()),n},showYears:!1,eventType:"touch",mouseWheelSpeed:20,useTransform:!0,getDates:e.noop,getHours:e.noop,getMinutes:e.noop,dialog:{title:"选择时间",width:300,showClose:!1},getTemplate:function(e,t){return e}},e.bind(document,i.eMove,function(t){var r="",i=null;n&&(r=n.timerId,i=e.vmodels[r],i&&i.eventType!="mousewheel"&&n._move(n.element,t,i))}),e.bind(document,i.eEnd,function(t){var r="",i=null;n&&(r=n.timerId,i=e.vmodels[r],i&&i.eventType!="mousewheel"&&n._end(n.element,t,i))});var d=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},v=function(){function o(e){return s===!1?!1:s===""?e:s+e.charAt(0).toUpperCase()+e.substr(1)}function u(e){this.y=0,this.initWheel=null,this.useTransition=e.useTransition&&t.hasTransition,this.useTransform=e.useTransform&&t.hasTransform,this.maxScrollY=0,this.minScrollY=0,this.options=e,this.endTime=0,this.bounce=!0,this.bounceTime=600,this.bounceEasing="",this.element=null,this.momentum=e.momentum||!0,this.momentHeight=100}var t={},r=document.createElement("div").style,s=function(){var e=["t","webkitT","MozT","msT","OT"],t,n=0,i=e.length;for(;n<i;n++){t=e[n]+"ransform";if(t in r)return e[n].substr(0,e[n].length-1)}return!1}();return t.ease={quadratic:{style:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",fn:function(e){return e*(2-e)}},circular:{style:"cubic-bezier(0.1, 0.57, 0.1, 1)",fn:function(e){return Math.sqrt(1- --e*e)}},back:{style:"cubic-bezier(0.175, 0.885, 0.32, 1.275)",fn:function(e){var t=4;return(e-=1)*e*((t+1)*e+t)+1}},bounce:{style:"",fn:function(e){return(e/=1)<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}},elastic:{style:"",fn:function(e){var t=.22,n=.4;return e===0?0:e==1?1:n*Math.pow(2,-10*e)*Math.sin((e-t/4)*2*Math.PI/t)+1}}},t.hasTransition=o("transition")in r,t.hasTransform=o("transform")!==!1,t.hasTouch="ontouchstart"in window,t.getTime=Date.now||function(){return(new Date).getTime()},t.style={transform:o("transform"),transitionTimingFunction:o("transitionTimingFunction"),transitionDuration:o("transitionDuration")},t.momentum=function(e,t,n,r,i,s,o){var u=e-t,a=Math.abs(u)/n,f,l;return o=o===undefined?6e-4:o,f=e+a*a/(2*o)*(u<0?-1:1),l=a/o,f<r?(f=s?r-s/2.5*(a/8):r,u=Math.abs(f-e),l=u/a):f>i&&(f=s?s/2.5*(a/8):i,u=Math.abs(e)+f,l=u/a),{destination:Math.round(f),duration:l}},u.prototype._initPosition=function(e,t,n){var r=n.$model,i=Math.floor(r.showItems/2)*30,s=new Date,o=s.getHours(),u=s.getMinutes(),a=n.dates,f=n.hours,l=n.minutes;switch(e._name){case"hour":for(var c=0,h=f.length;c<h;c++){var p=+f[c]._hour;if(p===o){i-=c*30;break}}break;case"minute":for(var c=0,h=l.length;c<h;c++){var d=+l[c]._minute,v=+(l[c+1]&&l[c+1]._minute||59),m=Number((v-d)/2);if(u>=d&&u<=v){u+m>v?c==h-1?i-=c*30:i-=(c+1)*30:i-=c*30;break}}}this._scrollTo(null,e,n,0,i)},u.prototype._initMaxScroll=function(t,n){var r=e(t),i=Math.floor(n.showItems/2)*30;this.maxScrollY||(this.maxScrollY=i+30-r.height(),this.minScrollY=i,this.maxMomentHeight=this.maxScrollY-this.momentHeight,this.minMomentHeight=this.minScrollY+this.momentHeight)},u.prototype._wheel=function(e,t,n){t.preventDefault(),t.stopPropagation();var r=e,i,s,o=0,u=0,a=this.options,f=(t.wheelDelta||-t.detail)>0?1:-1,l=a.mouseWheelSpeed;this._initMaxScroll(e,a),o=this.maxScrollY,u=this.minScrollY,i=f*l,s=this.y+i,s>u?s=u:s<o&&(s=o),this._scrollTo(t,e,n,0,s,0)},u.prototype._resetPosition=function(e,t,n,r){var i=this.y,s=this.maxScrollY,o=this.minScrollY;return r=r||0,i>o?i=o:i<s&&(i=s),i==this.y?!1:(this._scrollTo(e,t,n,0,i,r,this.bounceEasing),!0)},u.prototype._scrollTo=function(e,n,r,i,s,o,u){u=u||t.ease.circular,!o||this.useTransition&&u.style?this._translate(n,r,i,s,e):this._animate(n,r,i,s,o,u.fn,e)},u.prototype._translate=function(e,n,r,s,o){var u=Math.round(s/30),a="",f="",l=o&&o.type||"";if(l==="mousewheel"||l===i.eEnd)s=u*30;switch(e._name){case"date":a="dates",f="_currentDateIndex";break;case"hour":a="hours",f="_currentHourIndex";break;case"minute":a="minutes",f="_currentMinuteIndex"}h(n,u,a,f),this.useTransform?e.style[t.style.transform]="translateY("+s+"px)":(s=Math.round(s),e.top=s+"px"),this.y=s},u.prototype._animate=function(e,n,r,i,s,o,u){function h(){var p=t.getTime(),v,m,g;if(p>=c){a.isAnimating=!1,a._translate(e,n,r,i,u),a._resetPosition(u,e,n,a.bounceTime);return}p=(p-l)/s,g=o(p),m=(i-f)*g+f,a._translate(e,n,v,m,u),a.isAnimating&&d(h)}var a=this,f=this.y,l=t.getTime(),c=l+s;this.isAnimating=!0,h()},u.prototype._start=function(e,r,i){var s=r.touches?r.touches[0]:r,o=this.options,u;n=this,this.timerId=i.$id,this.element=e,this.distY=0,this.initiated=!0,this._initMaxScroll(e,o),this.startTime=t.getTime(),this.startY=this.y,this.pointY=s.pageY},u.prototype._move=function(e,r,i){if(!this.initiated||!this.element||!n)return;var s=r.touches?r.touches[0]:r,o=s.pageY-this.pointY,u=t.getTime(),a,f,l,c;this.pointY=s.pageY,this.distY+=o,f=Math.abs(this.distY);if(u-this.endTime>300&&f<10)return;a=this.y+o,this.momentum&&(l=this.minMomentHeight,c=this.maxMomentHeight);if(a>l||a<c)a=this.bounce?this.y+o/3:a>l?l:c;this._translate(e,i,0,a,r),u-this.startTime>300&&(this.startTime=u,this.startY=this.y)},u.prototype._end=function(e,r,i){var s=r.changedTouches?r.changedTouches[0]:r,o,u=t.getTime()-this.startTime,a=Math.round(this.y),f=Math.abs(a-this.startY),l=0,c="",h=this.minScrollY,p=this.maxScrollY;n=null,this.initiated=!1,this.endTime=t.getTime();if(this._resetPosition(r,e,i,this.bounceTime))return;this._scrollTo(r,e,i,0,a),this.momentum&&u<300&&(o=t.momentum(this.y,this.startY,u,p,h,this.bounce?this.options._timerHeight:0,this.deceleration),a=o.destination);if(a!=this.y){if(a>h||a<p)c=t.ease.quadratic;this._scrollTo(r,e,i,0,a,l,c)}this._scrollTo(r,e,i,0,a)},u}();return e});