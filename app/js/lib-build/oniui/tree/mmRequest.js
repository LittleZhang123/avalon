define("mmRequest",["avalon","./mmPromise"],function(avalon){function ajaxExtend(e){e=avalon.mix({},defaults,e);if(typeof e.crossDomain!="boolean"){var t=rurl.exec(e.url.toLowerCase());e.crossDomain=!(!t||t[1]===segments[1]&&t[2]===segments[2]&&(t[3]||(t[1]==="http:"?80:443))===(segments[3]||(segments[1]==="http:"?80:443)))}var n=typeof e.data=="string"?e.data:avalon.param(e.data);return e.querystring=n||"",e.url=e.url.replace(/#.*$/,"").replace(/^\/\//,segments[1]+"//"),e.type=e.type.toUpperCase(),e.hasContent=!rnoContent.test(e.type),e.hasContent||(n&&(e.url+=(rquery.test(e.url)?"&":"?")+n),e.cache===!1&&(e.url+=(rquery.test(e.url)?"&":"?")+"_time="+(new Date-0))),e}function parseXML(e,t,n){try{var r=document.documentMode;window.DOMParser&&(!r||r>8)?(n=new DOMParser,t=n.parseFromString(e,"text/xml")):(t=new ActiveXObject("Microsoft.XMLDOM"),t.async="false",t.loadXML(e))}catch(i){t=undefined}return(!t||!t.documentElement||t.getElementsByTagName("parsererror").length)&&avalon.error("Invalid XML: "+e),t}function parseJS(code){var indirect=eval;code=code.trim();if(code)if(code.indexOf("use strict")===1){var script=document.createElement("script");script.text=code,head.appendChild(script).parentNode.removeChild(script)}else indirect(code)}function isValidParamValue(e){var t=typeof e;return e==null||t!=="object"&&t!=="function"}var global=window,DOC=global.document,r20=/%20/g,rCRLF=/\r?\n/g,encode=encodeURIComponent,decode=decodeURIComponent,rheaders=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,rlocalProtocol=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,rnoContent=/^(?:GET|HEAD)$/,rquery=/\?/,rurl=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,curl=DOC.URL,segments=rurl.exec(curl.toLowerCase())||[],isLocal=rlocalProtocol.test(segments[1]),head=DOC.head||DOC.getElementsByTagName("head")[0],s=["XMLHttpRequest","ActiveXObject('MSXML2.XMLHTTP.6.0')","ActiveXObject('MSXML2.XMLHTTP.3.0')","ActiveXObject('MSXML2.XMLHTTP')","ActiveXObject('Microsoft.XMLHTTP')"];"1"[0]||(s[0]=location.protocol==="file:"?"!":s[0]);for(var i=0,axo;axo=s[i++];)try{if(eval("new "+axo)){avalon.xhr=new Function("return new "+axo);break}}catch(e){}var accepts={xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",script:"text/javascript, application/javascript","*":["*/"]+["*"]},defaults={type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",async:!0,jsonp:"callback"},head=document.getElementsByTagName("head")[0]||document.head;avalon.ajax=function(e,t){(!e||!e.url)&&avalon.error("参数必须为Object并且拥有url属性"),e=ajaxExtend(e);var n={responseHeadersString:"",responseHeaders:{},requestHeaders:{},querystring:e.querystring,readyState:0,uniqueID:setTimeout("1"),status:0},r,i,t=new Promise(function(e,t){i=e,r=t});t.options=e,t._reject=r,t._resolve=i,avalon.mix(t,n,XHRMethods),t.then(e.success,e.error),"success error".replace(avalon.rword,function(t){delete e[t]});var s=e.dataType,o=avalon.ajaxTransports;s==="json"&&e.type==="GET"&&e.crossDomain&&(s=e.dataType="jsonp");var u=e.form?"upload":s,a=o[u]||o.xhr;avalon.mix(t,a),t.preproccess&&(s=t.preproccess()||s),e.contentType&&t.setRequestHeader("Content-Type",e.contentType),t.setRequestHeader("Accept",accepts[s]?accepts[s]+", */*; q=0.01":accepts["*"]);for(var f in e.headers)t.setRequestHeader(f,e.headers[f]);return e.async&&e.timeout>0&&(t.timeoutID=setTimeout(function(){t.abort("timeout"),t.dispatch(0,"timeout")},e.timeout)),t.request(),t},"get,post".replace(avalon.rword,function(e){avalon[e]=function(t,n,r,i){return typeof n=="function"&&(i=i||r,r=n,n=void 0),avalon.ajax({type:e,url:t,data:n,success:r,dataType:i})}}),avalon.mix({ajaxTransports:{xhr:{request:function(){var e=this,t=this.options;avalon.log("XhrTransport.request.....");var n=this.transport=new avalon.xhr;t.crossDomain&&!("withCredentials"in n)&&avalon.error("本浏览器不支持crossdomain xhr"),n.open(t.type,t.url,t.async,t.username,t.password),this.mimeType&&n.overrideMimeType&&n.overrideMimeType(this.mimeType),this.requestHeaders["X-Requested-With"]="XMLHttpRequest";for(var r in this.requestHeaders)n.setRequestHeader(r,this.requestHeaders[r]+"");var i=this.options.dataType;"responseType"in n&&/^(blob|arraybuffer|text)$/.test(i)&&(n.responseType=i,this.useResponseType=!0),n.send(t.hasContent&&(this.formdata||this.querystring)||null),!t.async||n.readyState===4?this.respond():n.onerror===null?n.onload=n.onerror=function(t){this.readyState=4,this.status=t.type==="load"?200:500,e.respond()}:n.onreadystatechange=function(){e.respond()}},respond:function(e,t){var n=this.transport;if(!n)return;try{var r=n.readyState===4;if(t||r){n.onreadystatechange=avalon.noop,"onerror"in n&&(n.onerror=n.onload=null);if(t)!r&&typeof n.abort=="function"&&n.abort();else{var i=n.status,s=n.responseText;this.responseText=typeof s=="string"?s:void 0;try{var o=n.responseXML;this.responseXML=o.documentElement}catch(u){}this.useResponseType&&(this.response=n.response),this.responseHeadersString=n.getAllResponseHeaders();try{var a=n.statusText}catch(u){this.error=u,a="firefoxAccessError"}!i&&isLocal&&!this.options.crossDomain?i=this.responseText?200:404:i===1223&&(i=204),this.dispatch(i,a)}}}catch(f){t||this.dispatch(500,f)}}},jsonp:{preproccess:function(){var e=this.options,t=this.jsonpCallback=e.jsonpCallback||"jsonp"+setTimeout("1");return e.url=e.url+(rquery.test(e.url)?"&":"?")+e.jsonp+"=avalon."+t,avalon[t]=function(e){avalon[t]=e},"script"}},script:{request:function(){var e=this.options,t=this.transport=DOC.createElement("script");avalon.log("ScriptTransport.sending....."),e.charset&&(t.charset=e.charset);var n=t.onerror===null,r=this;t.onerror=t[n?"onload":"onreadystatechange"]=function(){r.respond()},t.src=e.url,head.insertBefore(t,head.firstChild)},respond:function(e,t){var n=this.transport;if(!n)return;var r=/loaded|complete|undefined/i.test(n.readyState);if(t||r){n.onerror=n.onload=n.onreadystatechange=null;var i=n.parentNode;i&&i.removeChild(n);if(!t){var s=typeof avalon[this.jsonpCallback]=="function"?[500,"error"]:[200,"success"];this.dispatch.apply(this,s)}}}},upload:{preproccess:function(){var e=this.options,t=new FormData(e.form);avalon.each(e.data,function(e,n){t.append(e,n)}),this.formdata=t}}},ajaxConverters:{text:function(e){return e||""},xml:function(e,t){return t!==void 0?t:parseXML(e)},html:function(e){return avalon.parseHTML(e)},json:function(e){return avalon.parseJSON||avalon.log("avalon.parseJSON不存在,请升级到最新版"),avalon.parseJSON(e)},script:function(e){parseJS(e)},jsonp:function(){var e=avalon[this.jsonpCallback];return delete avalon[this.jsonpCallback],e}},getScript:function(e,t){return avalon.get(e,null,t,"script")},getJSON:function(e,t,n){return avalon.get(e,t,n,"json")},upload:function(e,t,n,r,i){return typeof n=="function"&&(i=r,r=n,n=void 0),avalon.ajax({url:e,type:"post",dataType:i,form:t,data:n,success:r})},param:function(e,t){if(!avalon.isPlainObject(e))return"";t=typeof t=="boolean"?t:!0;var n=[],r,i;for(r in e)if(e.hasOwnProperty(r)){i=e[r],r=encode(r);if(isValidParamValue(i))n.push(r,"=",encode(i+""),"&");else if(Array.isArray(i)&&i.length)for(var s=0,o=i.length;s<o;s++)isValidParamValue(i[s])&&n.push(r,t?encode("[]"):"","=",encode(i[s]+""),"&")}return n.pop(),n.join("").replace(r20,"+")},unparam:function(e,t){var n={};if(!e||!avalon.type(e)==="string")return n;e=e.replace(/^[^?=]*\?/ig,"").split("#")[0];var r=e.split("&"),i,s,o,u=0,a=r.length;for(;u<a;++u){i=r[u].split("="),s=decode(i[0]);try{o=decode(i[1]||"")}catch(f){avalon.log(f+"decodeURIComponent error : "+i[1],3),o=i[1]||""}s=s.replace(/\[\]$/,"");var l=n[s];l===void 0?n[s]=o:Array.isArray(l)?l.push(o):n[s]=[l,o]}return t?n[t]:n},serialize:function(e){var t={};return Array.prototype.filter.call(e.getElementsByTagName("*"),function(e){if(rinput.test(e.nodeName)&&e.name&&!e.disabled)return rcheckbox.test(e.type)?e.checked:!0}).forEach(function(e){var n=avalon(e).val(),r;n=Array.isArray(n)?n:typeof n=="string"?[n]:[],n=n.map(function(e){return e.replace(rCRLF,"\r\n")}),r=t[e.name]||(t[e.name]=[]),r.push.apply(r,n)}),avalon.param(t,!1)}});var rinput=/select|input|button|textarea/i,rcheckbox=/radio|checkbox/,transports=avalon.ajaxTransports;avalon.mix(transports.jsonp,transports.script),avalon.mix(transports.upload,transports.xhr);var XHRMethods={setRequestHeader:function(e,t){return this.requestHeaders[e]=t,this},getAllResponseHeaders:function(){return this.readyState===4?this.responseHeadersString:null},getResponseHeader:function(e,t){if(this.readyState===4){while(t=rheaders.exec(this.responseHeadersString))this.responseHeaders[t[1]]=t[2];t=this.responseHeaders[e]}return t===undefined?null:t},overrideMimeType:function(e){return this.mimeType=e,this},abort:function(e){return e=e||"abort",this.transport&&this.respond(0,e),this},dispatch:function(e,t){var n=t;if(!this.transport)return;this.readyState=4;var r=e>=200&&e<300||e===304;if(r)if(e===204)n="nocontent";else if(e===304)n="notmodified";else if(typeof this.response=="undefined"){var i=this.options.dataType||this.options.mimeType;i||(i=this.getResponseHeader("Content-Type")||"",i=i.match(/json|xml|script|html/)||["text"],i=i[0]);try{this.response=avalon.ajaxConverters[i].call(this,this.responseText,this.responseXML)}catch(s){r=!1,this.error=s,n="parsererror"}}this.status=e,this.statusText=n+"",this.timeoutID&&(clearTimeout(this.timeoutID),delete this.timeoutID),this._transport=this.transport,r?this._resolve(this.response,n,this):this._reject(this,n,this.error||n);var o=this.options.complete;typeof o=="function"&&o.call(this,this,n),delete this.transport}};if(!window.FormData){var str='Function BinaryToArray(binary)\r\n                 Dim oDic\r\n                 Set oDic = CreateObject("scripting.dictionary")\r\n                 length = LenB(binary) - 1\r\n                 For i = 1 To length\r\n                     oDic.add i, AscB(MidB(binary, i, 1))\r\n                 Next\r\n                 BinaryToArray = oDic.Items\r\n              End Function';execScript(str,"VBScript"),avalon.fixAjax=function(){function e(e){var t=avalon.parseHTML("<iframe  id='"+e+"'"+" name='"+e+"'"+" style='position:absolute;left:-9999px;top:-9999px;'/>").firstChild;return(DOC.body||DOC.documentElement).insertBefore(t,null)}function t(e,t){var n=[],r,i,s,o,u;for(r in t){i=Array.isArray(t[r]),s=i?t[r]:[t[r]];for(o=0;o<s.length;o++)u=DOC.createElement("input"),u.type="hidden",u.name=r,u.value=s[o],e.appendChild(u),n.push(u)}return n}avalon.ajaxConverters.arraybuffer=function(){var e=this.tranport&&this.tranport.responseBody;if(e)return(new VBArray(BinaryToArray(e))).toArray()},avalon.ajaxTransports.upload={request:function(){var n=this,r=this.options,i="iframe-upload-"+this.uniqueID,s=r.form,o=this.transport=e(i),u={target:s.target||"",action:s.action||"",enctype:s.enctype,method:s.method},a=r.data?t(s,r.data):[];s.target=i,s.action=r.url,s.method="POST",s.enctype="multipart/form-data",avalon.log("iframe transport..."),this.uploadcallback=avalon.bind(o,"load",function(e){n.respond(e)}),s.submit();for(var f in u)s[f]=u[f];a.forEach(function(e){s.removeChild(e)})},respond:function(e){var t=this.transport,n;if(!t)return;if(e&&e.type==="load"){var r=t.contentWindow.document;this.responseXML=r,r.body&&(this.responseText=r.body.innerHTML,(n=r.body.firstChild)&&n.nodeName.toUpperCase()==="PRE"&&n.firstChild&&(this.responseText=n.firstChild.nodeValue)),this.dispatch(200,"success")}this.uploadcallback=avalon.unbind(t,"load",this.uploadcallback),delete this.uploadcallback,setTimeout(function(){t.parentNode.removeChild(t),avalon.log("iframe.parentNode.removeChild(iframe)")})}},delete avalon.fixAjax},avalon.fixAjax()}return avalon});