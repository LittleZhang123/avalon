define(["avalon","text!./avalon.tree.html","text!./avalon.tree.leaf.html","text!./avalon.tree.parent.html","text!./avalon.tree.nodes.html","../live/avalon.live","css!./avalon.tree.css","css!../chameleon/oniui-common.css"],function(e,t,n,r,i){function p(e){return document.getElementById(e)}function d(){return"tree"+h++}function v(t,n){return t.replace(/\{\{MS_[^\}]+\}\}/g,function(r){var i=r.substr(r.indexOf("_")+1).replace("}}","").toLowerCase(),s=f[i]||"";return e.isFunction(s)?s(t,n):s})}function m(t,n,r,i,s){var o=[];return e.each(t,function(t,u){r?u&&(u.$parentLeaf=n,u.level=n?n.level+1:0,i&&i(u)):o[t]=y(e.mix({},u),n,s),u&&u.children&&u.children.length&&(r?m(u.children,u,r,i,s):o[t].children=m(u.children,o[t],r,a,s))}),r?t:o}function g(t,n){e.each(n,function(e,n){if(e==="hasOwnProperty")return;t[e]=t[n]||""})}function y(e,t,n){if(!e)return;return e.level=t?t.level+1:0,e.isParent=b(e),g(e,n.data.key),e.$parentLeaf=t||"",e.isParent?e.open=!!e.open:e.open=!1,e.children=e.children||[],e}function b(e){return!!e.isParent||!!e.open||!!e.children&&!!e.children.length}function w(e,t){if(!e.length)return[];var n=t.data.simpleData,r=n.idKey,i=n.pIdKey,s,o=[],u=[],f,l;for(var c=0,h=e.length;c<h;c++){l=y(e[c],a,t);if(s&&s[r]===l[i]){s.isParent=!0,y(s,a,t);if(!f||f!==s)u.push(s),f=s;f.children.push(l)}else if(l.isParent||!f||f[r]!==l[i]){while(f&&l[i]!==f[r])u.pop(),f=u[u.length-1];(f&&f.children||o).push(l),l.isParent&&(u.push(l),f=l)}else(f&&f.children||o).push(l);l.level=u.length,l[i]=l[i]||0,s=l}return o}function E(e,t){for(var n=0,r=e.length;n<r;n++)if(t(e[n]))return n;return-1}function S(e){return e.replace(/^[a-z]{1}/g,function(e){return e.toUpperCase()})}function T(t){var n=t.srcElement;for(var r=0,i=l.length;r<i;r++)if(e.contains(l[r],n)&&n.type!="text"){t.preventDefault();return}}var s={view:1,callback:1,data:1},o=["click","dblClick","collapse","expand","select","contextmenu","mousedown","mouseup"],u=[],a=void 0,f={},l=[],c=[],h=0,x=e.ui.tree=function(o,f,h){var g=f.treeOptions,y={};g.template=g.getTemplate(t,g),g.parentTemplate=g.getTemplate(r,g,"parent"),g.leafTemplate=g.getTemplate(n,g,"leaf"),g.nodesTemplate=g.getTemplate(i,g,"nodes");var b={$guid:d()},T;e.mix(b,g),e.each(s,function(t){e.mix(!0,b[t],e.mix(!0,{},x.defaults[t],b[t]))}),T=g.children,b.data.simpleData.enable?b.children=w(b.children,b):b.children=m(b.children,a,a,a,b),b.template=v(b.template,b).replace(/\n/g,"").replace(/>[\s]+</g,"><"),b.parentTemplate=v(b.parentTemplate,b).replace(/\n/g,"").replace(/>[\s]+</g,"><"),b.leafTemplate=v(b.leafTemplate,b).replace(/\n/g,"").replace(/>[\s]+</g,"><"),b.nodesTemplate=v(b.nodesTemplate,b).replace(/\n/g,"").replace(/>[\s]+</g,"><");var N=e.define(f.treeId,function(t){e.each(u,function(e,n){n&&n(t,h)}),e.mix(t,b),t.widgetElement=o,t.widgetElement.innerHTML=t.template,t.$skipArray=["widgetElement","template","callback"],t._select=[];var n;t.$init=function(r){if(n)return;n=!0,m(t.children,a,"构建父子节点衔接关系",function(e){y[e.$id]=e},t),!t.view.txtSelectedEnable&&navigator.userAgent.match(/msie\s+[5-8]/gi)&&l.push(t.widgetElement),r?r():(e.log("avalon请尽快升到1.3.7+"),e.scan(o,[N].concat(h)),typeof g.onInit=="function"&&g.onInit.call(o,N,g,h))},t.$remove=function(){o.innerHTML=o.textContent="",y=null,t._select=null},t.computeIconClass=function(e){return(e.iconSkin?e.iconSkin+"_":"")+"ico_"+(e.isParent?t.hasClassOpen(e,"ignoreNoline")?"open":"close":"docu")},t.shallIconShow=function(e){return t.exprAnd(e,t.view.showIcon)?t.exprAnd.apply(null,arguments):!1},t.shallIconShowReverse=function(e){return t.exprAnd(e,t.view.showIcon)?!t.exprAnd.apply(null,arguments):!1},t.computeIcon=function(e){var n=e.isParent?t.hasClassOpen(e)?e.icon_open||"":e.icon_close||"":e.icon?e.icon:"";return n?'url("'+n+'") 0 0 no-repeat':""},t.computeLineClass=function(e,n,r){var i=e.open?"open":"close",s=n&&!e.level?"roots":r?"bottom":"center";return t.optionToBoolen(t.view.showLine,e)||(s="noline"),s+"_"+i},t.levelClass=function(e,t){var t=t||0;return"level"+((e.level||0)+t)},t.hasClassOpen=function(e,n){return t.optionToBoolen(t.view.showLine,e)?e.isParent&&e.open&&n!="noline":e.isParent&&e.open&&n},t.toggleOpenStatue=function(e,n){var n=n||e.leaf;if(!n)return;n.open?t.excute("collapse",e,n,"collapse"):t.excute("expand",e,n,"expand")},t.expand=function(n,r,i){var s=n&&n.leaf||n;if(!s)s=t;else{if(!s.isParent)return;s.open=!i}var o=s.children,u=p(s.$id);!i&&(!u||!u.scrollHeight)&&t.cVisitor(s,function(e){if(e==t)return;e.open=!0}),t.view.singlePath&&!i&&t.brotherVisitor(s,function(e,r){e!=s&&e.open&&t.excute("collapse",n.e,e,"collapse")}),r&&o&&e.each(o,function(e,n){t.expand(n,"all",i)})},t.expandAll=function(e){return e?t.expand(a,"all"):t.collapse(a,"all"),e},t.collapse=function(e,n,r){t.expand(e,n,"close",r)},t.hasChildren=function(e,n){var r=e.children&&e.children.length&&t.hasClassOpen(e,"ignoreNoline");return n?r:r||p("c"+e.$id)},t.loadLeafTemplate=function(e){return e.isParent?t.parentTemplate:t.leafTemplate},t.loadNodes=function(e){return e?t.nodesTemplate.replace(/leaf=\"children\"/g,'leaf="leaf.children"'):t.nodesTemplate},t.hideNode=function(e){e=e&&e.leaf||e,t.hideNodes([e])},t.hideNodes=function(t,n){n=n===a?!1:n,e.each(t,function(e,t){t.isHidden=n})},t.showNode=function(e){e=e&&e.leaf||e,t.showNodes([e])},t.showNodes=function(e){t.hideNodes(e,!0)},t.visitor=function(e,n,r,i,s){var e=e||t,i=i||[];if(e!=t){var o=n(e,s);o&&i.push(o);if(r&&r(i,e,e))return i}if(e.children&&e.children.length)for(var u=0,a=e.children,f=a.length;u<f;u++){if(r&&r(i,a[u],e))break;t.visitor(a[u],n,r,i,s)}return i},t.cVisitor=function(e,n,r,i,s){var i=i||[];if(e){var o=n(e,s);o&&i.push(o);if(r&&r(i,e,e))return i;e.$parentLeaf&&t.cVisitor(e.$parentLeaf,n,r,i,s)}return i},t.brotherVisitor=function(e,n,r,i,s){var i=i||[];if(e){var o,u=t.getBrothers(e);for(var a=0,f=u.length;a<f;a++){o=n&&n(u[a],s),o&&i.push(o);if(r&&r(i,u[a],e))break}}return i},t.getBrothers=function(e){return e?e.$parentLeaf?e.$parentLeaf.children:t.children:[]},t.getNodeByTId=function(e){return y[e]},t.getNodeIndex=function(e){var n=t.getBrothers(e);for(var r=0,i=n.length;r<i;r++)if(n[r]===e)return r;return-1},t.getNodes=function(e){return e?e.children:t.children},t.getNodesByFilter=function(e,n,r,i){return t.visitor(r,function(e,t){if(e===r)return;if(filter&&filter(e,t))return e},n?function(e,t){return e.length>0}:!1,[],i)},t.getNodeByParam=function(e,n,r){return t.getNodesByParam(e,n,r,function(e,t){return e.length>0})},t.getNodesByParam=function(e,n,r,i){return t.visitor(r,function(t){if(t===r)return;return t[e]===n?t:!1},i,[])},t.getNodesByParamFuzzy=function(e,n,r){return t.visitor(r,function(t){if(t===r)return;return(t[e]+"").match(new RegExp(n,"g"))?t:!1},!1,[])},t.getPreNode=function(e,n){var r=t.getBrothers(e),i=t.getNodeIndex(e);return i>-1?r[n?i+1:i-1]:!1},t.getNextNode=function(e){return t.getPreNode(e,"next")},t.getParentNode=function(e){return e&&e.$parentLeaf},t.addNodes=function(n,r,i){return t.excute("nodeCreated",{isSilent:i},n,function(){t.data.simpleData.enable&&r instanceof Array?r=t.transformTozTreeNodes(r):r=[r],r=m(r,n,a,a,t),m(r,n,"构建父子节点衔接关系",a,t),n&&(n.isParent=!0),i||(n.open=!0);var s=t.getNodes(n),o=s.length;s.pushArray(r);var u=s.slice(o)||[];return e.each(u,function(e,t){y[t.$id]=t}),u})},t.transformTozTreeNodes=function(e){return e instanceof Array||(e=[e]),w(e,t)},t.transformToArray=function(n,r,i){var i=i||[],s=arguments[3],o=t.data.simpleData;s||(s={},e.each(e.ui.tree.leafIgnoreField,function(e,t){s[t]=!0}));if(n instanceof Array)e.each(n,function(e,n){t.transformToArray(n,r,i,s)});else if(n){var u={},a=n.$model;for(var f in a){if(f.indexOf("$")===0||s[f]||f==="children"||a[f]=="")continue;var l=o[f+"Key"]?o[f+"Key"]:f;u[l]=a[f]}i.push(r?r(u):u),n.isParent&&t.transformToArray(n.children,r,i,s)}return i},t.reset=function(e){t.children.clear(),t.addNodes(a,T||e)},t.copyNode=function(n,r,i,s){var o=e.mix({},r.$model);return t.moveNode(n,o,i,s),o},t.moveNode=function(e,n,r,i){var s=n.$parentLeaf||t,o=E(s.children,function(e){return e==n||e==n.$model}),u=n.level;if(o<0)return;e||(e=t),e==t&&(r="inner"),s.children.splice(o,1);if(r=="inner")!e.isParent&&e!=t&&(e.isParent=!0),n.$parentLeaf=e==t?!1:e,n.level=n.$parentLeaf?n.$parentLeaf.level+1:0,e.children.push(n);else{r=r==="prev"?"prev":"next";var a=e.$parentLeaf,f=a?a.children:t.children,l=E(f,function(t){return t==e||t==e.$model});n.$parentLeaf=a,n.level=e.level,f.splice(l,0,n)}return n.$parentLeaf&&t.expand(n.$parentLeaf),u!=n.level&&t.visitor(n,function(e){e!=n&&(e.level=e.$parentLeaf.level+1)}),!i&&node.$parentLeaf&&(node.$parentLeaf.open=!0),node},t.removeCacheById=function(e){delete y[e]},t.hasClassSelect=function(e){for(var n=0,r=t._select.length;n<r;n++)if(t._select[n].$id===e.$id)return n+1;return 0},t._getSelectIDs=function(n){var r=0,i={};return n&&t.visitor(n,function(t){e(p(t.$id).getElementsByTagName("a")[0]).hasClass("curSelectedNode")&&(i[t.$id]=1,r++)},!1),{total:r,dict:i}},t.selectFun=function(e,n){var r=e.leaf,e=e.e;r.url||e.preventDefault&&e.preventDefault();if(n){var i=t._select,s=t._getSelectIDs(r),o=count=s.total,u=s.dict;o>1&&i.$unwatch();for(var a=0;a<i.length;a++){var f=i[a];u[f.$id]&&(i.splice(a,1),a--,count--,count==1&&o>1&&i.$watch())}res=u=null}else{var l=r.$id,c=t.hasClassSelect(r);c?t._select.splice(c-1,1):t.ctrlCMD(e,r)?t._select.push(r):t._select=[r]}},t.selectNode=function(e,n){t.view.selectedMulti===!1&&(n=!1),n?t._select.push(e):t._select=[e]},t.getSelectedNodes=function(e){if(!e)return t._select;var n=t._getSelectIDs(e),r=n.dict,i=[],s=t._select;for(var o=0,u=s.length;o<u;o++){var a=s[o].$id;r[a]&&i.push(s[o])}return i},t.cancelSelectedNode=function(e){t._select.remove(e)},t.cancelSelectedChildren=function(e){leaf?t.selectFun(e,"all"):t._select.clear()},t.ctrlCMD=function(e,n){return e.ctrlKey&&t.optionToBoolen(t.view.selectedMulti,n,e)},t.optionToBoolen=function(){var n=arguments[0];return e.isFunction(n)?n.apply(t,[].slice.call(arguments,1)):n},t.liveContextmenu=function(e){t.$fire("e:contextmenu",{e:e,vmodel:t,vmodels:h})},t.liveClick=function(e){t.$fire("e:click",{e:e,vmodel:t,vmodels:h})},t.excute=function(n,r,i,s){var o=n,u=S(n),f=t.callback["before"+u],l=t.callback["on"+u],c,p={e:r,leaf:i,vm:t,vmodels:h,preventDefault:function(){this.cancel=!0}},d=r?r.srcElement||r.target:null,v=!r||!r.cancelCallback;if(n==="dblclick"&&!t.view.dblClickExpand)return;N.$fire("e:before"+u,p);if(v)if(p.cancel||f&&f.call(d,p)===!1||p.cancel){p.preventDefault();return}s&&(e.isFunction(s)||(s=t[s]),e.isFunction(s)&&(c=s.call(d,p))),c!==a&&(p.res=c);if(p.cancel)return;return N.$fire("e:"+n,p),v&&l&&l.call(d,p),c},t.exprAnd=function(){var e=arguments.length,n=1,r=n,i=arguments[0];while(n<e)r=r&&t.optionToBoolen(arguments[n],i),n++;return r},t.timeStamp=function(){return Date.now()},t.toggleStatus=function(){return t.toggle=!t.toggle,t.toggle}});return N.$watch("e:nodeCreated",function(e){if(e&&e.e&&e.e.isSilent)return;var t=e.leaf;t&&(t.isParent=!0,N.expand(t))}),e.each(c,function(t,n){e.isFunction(n)&&n(N,h)}),N};e.bind(document.body,"selectstart",T),e.bind(document.body,"drag",T),x.defaults={toggle:!0,view:{showLine:!0,dblClickExpand:!0,selectedMulti:!0,txtSelectedEnable:!1,autoCancelSelected:!1,singlePath:!1,showIcon:!0,showTitle:!0,showSwitch:!0,nameShower:function(e){return e.name}},data:{simpleData:{idKey:"id",pIdKey:"pId",enable:!1},key:{children:"children",name:"name",title:"",url:"url"}},callback:{},onInit:e.noop,getTemplate:function(e,t,n){return e},$author:"skipper@123"},e.each(o,function(t,n){n=="contextmenu"&&(n="RightClick"),x.defaults.callback["on"+S(n)]=e.noop,x.defaults.callback["before"+S(n)]=!1}),e.ui.tree.AddExtention=function(t,n,r,i,a,l){t&&e.each(t,function(e,t){s[t]=t}),n&&e.mix(!0,x.defaults,n),r&&u.push(r),i&&(o=o.concat(i)),a&&e.mix(f,a),l&&c.push(l)},e.ui.tree.leafIgnoreField=["level"]});