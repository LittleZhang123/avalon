define(["avalon","text!./avalon.scrollspy.html","css!./avalon.scrollspy.css"],function(e,t){function n(e){return document.getElementById(e)}function i(t){if(t==document.body)return{top:t.scrollTop||document.documentElement.scrollTop,left:t.scrollLeft||document.documentElement.scrollLeft,height:e(window).height(),width:e(window).width()};var n=e(t).offset();return{top:t.scrollTop,left:t.scrollLeft,offsetTop:n.top,offsetLeft:n.left,height:e(t).height(),width:e(t).width()}}var r={onInit:e.noop,onChange:e.noop,onChangeNew:e.lop,axis:"y",targetListGetter:function(t){var t=n(t),r=t?t.getElementsByTagName("li"):!1,i=[];return e.each(r,function(e,t){var n=t.getElementsByTagName("a")[0],r=n.getAttribute("href"),s;(s=r.match(/^#[\S]+/g))&&i.push(s[0].substring(1))}),i},panelListGetter:e.noop,panelGetter:function(e,t,r,i){return r!=void 0&&r[t]||e!=void 0&&n(e)},spytarget:void 0,_lock:!1,scrollTo:e.noop,$author:"skipper@123"};e.bindingHandlers.scrollspy=function(t,n){function y(t,n,r){if(!r)return;var s=g.targetListGetter(g.spytarget,g),o=g.panelListGetter(g.spytarget,g),u=i(r[0]),a=u.height,f=u.width,c=[],h=[];if(!s||!s.length)s=o;for(var p=0,v=s.length;p<v;p++){var m=s[p],y=g.panelGetter(m,p,o,g);if(!y)return;var b=e(y),w=b.offset(),E=b.innerHeight(),S=b.innerWidth(),x=!1;d?g.axis=="x"?u.left<=w.left+S&&u.left+f>=w.left&&(x=p):u.top<=w.top+E&&u.top+a>=w.top&&(x=p):g.axis=="x"?u.left<=w.left+S&&u.left+f>=w.left&&(x=p):w.top<=u.offsetTop&&w.top+E>=u.offsetTop&&(x=p),x!==!1&&(c.push(x),h.push(s[p]))}c.length&&(p=c[0],g.onChange&&g.onChange(p,s[p],l,g)),g.onChangeNew&&g.onChangeNew(c,h,l,g)}var s=t.value.match(e.rword)||["$","scrollspy"],o=s[0].trim(),u=s[1],a,f,l=t.element,c=l.msData,h=e(l),p=c&&c["ms-widget"].match(/scrollbar[,]?/g),d=l===document.body;if(o&&o!="$"){a=e.vmodels[o];if(!a)return}t.element.removeAttribute("ms-scrollspy");if(!a){var v=p?1:0;a=n.length?n[v]:null}var m=a||{};a&&typeof a[u]=="object"&&(f=a[u],f.$model&&(f=f.$model),m=f);var g=e.mix({},r,f||{},t[u]||{},e.getWidgetData(l,"scrollspy")),b=l.scrollTop,w=l.scrollLeft,E=h,S;e.bind(d?window:l,"scroll",function(e){if(g._lock)return g._lock=!1;y(l.scrollLeft,l.scrollTop,h)}),p&&(S=e.vmodels[c["ms-widget-id"]||l.getAttribute("avalonctrl")],b=S.scrollTop,w=S.scrollLeft,E=S.getScroller(),S.$watch("scrollLeft",function(e,t){if(g._lock)return;y(e,void 0,E)}),S.$watch("scrollTop",function(e,t){if(g._lock)return;y(void 0,e,S.getScroller()||E)})),g.scrollTo=function(t,n){var r=g.panelListGetter(g.spytarget,g),i=g.panelGetter(t,n,r,g),s=e(i);!E&&p&&(E=S.getScroller());if(!i||!E)return;g._lock=!0;var o=E.offset(),u=s.offset(),a=g.axis=="x"?"Left":"Top";S?(a=="Left"?S.scrollTo(u[a.toLowerCase()]-o[a.toLowerCase()],void 0):S.scrollTo(void 0,S["scroll"+a]+u[a.toLowerCase()]-o[a.toLowerCase()]),g._lock=!1):l["scroll"+a]+=u[a.toLowerCase()]-o[a.toLowerCase()]},typeof g.onInit=="function"&&(y(b,w,E),g.onInit.call(l,a,g,n))}});