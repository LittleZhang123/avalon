define(["../avalon.getModel","text!./avalon.coupledatepicker.html","./avalon.datepicker","css!../chameleon/oniui-common.css","css!./avalon.coupledatepicker.css"],function(e,t){function r(e){return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e}var n=e.ui.coupledatepicker=function(i,s,o){function x(t){if(l){var n=l.length,r=e.getModel(l[0].trim(),o),i=n===1?null:e.getModel(l[1].trim(),o),s=r[1][r[0]],a=i?i[1][i[0]]:"";m=r,g=i,T(n,s,a),m&&(t=t.replace(/MS_OPTION_FROMDUPLEX/g,l[0].trim())),g&&(t=t.replace(/MS_OPTION_TODUPLEX/g,l[1].trim()))}return m||(u.inputFromValue="",t=t.replace(/MS_OPTION_FROMDUPLEX/g,"inputFromValue")),g||(u.inputToValue="",t=t.replace(/MS_OPTION_TODUPLEX/g,"inputToValue")),t}function T(e,t,n){e&&(e==2?(m?m[1][m[0]]=t&&a(t)&&t||"":E.inputFromValue=t&&a(t)&&t||"",g?g[1][g[0]]=n&&a(n)&&n||"":E.inputToValue=n&&a(n)&&n||""):e==1&&(m?m[1][m[0]]=t&&a(t)&&t||"":E.inputFromValue=t&&a(t)&&t||""))}function N(e){var t=p&&a(p),n=d&&a(d),i=g?g[1][g[0]]:E.inputToValue,s=E.rules,o,u,l,c={};if(!e)return;for(var h=0,m=["defaultDate","minDate","maxDate"];h<m.length;h++)v[h]&&(c[m[h]]=k(v[h],e));o=c.minDate,u=c.maxDate,t=(o?o.getTime():-1)>(t?t.getTime():-1)?o:t,n=(u?u.getTime():Number.MAX_VALUE)>(n?n.getTime():Number.MAX_VALUE)?n:u,!i&&c.defaultDate&&(i=f(c.defaultDate));if(t){var y=f(t);i||(i=y)}l=i&&a(i),l&&C(l,t,n)&&(i=y),g?g[1][g[0]]=i:E.inputToValue=i,t&&(s.toMinDate=r(t)),n&&(s.toMaxDate=r(n))}function C(e,t,n){var r=e.getTime();return t&&r<t.getTime()?!0:n&&r>n.getTime()?!0:!1}function k(e,t){var n,r,i=/([+-])?(\d+)([MDY])?/g,s,o;return e=(e||"").toString(),s=i.exec(e),o=s&&(s[1]||"+")+(s[3]||"D"),n=t?t:new Date,r=new Date(typeof n=="string"?a(n):n),o&&S[o]&&S[o](r,s[2]*1),r}var u=s.coupledatepickerOptions,a=typeof u.parseDate=="function"&&u.parseDate.bind(u)||n.defaults.parseDate.bind(u),f=typeof u.formatDate=="function"&&u.formatDate.bind(u)||n.defaults.formatDate.bind(u),l=u.duplex&&u.duplex.split(","),c=u.container,h=u.rules,p="",d="",v="",m,g,y,b;if(h&&e.type(h)==="string"){var w=e.getModel(h,o);h=w[1][w[0]]}h&&e.type(h)==="object"?(h=e.mix({},h.$model||h),h.toMinDate=h.toMinDate||"",h.toMaxDate=h.toMaxDate||"",h.fromMinDate=h.fromMinDate||"",h.fromMaxDate=h.fromMaxDate||""):h="",u.rules=h,p=h.toMinDate,d=h.toMaxDate,v=u.rules&&u.rules.rules||"",v=v.length>0?v.split(","):[],typeof c=="string"&&(c=c.split(","),c[0]=document.getElementById(c[0]),c[1]=document.getElementById(c[1])),c.length||(c=i.getElementsByTagName("div")),u.container=c=c.length?e.slice(c,0):c,u.template=x(u.getTemplate(t,u));var E=e.define(s.coupledatepickerId,function(t){e.mix(t,u),t.$skipArray=["widgetElement","container","calendarWrapper","template","changeMonthAndYear","startDay","fromLabel","toLabel","duplex"],t.widgetElement=i,t.fromSelectCal=function(e){E.rules&&E.rules.rules&&N(e)},t.getDates=function(){var e=m?m[1][m[0]]:E.inputFromValue,t=a(e),n=g?g[1][g[0]]:E.inputToValue,r=a(n);return t&&r&&[t,r]||null},t.$fromConfig={changeMonthAndYear:u.changeMonthAndYear,startDay:u.startDay,parseDate:a,formatDate:f,minDate:"rules.fromMinDate",maxDate:"rules.fromMaxDate",onSelect:t.fromSelectCal,calendarLabel:u.fromLabel,onInit:function(e){y=e,u.disabled&&(y.disabled=!0)}},t.$toConfig={changeMonthAndYear:u.changeMonthAndYear,startDay:u.startDay,parseDate:a,formatDate:f,minDate:"rules.toMinDate",maxDate:"rules.toMaxDate",calendarLabel:u.toLabel,onInit:function(e){b=e,u.disabled&&(b.disabled=!0)}},t.$init=function(t){var n=u.template.split("MS_OPTION_TEMPLATE"),r=n[0],s=n[1],f=null,l=null,h=null,p=null,d=null,v=null,y="",b="",w=[E];e(i).addClass("oni-coupledatepicker"),m&&(b=m[1][m[0]],w.push(m[1])),g&&w.push(g[1]),N(b&&a(b)),c.length?(y=s,l=e.parseHTML(s),h=l.firstChild,p=l.lastChild,d=c[0],v=c[1],d.appendChild(h),v.appendChild(p),e(d).addClass("oni-coupledatepicker-item"),e(v).addClass("oni-coupledatepicker-item")):(y=r,f=e.parseHTML(y),i.appendChild(f)),e.scan(i,w.concat(o)),typeof u.onInit=="function"&&u.onInit.call(i,E,u,o)},t.$remove=function(){i.innerHTML=i.textContent=""}});E.$watch("disabled",function(e){y.disabled=e,b.disabled=e});var S={"+M":function(e,t){var n=e.getDate();e.setMonth(e.getMonth()+t),e.getDate()!==n&&e.setDate(0)},"-M":function(e,t){var n=e.getDate();e.setMonth(e.getMonth()-t),e.getDate()!==n&&e.setDate(0)},"+D":function(e,t){e.setDate(e.getDate()+t)},"-D":function(e,t){e.setDate(e.getDate()-t)},"+Y":function(e,t){e.setFullYear(e.getFullYear()+t)},"-Y":function(e,t){e.setFullYear(e.getFullYear()-t)}};return E};return n.version=1,n.defaults={container:[],fromLabel:"选择起始日期",toLabel:"选择结束日期",changeMonthAndYear:!1,widgetElement:"",disabled:!1,startDay:1,separator:"-",rules:"",parseDate:function(t){if(e.type(t)==="date")return t;var n=this.separator,r="^(\\d{4})"+n+"(\\d{1,2})"+n+"(\\d{1,2})$";r=new RegExp(r);var i=t.match(r);return i?new Date(i[1],i[2]*1-1,i[3]):null},formatDate:function(t){if(e.type(t)!=="date")return e.log("the type of "+t+"must be Date"),"";var n=this.separator,r=t.getFullYear(),i=t.getMonth(),s=t.getDate();return r+n+this.formatNum(i+1,2)+n+this.formatNum(s,2)},formatNum:function(e,t){e=String(e);for(var n=0,r=t-e.length;n<r;n++)e="0"+e;return e},getTemplate:function(e,t){return e}},e});