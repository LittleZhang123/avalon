define(["../avalon.getModel","text!./avalon.daterangepicker.html","../button/avalon.button","./avalon.datepicker","css!../chameleon/oniui-common.css","css!./avalon.daterangepicker.css"],function(e,t){function i(e){return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e}var n=t,r=e.ui.daterangepicker=function(t,s,o){function L(){if(c){var t=c.length,n=e.getModel(c[0].trim(),o),r=t===1?null:e.getModel(c[1].trim(),o),i=n&&n[1][n[0]]||"",s=r?r[1][r[0]]:"";E=n,S=r,A(t,i,s,!0),E&&E[1].$watch(E[0],function(e){P()}),S&&S[1].$watch(S[0],function(e){P()})}E||(u.inputFromValue=""),S||(u.inputToValue="")}function A(t,n,r,i){var s="",o="",c=C?C:u;t&&(t==2?(e.type(n)==="date"?s=l(n):s=n&&f(n)&&n||"",e.type(r)==="date"?o=l(r):i?o=r?r:"":o=r&&f(r)&&r||"",E?E[1][E[0]]=s:c.inputFromValue=s,S?S[1][S[0]]=o:c.inputToValue=o,c.label=a(c.defaultLabel,s,o)):t==1&&(e.type(n)==="date"?s=l(n):s=n&&f(n)&&n||"",E?E[1][E[0]]=s:c.inputFromValue=s),o=o||(S?S[1][S[0]]:c.inputToValue),!s&&!o&&(c.label="不限日期"))}function O(e){var n=g&&f(g),r=y&&f(y),s=E?E[1][E[0]]:C.inputFromValue,o=S?S[1][S[0]]:C.inputToValue,c=C.rules,h={},p,d,v,m,b,w,x;if(!e){t.init?(D(),t.init=!1):(c.toMinDate=n||"",c.toMaxDate=r||"");return}for(var N=0,k=["defaultDate","minDate","maxDate"];N<k.length;N++)T[N]&&(h[k[N]]=_(T[N],e));p=h.minDate,d=h.maxDate,n=(p?p.getTime():-1)>(n?n.getTime():-1)?p:n,r=(d?d.getTime():Number.MAX_VALUE)>(r?r.getTime():Number.MAX_VALUE)?r:d,t.init&&(v=f(s),m=S&&S[1][S[0]]||"",b=f(m),v&&m&&!b&&(o=l(h.defaultDate))),n&&(w=l(n),!o&&!t.init&&(o=w)),x=o&&f(o),x&&M(x,n,r)&&(o=w),S?S[1][S[0]]=o:C.inputToValue=o,n&&(c.toMinDate=i(n)),r&&(c.toMaxDate=i(r)),t.init&&(D(),C.label=a(u.defaultLabel,s,o),t.init=!1)}function M(e,t,n){var r=e.getTime();return t&&r<t.getTime()?!0:n&&r>n.getTime()?!0:!1}function _(e,t){var n,r=/([+-])?(\d+)([MDY])?/g,i,s,o;return e=(e||"").toString(),i=r.exec(e),s=i&&(i[1]||"+")+(i[3]||"D"),n=t?t:new Date,o=new Date(typeof n=="string"?f(n):n),s&&k[s]&&k[s](o,i[2]*1),o}function D(){var e=E?E[1][E[0]]:C.inputFromValue,t=S?S[1][S[0]]:C.inputToValue;x=[f(e),f(t)],C.label&&P()}function P(){var e=E?E[1][E[0]]:C.inputFromValue,t=S?S[1][S[0]]:C.inputToValue,n=f(t),r=u.opts&&u.opts.msgFormat,i=null,s="",o=0;t&&!n&&(S?S[1][S[0]]="":C.inputToValue=""),t&&(e||d)?(i=f(e)||d,o=Math.floor((n.getTime()-i.getTime())/1e3/60/60/24+1),r&&typeof r=="function"?v&&m&&(s=r(v,m)):s="已选时间段："+e+" 至 "+t+" 共计"+o+"天"):s="",C.msg=s,d?d=null:0}var u=s.daterangepickerOptions,a=u.opts&&u.opts.datesDisplayFormat,f=typeof u.parseDate=="function"&&u.parseDate.bind(u)||r.defaults.parseDate.bind(u),l=typeof u.formatDate=="function"&&u.formatDate.bind(u)||r.defaults.formatDate.bind(u),c=u.duplex&&u.duplex.split(","),h=!1,p=u.rules,d=null,v=null,m=null,g="",y="",b,w,E,S,x,T;a&&typeof a=="function"&&(u.datesDisplayFormat=a),a=u.datesDisplayFormat;if(p&&e.type(p)==="string"){var N=e.getModel(p,o);p=N[1][N[0]]}p&&e.type(p)==="object"?(p=e.mix({},p.$model||p),p.toMinDate=p.toMinDate||"",p.toMaxDate=p.toMaxDate||"",p.fromMinDate=p.fromMinDate||"",p.fromMaxDate=p.fromMaxDate||""):p="",u.rules=p,g=p.toMinDate,y=p.toMaxDate,T=u.rules&&u.rules.rules||"",T=T.length>0?T.split(","):[],u.template=u.getTemplate(n,u),L();var C=e.define(s.daterangepickerId,function(n){e.mix(n,u),n.msg="",n.$skipArray=["widgetElement","container","inputElement","calendarWrapper","fromLabel","toLabel","duplex"],n.widgetElement=t,n.toggle=!1,n.container=null,n.inputElement=null,n.calendarWrapper=null,n._toggleDatepicker=function(e){C.disabled||(C.toggle=!e)},n._updateMsg=function(e){e.stopPropagation()},n._selectDate=function(){var n=b.value,r=w.value,i=f(n),s=f(r),o=a(u.defaultLabel,n,r),l=document.createElement("p"),c=e(l),p=0,d="";if(!s||!i)return d=!i&&!s?"请选择起始日期和结束日期":i?"请选择结束日期":"请选择起始日期",d="<span style='color:#f55'>"+d+"</span>",C.msg=d,!1;C.label=o,h=!0,x=[i,s],C.toggle=!1,c.css({position:"absolute",visibility:"hidden",height:0,"font-size":"12px"}),l.innerHTML=o,document.body.appendChild(l),p=c.width()+30,document.body.removeChild(l),p>C.dateRangeWidth&&(C.dateRangeWidth=p),u.onSelect.call(C,i,s,x,C,e(t).data())},n._cancelSelectDate=function(){d=!1,C.toggle?C.toggle=!1:0},n.getDates=function(){var e=E?E[1][E[0]]:C.inputFromValue,t=f(e),n=S?S[1][S[0]]:C.inputToValue,r=f(n);return t&&r&&[t,r]||null},n.setDates=function(n,r,i){var s=r===void 0?[n]:[n,r],o=s.length,a=e.type(n)==="date"?n:f(n),l=e.type(r)==="date"?r:f(r);o?(C.defaultLabel=i||C.defaultLabel,A(o,n,r)):C.label="",D(),u.onSelect.call(C,a,l,x,C,e(t).data()),x=[a,l]},n._fixDate=function(e,t,n,r){var i=new Date(e.getTime()),s=new Date(t.getTime());return n&&(i=new Date(Math.max(n.getTime(),i))),r&&(s=new Date(Math.min(r.getTime(),s))),[i,s]},n.quickOperation=function(e){var t=new Date,n=t,r=t,i="今天",s=C.rules.fromMinDate,o=C.rules.toMaxDate,u=[];s=s&&f(s)||null,o=s&&f(o)||null;switch(e){case"lastDay":n=r=new Date(t.setDate(t.getDate()-1)),i="昨天";break;case"lastSeventDays":n=new Date,n=new Date(n.setDate(n.getDate()-8)),r=new Date,r=new Date(r.setDate(r.getDate()-1)),i="过去七天",u=C._fixDate(n,r,s,o),n=u[0],r=u[1];break;case"currentMonth":i="本月",n=new Date,n=new Date(n.setDate(1)),u=C._fixDate(n,r,s,o),n=u[0],r=u[1];break;case"lastMonth":i="上个月",r=new Date,r=new Date(r.setDate(-1)),n=new Date((new Date(r.getTime())).setDate(1)),u=C._fixDate(n,r,s,o),n=u[0],r=u[1]}C.setDates(n,r,i),C.toggle=!1},n.setLabel=function(e){C.label=e},n.setDisabled=function(e){C.disabled=e},n.fromSelectCal=function(e){C.rules&&C.rules.rules&&O(e),d=e},n.$fromConfig={type:"range",allowBlank:!0,parseDate:f,formatDate:l,onSelect:n.fromSelectCal,minDate:"rules.fromMinDate",maxDate:"rules.fromMaxDate",startDay:u.startDay,calendarLabel:u.fromLabel,onInit:function(e){v=e}},n.$toConfig={type:"range",allowBlank:!0,parseDate:f,formatDate:l,minDate:"rules.toMinDate",maxDate:"rules.toMaxDate",startDay:u.startDay,calendarLabel:u.toLabel,onInit:function(e){m=e}},n.$init=function(){var n="",r,i,s,a;r=e.parseHTML(u.template).firstChild,a=r.getElementsByTagName("input"),s=r.children[0],i=r.children[1],b=a[0],w=a[1],C.container=s,C.inputElement=s,C.calendarWrapper=i,t.appendChild(r),e.bind(document,"click",function(e){var n=e.target;t.contains(n)||(C.toggle=!1)}),t.init=!0,E&&(n=E[1][E[0]]),O(n&&f(n)),e.scan(t,[C].concat(o)),e.nextTick(function(){var n=E?E[0].trim():"inputFromValue",r=S?S[0].trim():"inputToValue",i=E?[C,E[1]]:[C],s=S?[C,S[1]]:[C];b.setAttribute("ms-widget","datepicker, $, $fromConfig"),w.setAttribute("ms-widget","datepicker, $, $toConfig"),b.setAttribute("ms-duplex",n),w.setAttribute("ms-duplex",r),e.scan(b,i.concat(o)),e.scan(w,s.concat(o)),typeof u.onInit=="function"&&u.onInit.call(t,C,u,o)})},n.$remove=function(){t.innerHTML=t.textContent=""}});E||C.$watch("inputFromValue",function(e){P()}),S||C.$watch("inputToValue",function(e){P()});var k={"+M":function(e,t){var n=e.getDate();e.setMonth(e.getMonth()+t),e.getDate()!==n&&e.setDate(0)},"-M":function(e,t){var n=e.getDate();e.setMonth(e.getMonth()-t),e.getDate()!==n&&e.setDate(0)},"+D":function(e,t){e.setDate(e.getDate()+t)},"-D":function(e,t){e.setDate(e.getDate()-t)},"+Y":function(e,t){e.setFullYear(e.getFullYear()+t)},"-Y":function(e,t){e.setFullYear(e.getFullYear()-t)}};return C.$watch("toggle",function(t){var n=l(x&&x[0]||""),r=l(x&&x[1]||"");!t&&!h?(E&&E[1][E[0]]!=n?(E[1][E[0]]=n,O()):!E&&C.inputFromValue!=n&&(C.inputFromValue=n,O()),S&&S[1][S[0]]!=r?S[1][S[0]]=r:!S&&C.inputToValue!=r&&(C.inputToValue=r)):h&&(h=!1),v.toggle=t,m.toggle=t,t?e.type(C.onOpen)==="function"&&C.onOpen(C):e.type(C.onClose)==="function"&&C.onClose(C)}),C};return r.version=1,r.defaults={fromLabel:"选择起始日期",toLabel:"选择结束日期",rules:"",label:"",defaultLabel:"日期范围",disabled:!1,widgetElement:"",separator:"-",startDay:1,dateRangeWidth:260,shortcut:!1,onOpen:e.noop,onClose:e.noop,onSelect:e.noop,parseDate:function(t){if(e.type(t)==="date")return t;var n=this.separator,r="^(\\d{4})"+n+"(\\d{1,2})"+n+"(\\d{1,2})$";r=new RegExp(r);var i=t.match(r);return i?new Date(i[1],i[2]*1-1,i[3]):null},formatDate:function(t){if(e.type(t)!=="date")return e.log("the type of "+t+"must be Date"),"";var n=this.separator,r=t.getFullYear(),i=t.getMonth(),s=t.getDate();return r+n+this.formatNum(i+1,2)+n+this.formatNum(s,2)},formatNum:function(e,t){e=String(e);for(var n=0,r=t-e.length;n<r;n++)e="0"+e;return e},datesDisplayFormat:function(e,t,n){return!t&&!n?"不限日期":e+"："+t+" 至 "+n},getTemplate:function(e,t){return e}},e});