define(["../avalon.getModel","./avalon.datepicker.lang","text!./avalon.datepicker.html","../dropdown/avalon.dropdown.js","../slider/avalon.slider.js","css!./avalon.datepicker.css"],function(e,t,n){function f(e){return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e}function l(e){var t={},n=[];for(var r in e){var i=e[r],s=this.parseDate(r);s&&(i.date=s,n.push(i))}n.sort(function(e,t){return(e.dayIndex||0)-(t.dayIndex||0)});for(var r=0,o=n.length;r<o;r++){var i=n[r],s=i.date,u=i.beforeTime||0,a=i.afterTime||0;s.setDate(s.getDate()-u-1);for(var f=-i.beforeTime;f<a+1;f++)s.setDate(s.getDate()+1),t[s.getTime()]={text:i.holidayName+(f<0?"前"+ -f+"天":f>0?"后"+f+"天":""),cellClass:f===0&&i.holidayClass||"",cellText:f===0&&i.holidayText||""}}return t}function c(e){if(!e)return;var t=f(new Date).getTime(),n=e.getTime(),r=["日","一","二","三","四","五","六"];if(t==n)return{text:"今天",cellClass:"c_today",cellText:"今天"};if(t==n-s)return{text:"明天",cellClass:""};if(t==n-s*2)return{text:"后天",cellClass:""};var o=i&&i[e.getTime()];return o?o:{text:"周"+r[e.getDay()]}}var r=n,i,s=864e5,o=1901,u=2050,a=e.ui.datepicker=function(n,s,a){function M(){var e=n.value,t=v(e),r=f(new Date),i=t,s=!1;e&&!t&&(h.tip="格式错误",h.dateError="#ff8888",i=r),h.allowBlank?e?t&&(s=D(t,h)):(h.tip="",i=r):e?t&&(s=D(t,h)):(e=m(r),h.tip=c(r).text,i=r,s=D(r,h)),s&&(i=h.minDate||h.maxDate,e=m(i)),L=i.getFullYear(),C=i.getMonth(),k=i.getDate(),E=e}function _(e){var t=O._years,n=(e+"").substr(0,3),r=[];if(!~t.indexOf(e)){for(var i=0;i<=9;i++)r.push(Number(n+i));O._years=r}}function D(e,t){var n=e.getTime(),r=t.minDate,i=t.maxDate;return r&&n<r.getTime()?!0:i&&n>i.getTime()?!0:!1}function P(t,r){e.bind(n,"focus",function(e){O.toggle=!0}),e.bind(document,"click",function(e){var n=e.target;if(h.type==="range")return;if(!t.contains(n)&&!r.contains(n)&&O.toggle&&!O.timer){O.toggle=!1;return}if(!O.toggle&&!O.disabled&&r.contains(n)){O.toggle=!0;return}}),e.bind(n,"keydown",function(e){var t=e.keyCode,n,r;r=e.key;if(r)switch(r){case"-":n="-";break;case"/":n="/"}else switch(t){case 189:n="-";break;case 191:n="/"}O.toggle||(O.toggle=!0);if((t<48||t>57)&&t!==13&&t!==8&&h.separator!==n&&t!==27&&t!==9&&t!==37&&t!==39&&t!==46)return e.preventDefault(),!1}),e.bind(n,"keyup",function(e){var t=n.value,r=O.year,i=O.month,s=e.keyCode,o,u,a;if(s===37||s===39)return!1;if(s===13||s==27||s==9)return O.toggle=!1,!1;if(a=v(t))o=a.getMonth(),u=a.getFullYear(),O.dateError="#cccccc",O.tip=c(f(a)).text,O.day=a.getDate(),i!=o&&r!=u?(b=!0,O.year=u,O.month=o):i!=o?O.month=o:O.year=u;else{if(O.allowBlank&&t==""){O.tip="",O.dateError="#cccccc";return}O.tip="格式错误",O.dateError="#ff8888"}})}function H(e){var t=O.month,n=O.year,r=O.stepMonths,i=O.numberOfMonths,s,o=0,u=0;e==="next"?t=t+r+i-1:t=t-r-i+1,s=new Date(n,t,1),o=s.getMonth(),u=s.getFullYear(),u!=O.year?(b=!0,O.year=u,O.month=o):O.month=o}function B(){var e=[],t=h.startDay;for(var n=0,r=h.dayNames;n<7;n++){var i=(n+t)%7;e.push(r[i])}return e}function j(e,t,n,r,i,s,o,u){var a=!1,f=c(e),l=f&&f.cellText||u,h=e.getDay(),p=h%7==0||h%7==6,d=D(e,t);n&&n.getDate()===+u&&r===n.getMonth()&&i===n.getFullYear()&&(a=!0),s.push({day:u+"",_day:l+"",month:r,year:i,weekend:p,selected:a,dateDisabled:d}),o.push(l+"")}function F(e,t){var r=O.startDay,i=new Date(t,e,1),s=new Date(t,e,1-(i.getDay()-r+7)%7),o=O.showOtherMonths,u=v(n.value),a=O.minDate,f=O.maxDate,l=a?(t-a.getFullYear())*12+e-a.getMonth()>0:!0,c=f?(f.getFullYear()-t)*12+f.getMonth()-e>0:!0,h=[],p=[],d=[],m=[],g=[],y=[],b,E,S;O.prevMonth=l,O.nextMonth=c;for(var x=0,T=O.numberOfMonths;x<T;x++){for(var N=0;N<6;N++){g=[],y=[];for(var C=0;C<7;C++)E=s.getMonth(),b=s.getFullYear(),S=s.getDate(),b===t&&E===e?j(s,O,u,E,b,g,y,S):o&&N===0&&(b<t||E<e)?j(s,O,u,E,b,g,y,S):(y.push(""),g.push({day:"",month:!1,weekend:!1,selected:!1,dateDisabled:!0})),s=new Date(s.setDate(S+1));h.push(g),p.push(y)}d.push({year:t,month:e,rows:h}),m.push({year:t,month:e,rows:p}),e+=1,i=new Date(t,e,1),t=i.getFullYear(),e=i.getMonth(),s=new Date(t,e,1-(i.getDay()-r+7)%7),h=[],p=[]}w=d,O.data=m}function I(t,n,r,i,s,o,u,a,f,l){var h=!1,p=r&&r.getMonth(),d=r&&r.getFullYear(),v=c(t),m=v&&v.cellText||o,g=t.getDay(),y=g%7==0||g%7==6,b=D(t,n),E=w[a].rows[f][l],S=n.data[a].rows[f];o===+u&&i===p&&s===d&&(h=!0),E._day!=m||E.selected==h&&E.dateDisabled==b?E._day==m?e.mix(E,{month:i,year:s}):(e.mix(E,{day:o+"",_day:m+"",month:i,year:s,weekend:y,selected:h,dateDisabled:b}),S.set(l,m)):(e.mix(E,{month:i,year:s,selected:h,dateDisabled:b}),S.set(l,"").set(l,m))}function q(t,r,i){var s=O.startDay,o=new Date(r,t,1),u=new Date(r,t,1-(o.getDay()-s+7)%7),a=O.showOtherMonths,f=v(n.value),l=O.minDate,c=O.maxDate,h=l?(r-l.getFullYear())*12+t-l.getMonth()>0:!0,p=c?(c.getFullYear()-r)*12+c.getMonth()-t>0:!0,d,m,g;O.prevMonth=h,O.nextMonth=p;for(var y=0,b=O.numberOfMonths;y<b;y++){O.data[y].year=r,O.data[y].month=t,w[y].year=r,w[y].month=t;for(var E=0;E<6;E++)for(var S=0;S<7;S++)m=u.getMonth(),d=u.getFullYear(),g=u.getDate(),d===r&&m===t?I(u,O,f,m,d,g,i,y,E,S):a&&E===0&&(d<r||m<t)?I(u,O,f,m,d,g,i,y,E,S):(O.data[y].rows[E].set(S,""),e.mix(w[y].rows[E][S],{day:"",_day:"",month:!1,weekend:!1,selected:!1,dateDisabled:!0})),u=new Date(u.setDate(g+1));t+=1,o=new Date(r,t,1),r=o.getFullYear(),t=o.getMonth(),u=new Date(r,t,1-(o.getDay()-s+7)%7)}}function R(e){return typeof e=="string"?v(e):e}var h=s.datepickerOptions,p=n.msData["ms-duplex"],d=p&&e.getModel(p,a),v=h.parseDate,m=h.formatDate,g=h.minDate,y=h.maxDate,b=!1,w=[],E="",S=[],x,T,N,C,k,L;r=h.template=h.getTemplate(r,h),i=l.call(h,t)||{},e.scan(n,a),h.disabled=n.disabled||h.disabled,m=m.bind(h),v=v.bind(h),g=g!==null&&R(g),y=y!==null&&R(y),h.minDate&&!g&&(x=e.getModel(h.minDate,a),x&&(g=R(x[1][x[0]]))),g=h.minDate=g&&f(g),h.maxDate&&!y&&(T=e.getModel(h.maxDate,a),T&&(y=R(T[1][T[0]]))),y=h.maxDate=y&&f(y),g?o=g.getFullYear():0,y?u=y.getFullYear():0;if(e.type(h.years)==="array")S=h.years;else for(var A=o;A<=u;A++)S.push(A);h.mobileMonthAndYear&&(h.mobileYear=0),h.changeMonthAndYear&&(h.mobileMonthAndYear=!1),M();var O=e.define(s.datepickerId,function(t){e.mix(t,h),t.$skipArray=["container","showDatepickerAlways","timer","sliderMinuteOpts","sliderHourOpts","template","widgetElement","dayNames","allowBlank","months","years","numberOfMonths","showOtherMonths","watermark","weekNames","stepMonths","changeMonthAndYear","startDay","mobileMonthAndYear"],t.dateError=t.dateError||"",t.weekNames=[],t.tip=t.tip||"",t.widgetElement=n,t.data=[],t.prevMonth=-1,t.nextMonth=-1,t.month=C,t._month=C+1,t.year=L,t.day=k,t.years=S,t.months=[1,2,3,4,5,6,7,8,9,10,11,12],t._position="absolute",t.minute=0,t.hour=0,t._datepickerToggle=!0,t._monthToggle=!1,t._yearToggle=!1,t._years=[2010,2011,2012,2013,2014,2015,2016,2017,2018,2019],t.elementYear=L,t.elementMonth=C,t._setWeekClass=function(e){var t=O.dayNames;return t.indexOf(e)%7==0||t.indexOf(e)%7==6?"oni-datepicker-week-end":""},t._setDayClass=function(e,t,n,r){var i="",s={};return r===""?"":(s=w[n].rows[t][e],s.weekend&&(i+=" oni-datepicker-week-end"),s.month||(i+=" oni-datepicker-day-none"),s.selected&&(i+=" oni-datepicker-selected"),s.dateDisabled&&(i+=" oni-state-disabled"),i.trim())},t._setHoverClass=function(e,t,n,r){var i="",s={};return r===""?"":(s=w[n].rows[t][e],s.month&&(i="oni-datepicker-day-hover"),i)},t._setMobileYearClass=function(e,t,n,r){var i="";return e===t&&n===r&&(i+=" oni-datepicker-selected"),O.mobileYearDisabled(e)&&(i+=" oni-state-disabled"),i},t.sliderMinuteOpts={onInit:function(e,t,n){e.$watch("value",function(e){O.minute=e}),O.$watch("minute",function(t){e.value=t})}},t.sliderHourOpts={onInit:function(e,t,n){e.$watch("value",function(e){O.hour=e}),O.$watch("hour",function(t){e.value=t})}},t.$yearOpts={width:60,listWidth:60,height:160,position:!1,listClass:"oni-datepicker-dropdown",onSelect:function(e){e.stopPropagation()}},t.$monthOpts={width:45,height:160,listWidth:45,position:!1,listClass:"oni-datepicker-dropdown",onSelect:function(e){e.stopPropagation()}},t._selectDates=function(e){O.mobileMonthAndYear&&(O._monthToggle=!1,O._yearToggle=!1,O._datepickerToggle=!0,b=!0,O.year=O.mobileYear,O.month=e)},t._selectMonths=function(e,t){if(O.mobileMonthAndYear){if(t){if(!!O.mobileYearDisabled(t))return;O.mobileYear=t}else O.mobileYear=O.year;O._monthToggle=!0,O._yearToggle=!1,O._datepickerToggle=!1}},t._selectYears=function(){O.mobileMonthAndYear&&(O._monthToggle=!1,O._yearToggle=!0,O._datepickerToggle=!1)},t._getNow=function(){var e=new Date,t=e.toTimeString(),n=t.substr(0,t.lastIndexOf(":"));return O.hour=e.getHours(),O.minute=e.getMinutes(),n},t._dateCellRender=function(e,t,n,r){if(O.dateCellRender){var i=w[n].rows[e][t];return r===""?r:O.dateCellRender(r,O,i)}return r},t._selectTime=function(t){var r=e.filters.timer,i=r(O.hour),s=r(O.minute),o=i+":"+s,u=m(v(n.value));t.stopPropagation(),n.value=u+" "+o,O.showDatepickerAlways||(O.toggle=!1),h.onSelectTime&&e.type(h.onSelectTime)==="function"&&h.onSelectTime.call(O,O)},t._selectYearMonth=function(e){e.stopPropagation()},t._prev=function(e,t){if(!e)return!1;H("prev"),t.stopPropagation()},t._next=function(e,t){if(!e)return!1;H("next"),t.stopPropagation()},t._prevYear=function(e){if(e===O.years[0])return;O.mobileYear=O.mobileYear-1},t._nextYear=function(e){if(e===O.years[O.years.length-1])return;O.mobileYear=O.mobileYear+1},t._prevYears=function(){if(O._years[0]<=O.years[0])return;_(O._years[0]-1)},t._nextYears=function(){var e=O._years,t=O.years;if(e[e.length-1]>=t[t.length-1])return;_(e[9]+1)},t.mobileYearDisabled=function(e){var t=O.years;return e<t[0]||e>t[t.length-1]?!0:!1},t.getRawValue=function(){return n.value},t.getDate=function(){var e=O.getRawValue();return v(e)},t._afterYearRendered=function(){this.setAttribute("ms-widget","dropdown,$,$yearOpts"),this.setAttribute("ms-duplex","year"),e.scan(this,O)},t._afterMonthRendered=function(){this.setAttribute("ms-widget","dropdown,$,$monthOpts"),this.setAttribute("ms-duplex","_month"),e.scan(this,O)},t._selectDate=function(t,r,i,s){var o=e.filters.timer,u=O.month,a=O.year,l=w[i].rows[r][t],p=l.year,v=l.month,g=+l.day,y=l.dateDisabled;s.stopPropagation(),s.preventDefault();if(v!==!1&&!y&&!O.showDatepickerAlways){var E=new Date(p,v,g),S=m(E),x=h.type==="range"?n["data-calenderwrapper"]:null;O.tip=c(f(new Date(p,v,g))).text,O.dateError="#cccccc",v===u&&p===a&&O.day==g?O.$fire("day",g):O.day=g,v!==u&&p!==a?(b=!0,O.year=p,O.month=v):v!==u?O.month=v:p!==a&&(O.year=p),!x&&!O.timer?(n.value=S,O.toggle=!1):(O.timer&&(S=S+" "+o(O.hour)+":"+o(O.minute)),n.value=S)}if(!O.showDatepickerAlways&&!d){if(typeof O.onSelect=="string"){e.log("onSelect 回调必须是个function！");return}O.onSelect.call(null,S,O,e(n).data())}},t.$init=function(t){var i=n.parentNode;N=e.parseHTML(r).firstChild,i.insertBefore(N,n),i.insertBefore(n,N),e(n).attr("ms-css-width","width"),O.weekNames=B();if(n.tagName==="INPUT"&&O.type!=="range"){var s=document.createElement("div");s.className="oni-datepicker-input-wrapper",s.setAttribute("ms-class","oni-datepicker-active:toggle"),s.setAttribute("ms-css-border-color","dateError"),s.setAttribute("ms-hover","oni-state-hover"),i.insertBefore(s,n),s.appendChild(n);if(O.showTip){var o=e.parseHTML("<div class='oni-datepicker-tip'>{{tip}}<i class='oni-icon oni-icon-calendar-o'>&#xf133;</i></div>");s.appendChild(o)}else n.style.paddingRight="0px";s.appendChild(N)}O.timer&&(O.width=100,E&&R(E)&&(E=E+" "+O._getNow())),n.value=E,n.disabled=O.disabled,O.showDatepickerAlways?(n.style.display="none",O.toggle=!0,O._position="relative",s.style.borderWidth=0):P(N,s),h.type==="range"?(s=n["data-calenderwrapper"],O._position="static"):e.scan(s,[O]),e.scan(N,[O].concat(a)),setTimeout(function(){F(O.month,O.year)},10),typeof h.onInit=="function"&&h.onInit.call(n,O,h,a)},t.$remove=function(){var e=n.parentNode,t=e.parentNode,r=N.parentNode;N.innerHTML=N.textContent="",r.removeChild(N),t.removeChild(e)}});return c=c.bind(O),O.$watch("toggle",function(e){var t=n.value,r=v(t),i=r&&r.getFullYear(),s=r&&r.getMonth();if(e)O.elementMonth=s||-1,O.elementYear=i||-1;else{if(O.year!=i&&O.month!=s)if(!r){b=!0;var o=new Date,u=o.getFullYear(),a=o.getMonth();O.year==u&&O.month==a?q(O.month,O.year,O.day):O.year==u?O.month=a:O.month==a?O.year=u:(b=!0,O.year=u,O.month=a)}else b=!0,O.year=i,O.month=s;else O.year!=i?O.year=i:O.month!=s&&(O.month=s);O.onClose(new Date(O.year,O.month,O.day),O)}}),O.$watch("year",function(e){O.mobileMonthAndYear&&_(e),b?b=!1:q(O.month,e,O.day),O.onChangeMonthYear(e,O.month+1,O)}),O.changeMonthAndYear&&O.$watch("_month",function(e){O.month=e-1}),O.$watch("month",function(e){O._month=e+1,q(e,O.year,O.day),O.onChangeMonthYear(O.year,e,O)}),O.$watch("day",function(e,t){var n=w,r=O.month,i=O.year,s=!1,o,u,a;for(var f=0,l=n.length;f<l;f++){var c=n[f];if(c.year==i&&c.month==r){var h=c.rows;for(var p=0,d=h.length;p<d;p++){var v=h[p];for(var m=0,g=v.length;m<g;m++){var y=v[m],b=y.day;b==e?(y.selected=!0,O.data[f].rows[p].set(m,"").set(m,y._day)):y.selected&&(y.selected=!1,O.data[f].rows[p].set(m,"").set(m,y._day))}}}else for(var p=0,d=h.length;p<d;p++){var v=h[p];for(var m=0,g=v.length;m<g;m++){var E=v[m];if(y.selected){y.selected=!1,O.data[f].rows[p].set(m,"").set(m,y._day),s=!0;break}}if(s)break}if(s)break}}),O.$watch("disabled",function(e){n.disabled=e}),O.$watch("minDate",function(e){var t=R(e);t?O.minDate=f(t):O.minDate="",q(O.month,O.year,O.day)}),O.$watch("maxDate",function(e){var t=R(e);t?O.maxDate=f(t):O.maxDate="",q(O.month,O.year,O.day)}),d&&d[1].$watch(d[0],function(t){var r,i,s;if(s=v(t)){r=s.getFullYear(),i=s.getMonth(),O.day=s.getDate(),i!==O.month&&r!==O.year?(b=!0,O.year=r,O.month=i):r!==O.year?O.year=r:i!==O.month&&(O.month=i),O.dateError="#cccccc",O.tip=c(f(s)).text;if(typeof O.onSelect=="string"){e.log("onSelect 回调必须是个function！");return}O.onSelect.call(null,s,O,e(n).data())}else O.allowBlank?O.tip="":(O.tip="格式错误",O.dateError="#ff8888")}),x&&x[1].$watch(x[0],function(e){O.minDate=e}),T&&T[1].$watch(T[0],function(e){O.maxDate=e}),O};return a.version=1,a.defaults={dayNames:["日","一","二","三","四","五","六"],startDay:1,width:90,showTip:!0,disabled:!1,changeMonthAndYear:!1,mobileMonthAndYear:!1,showOtherMonths:!1,numberOfMonths:1,allowBlank:!1,minDate:null,maxDate:null,stepMonths:1,toggle:!1,separator:"-",calendarLabel:"选择日期",onChangeMonthYear:e.noop,dateCellRender:!1,watermark:!0,zIndex:-1,showDatepickerAlways:!1,timer:!1,onSelect:e.noop,onClose:e.noop,onSelectTime:e.noop,parseDate:function(t){if(!t)return null;if(e.type(t)==="date")return t;var n=this.separator,r="^(\\d{4})"+n+"(\\d{1,2})"+n+"(\\d{1,2})[\\s\\w\\W]*$";r=new RegExp(r);var i=t.match(r);return i?new Date(i[1],i[2]*1-1,i[3]):null},formatDate:function(t){if(e.type(t)!=="date")return e.log("the type of "+t+"must be Date"),"";var n=this.separator,r=t.getFullYear(),i=t.getMonth(),s=t.getDate();return r+n+this.formatNum(i+1,2)+n+this.formatNum(s,2)},formatNum:function(e,t){e=String(e);for(var n=0,r=t-e.length;n<r;n++)e="0"+e;return e},widgetElement:"",getTemplate:function(e,t){return e}},e.filters.timer=function(e){var t=+e;return t>=0&&t<=9&&(e="0"+e),e},e});