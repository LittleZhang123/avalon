define(["../avalon.getModel","text!./avalon.dialog.html","../button/avalon.button","css!../chameleon/oniui-common.css","css!./avalon.dialog.css","../draggable/avalon.draggable"],function(e,t){function v(t){var n=t;n?e.type(n)==="string"&&(n=e.vmodels[n]):n=e.define("dialogVM"+setTimeout("1"),function(e){});if(!n)throw new Error("您查找的"+n+"不存在");return e.isPlainObject(n)&&!n.$id&&!n.$accessors&&(n=e.define("dialogVM"+setTimeout("1"),function(n){e.mix(n,t)})),[].concat(n)}function m(e,t,n,r){var i=null,s;return function(){var o=this,u=+(new Date);clearTimeout(i),s||(s=u),u-s>=n?(e.apply(o,r),s=u):i=setTimeout(function(){e.apply(o,r)},t)}}function g(t,n,r){var i,o,u,l,h=e(s),p=e(a),d=e(n),v,m,g,y=0,b=0;if(!t.toggle)return;g=document.compatMode&&document.compatMode.toLowerCase()=="css1compat"?document.documentElement:document.body,i=document.documentElement.clientWidth?document.documentElement.clientWidth:document.body.clientWidth,o=document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight,v=document.body.scrollTop+document.documentElement.scrollTop,m=g.scrollLeft,u=n.offsetWidth,l=n.offsetHeight,l<o?y=(o-l)/2:y=0,u<i?b=(i-u)/2+m:b=0,l<o&&u<i?c||(t.position="fixed"):c||(t.position="absolute");if(r&&t.position=="fixed")return;if(t.position==="absolute"){if(f.length>1)for(var w=0;w<f.length-1;w++)f[w].widgetElement.style.display="none";h.css({height:o,width:i,top:v,position:"absolute"}),p.css({height:o,width:i,top:v,overflow:"auto",position:"absolute"})}else{if(f.length>1)for(var w=0;w<f.length-1;w++)f[w].widgetElement.style.display="block";h.css({height:"auto",width:"auto",top:0,position:"fixed"}),p.css({height:"auto",width:"auto",top:0,position:"static"})}d.css({left:b,top:y})}function y(){var t=document.body.children,n=10,r;for(var i=0,o;o=t[i++];)if(o.nodeType===1){if(o===s)continue;r=~~e(o).css("z-index"),r&&(n=Math.max(n,r))}return n+1}function b(){var e=document.createElement('<iframe src="javascript:\'\'" style="position:absolute;top:0;left:0;bottom:0;margin:0;padding:0;right:0;zoom:1;width:'+s.style.width+";height:"+s.style.height+";z-index:"+(s.style.zIndex-1)+';"></iframe>');return document.body.appendChild(e),e}var n=t,r=n.split("MS_OPTION_WIDGET"),i=r[0],s=e.parseHTML(i).firstChild,o=!1,u=n.split("MS_OPTION_LAYOUT_SIMULATE")[1],a=e.parseHTML(u).firstChild,f=[],l=0,c=(window.navigator.userAgent||"").toLowerCase().indexOf("msie 6")!==-1,h=null,p=document.compatMode&&document.compatMode.toLowerCase()=="css1compat"?document.documentElement:document.body,d=e.ui.dialog=function(t,r,i){l++;var u=r.dialogOptions;u.type=u.type.toLowerCase(),u.template=u.getTemplate(n,u);var d=u.template.split("MS_OPTION_FOOTER"),w=d[0].split("MS_OPTION_CONTENT"),E=w[0].split("MS_OPTION_HEADER"),S=E[0].split("MS_OPTION_INNERWRAPPER"),x=w[1],T=E[1],N=d[1].split("MS_OPTION_LAYOUT_SIMULATE")[0],C=S[1],k="",L="",A=e(t),O=u.onConfirm,M=null,_=u.onCancel,D=null,P=u.onOpen,H=null,B=u.onClose,j=null,F=!0,I=c?"absolute":"fixed";typeof O=="string"&&(M=e.getModel(O,i),u.onConfirm=M&&M[1][M[0]]||e.noop),typeof _=="string"&&(D=e.getModel(_,i),u.onCancel=D&&D[1][D[0]]||e.noop),typeof B=="string"&&(e.log("ms-widget='dialog' data-dialog-on-close 此用法已经被废弃"),j=e.getModel(B,i),u.onClose=j&&j[1][j[0]]||e.noop),typeof P=="string"&&(H=e.getModel(P,i),u.onOpen=H&&H[1][H[0]]||e.noop),N=u.getFooter(N,u);var q=e.define(r.dialogId,function(n){e.mix(n,u),n.$skipArray=["widgetElement","template","container","modal","zIndexIncrementGlobal","initChange","content"],n.widgetElement=t,n.position=I,n.showClose=n.type==="alert"?!1:n.showClose,n.initChange=!0,n._confirm=function(e){if(typeof q.onConfirm!="function")throw new Error("onConfirm必须是一个回调方法");q.onConfirm.call(e.target,e,q)!==!1&&q._close(e)},n._open=function(n){var r=0,i=document.getElementsByTagName("select").length,o=q.zIndex;e.Array.ensure(f,q),r=f.length,r&&(e(s).css("display","block"),e(a).css("display","block")),s.style.zIndex=2*r+o-1,a.style.zIndex=2*r+o-1,t.style.zIndex=2*r+o;if(n)return;document.documentElement.style.overflow="hidden",g(q,t),c&&i&&h===null&&q.modal?h=b():c&&i&&q.modal&&(h.style.display="block",h.style.width=s.style.width,h.style.height=s.style.height,h.style.zIndex=s.style.zIndex-1),q.onOpen.call(t,q)},n._close=function(r){e.Array.remove(f,n);var i=f.length,o=q.zIndex,u=i&&f[i-1];r&&(F=!1),q.toggle=!1;if(!u||!u.modal){e(s).css("display","none"),e(a).css("display","none"),h!==null&&(h.style.display="none"),document.documentElement.style.overflow="",q.onClose.call(t,q);return}e(s).css("display","block"),e(a).css("display","block"),u.widgetElement.style.display="block",g(u,u.widgetElement);var l=2*i+o-1;s.style.zIndex=l,a.style.zIndex=l,h&&(h.style.zIndex=l-1),q.onClose.call(t,q)},n._cancel=function(e){if(typeof q.onCancel!="function")throw new Error("onCancel必须是一个回调方法");q.onCancel.call(e.target,e,q)!==!1&&q._close(e)},n.setContent=function(t,n,r){var s=r?r:[q].concat(i);return k=t,L.innerHTML=k,n||e.scan(L,s),q},n.setTitle=function(e){return q.title=e,q},n.setModel=function(e){return!e.$content||q.setContent(e.$content,e.noScan,[q].concat(v(e)).concat(i)),!e.$title||(q.title=e.$title),q},n._renderView=function(){var n=null;t.setAttribute("ms-css-width","width"),L=e.parseHTML(x).firstChild,k=t.innerHTML||q.content,t.innerHTML="",L.innerHTML=k,n=e.parseHTML(C).firstChild,n.innerHTML=T,n.appendChild(L),n.appendChild(e.parseHTML(N)),t.appendChild(n),o||(document.body.appendChild(s),document.body.appendChild(a),o=!0)},n.$init=function(r){var s=q.container,o=p.clientHeight,f=document.body,l=(e.type(s)==="object"&&s.nodeType===1&&f.contains(s)?s:document.getElementById(s))||f,c=e.ui.dialog.defaults;c.zIndex||(c.zIndex=y()),e(f).height()<o&&e(f).css("min-height",o),q.draggable&&(A.attr("ms-draggable",""),q.draggable={handle:function(e){var t=e.target;do{if(t.className==="oni-dialog-header")return t;if(t.className==="oni-dialog")return}while(t=t.parentNode)}}),q.zIndex=q.zIndex+q.zIndexIncrementGlobal,q.title=q.title||"&nbsp;",A.addClass("oni-dialog"),t.setAttribute("ms-visible","toggle"),t.setAttribute("ms-css-position","position"),n._renderView(),f.contains(a)&&f==l?a.appendChild(t):l.appendChild(t),t.resizeCallback=e(window).bind("resize",m(g,50,100,[q,t])),t.scrollCallback=e(window).bind("scroll",m(g,50,100,[q,t,!0])),e.scan(t,[q].concat(i)),r?r():(e.log("avalon请尽快升到1.3.7+"),e.scan(t,[q].concat(i)),typeof u.onInit=="function"&&u.onInit.call(t,q,u,i))},n.$remove=function(){l--,t.innerHTML="",e.unbind(window,"resize",t.resizeCallback),e.unbind(window,"scroll",t.scrollCallback),l||(s.parentNode.removeChild(s),s.parentNode.removeChild(a),o=!1)},n.$watch("toggle",function(e){e?q._open():F===!1?F=!0:q._close()}),n.$watch("zIndex",function(e){q.initChange?q.initChange=!1:q._open(!0)})});return q};return d.version=1,d.defaults={width:480,title:"&nbsp;",draggable:!1,type:"confirm",content:"",onConfirm:e.noop,onOpen:e.noop,onCancel:e.noop,onClose:e.noop,setTitle:e.noop,setContent:e.noop,setModel:e.noop,showClose:!0,toggle:!1,widgetElement:"",container:"body",confirmName:"确定",cancelName:"取消",getTemplate:function(e,t){return e},getFooter:function(e){return e},modal:!0,zIndex:0,zIndexIncrementGlobal:0},e(window).bind("keydown",function(e){var t=e.which,n=f.length;t===27&&n&&(f[n-1].toggle=!1)}),e});