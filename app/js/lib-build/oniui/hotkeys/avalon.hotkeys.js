define(["avalon"],function(e){function r(e){return e.replace("++","+add").split("+").sort().join("+")}function s(e,i){var s=t[e.keyCode],o=String.fromCharCode(e.which).toLowerCase(),u="",a={};e.altKey&&s!=="alt"&&(u+="alt+"),e.ctrlKey&&s!=="ctrl"&&(u+="ctrl+"),e.metaKey&&!e.ctrlKey&&s!=="meta"&&(u+="meta+"),e.shiftKey&&s!=="shift"&&(u+="shift+"),o&&(a[r(u+o)]=!0,a[r(u+n[o])]=!0,u==="shift+"&&(a[n[o]]=!0));if(a[i])return!0}var t={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",191:"/",220:"\\",222:"'",224:"meta"},n={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},i=[];e.bindingHandlers.hotkeys=function(t,n){t.specialBind=function(n,s){var o={elem:n,fn:s,hotkeys:r(t.param)};i.push(o),t.specialUnbind=function(){e.Array.remove(i,o),delete t.specialBind,delete t.specialUnbind}},t.type="on",e.bindingHandlers.on(t,n)};var o=document.documentElement,u=function(t){var n=i.concat();for(var r=0,u;u=n[r++];)if(o.contains(u.elem)){if(s.call(u.elem,t,u.hotkeys))return u.fn.call(u.elem,t)}else e.Array.remove(i,u)};return e.bind(document,"keydown",u),e});