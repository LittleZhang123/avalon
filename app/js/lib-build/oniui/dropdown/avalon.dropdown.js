define(["avalon","text!./avalon.dropdown.html","../avalon.getModel","../scrollbar/avalon.scrollbar","css!../chameleon/oniui-common.css","css!./avalon.dropdown.css"],function(e,t){function s(e){try{e=e==="true"?!0:e==="false"?!1:e==="null"?null:+e+""===e?+e:e}catch(t){}return e}function o(e,t,n){var r=t||[];n=n||null;for(var i=0,s;s=e[i++];)Array.isArray(s.options)?(r.push({label:s.label,value:s.value,enable:a(s.enable,!0),group:!0,parent:n}),o(s.options,r,s)):(typeof s=="string"&&(s={label:s,value:s,title:s}),r.push({label:s.label,value:s.value,title:s.title,enable:a(n&&n.enable,!0)&&a(s.enable,!0),group:!1,parent:n,data:s}));return r}function u(e){var t=document.createDocumentFragment(),n,r;for(var i=0,s;s=e[i++];)s.group?(r=document.createElement("optgroup"),r.label=s.label,r.disabled=!s.enable,t.appendChild(r),n=r):(r=document.createElement("option"),r.text=s.label,r.value=s.value,r.disabled=!s.enable,s.parent&&n?n.appendChild(r):t.appendChild(r));return t}function a(e,t){return typeof e=="boolean"?e:t}function f(e,t,n){var r=t||[],i=e.children;n=n||null;for(var o=0,u;u=i[o++];)u.nodeType===1&&(u.tagName==="OPTGROUP"?(n={label:u.label,value:"",enable:!u.disabled,group:!0,parent:!1},r.push(n),f(u,r,n)):u.tagName==="OPTION"&&r.push({label:u.label.trim()||u.text.trim()||u.value.trim(),title:u.title.trim(),value:s(u.value.trim()||u.text.trim()),enable:a(n&&n.enable,!0)&&!u.disabled,group:!1,parent:n}));return r}function l(e,t,n){var r=e.size(),i=[],s=[],o,u;for(o=0;o<t;o++)e[o].enable&&!e[o].group&&i.push(o);for(o=t+1;o<r;o++)e[o].enable&&!e[o].group&&s.push(o);return i.length===0&&s.length===0?u=null:n?u=s.length>0?s.shift():i.shift():u=i.length>0?i.pop():s.pop(),u}function h(e){var t=[];for(;e;e=e.nextSibling)e.nodeType===1&&t.push(e);return t}var n=/^(\d+).*$/,r=!-[1]&&!window.XMLHttpRequest,i=e.ui.dropdown=function(i,a,p){function _(){e.each(i.getElementsByTagName("option"),function(t,n){if(M.value.$model.indexOf(n.value)>-1||M.value.$model.indexOf(s(n.value))>-1)try{n.selected=!0}catch(r){e(n).attr("selected","selected")}else try{n.selected=!1}catch(r){n.removeAttribute("selected")}})}function D(t){var n=(i.msData["ms-duplex"]||"").trim(),r;if(n&&(r=e.getModel(n,p)))t.value=r[1][r[0]],t.$hasDuplex=!0;else if(!g)Array.isArray(t.value)||(t.value=[t.value||""]);else{var o=[];Array.prototype.forEach.call(i.options,function(e){e.selected&&o.push(s(e.value))}),t.value=o}if(!t.multiple){Array.isArray(t.value)&&(t.value=t.value[0]!==void 0?t.value[0]:"");var u=t.data.filter(function(e){return e.value===t.value&&!e.group}),a=t.data.filter(function(e){return!e.group});u.length===0&&a.length>0&&(t.value=a[0].value,r&&(r[1][r[0]]=t.value))}var f=d.attr("data-duplex-changed"),l;f&&(l=e.getModel(f,p))&&(t.changedCallback=l[1][l[0]]),t.duplexName=n;var c=document.body,h=t.container;t.container=(e.type(h)==="object"&&h.nodeType===1&&c.contains(h)?h:document.getElementById(h))||c}function P(){return e.parseHTML(S)}function H(t){var n=M.data.$model.filter(function(e){return e.value===t});return n=n.length>0?n[0]:null,n?(M.label=n.label,M.title=n.title||n.label||""):e.log("[log] avalon.dropdown 设置label出错"),n}function B(){var t=document.getElementById("title-"+M.$id),r=e(t);return M.width-r.css("paddingLeft").replace(n,"$1")-r.css("paddingRight").replace(n,"$1")}function j(){!M.multiple&&O&&M._position()}var d=e(i),v=i.parentNode,m=a.dropdownOptions,g=!0,y,b,w,E,S,x,T,N,C=!1;"multiple,size".replace(e.rword,function(e){c(i,e)&&(m[e]=i[e])}),m.enable=!i.disabled,w=m.template=m.getTemplate(t,m).replace(/MS_OPTION_ID/g,a.dropdownId).split("MS_OPTION_TEMPLATE"),E=w[0],S=w[1],y=m.data.$model||m.data,i.removeAttribute("ms-duplex"),e.scan(i,p),b=f(i),g=!!b.length,b.length===0&&(b=o(y)),m.data=b,e(i).css("display","none"),D(m);for(var k=0,L=b.length;k<L;k++)if(b[k].value==m.value){m.activeIndex=k,m.currentOption=b[k];break}var A,O,M=e.define(a.dropdownId,function(t){e.mix(t,m),t.$skipArray=["widgetElement","duplexName","menuNode","dropdownNode","scrollWidget"],t.multiple&&t.$hasDuplex&&t.$skipArray.indexOf("value")===-1&&t.$skipArray.push("value"),t.widgetElement=i,t.menuWidth="auto",t.menuHeight=t.height,t.dataSource=y,t.focusClass=!1,t.$init=function(t){if(M.multiple)O=P(),v.insertBefore(O,i);else{var n;A=e.parseHTML(E),n=A.firstChild,v.insertBefore(A,i),A=n,M.titleWidth=B(),H(M.value),x=e.bind(document.body,"click",function(e){if(A.contains(e.target)){M._toggle();return}if(O&&O.contains(e.target))return;!M.__cursorInList__&&!M.multiple&&M.toggle&&(M.toggle=!1)}),M.position&&(T=e.bind(window,"scroll",j),N=e.bind(window,"resize",j))}g||(i.appendChild(u(b)),e.each(["multiple","size"],function(t,n){e(i).attr(n,M[n])}));if(!M.multiple){var r=(i.msData["ms-duplex"]||"").trim(),s;r&&(s=e.getModel(r,p))&&s[1].$watch(s[0],function(e){M.value=e}),M.$watch("value",function(t,n){function o(e){e?(C=!0,M.value=n):(s&&(s[1][s[0]]=t,i.value=t),M.currentOption=H(t))}var r=e.type(M.onChange)==="function"&&M.onChange||!1;if(C){C=!1;return}if(r&&r.call(i,t,n,M,o)!==!1||!r)s&&(s[1][s[0]]=t,i.value=t),M.currentOption=H(t)})}else M.value.$watch("length",function(){M.multipleChange=!M.multipleChange,_()});var o=i.msData["ms-disabled"],a,f=i.msData["ms-enabled"],l;o&&(a=e.getModel(o,p))&&(a[1].$watch(a[0],function(e){M.enable=!e}),M.enable=!a[1][a[0]]),f&&(l=e.getModel(f,p))&&(l[1].$watch(l[0],function(e){M.enable=e}),M.enable=l[1][l[0]]),M.enable=!i.disabled;var c=M.readonlyAttr,h;c&&(h=e.getModel(c,p))&&(h[1].$watch(h[0],function(e){M.readOnly=e}),M.readOnly=h[1][h[0]]);if(M.$source){if(e.type(M.$source)==="string"){var d=e.getModel(M.$source,p);d&&(M.$source=d[1][d[0]])}else M.$source.$id?M.$source.length>0&&M._refresh(M.$source.length):M.$source=null;M.$source&&M.$source.$watch&&M.$source.$watch("length",function(e){M._refresh(e)})}e.ready(function(){e.scan(i.previousSibling,[M].concat(p)),t?t():(e.log("请尽快升到avalon1.3.7+"),typeof m.onInit=="function"&&m.onInit.call(i,M,m,p)),M.multiple&&_()})},t.repeatRendered=function(){M.multiple&&e.vmodels["scrollbar-"+M.$id].update()},t.$remove=function(){x&&e.unbind(window,"click",x),T&&e.unbind(window,"scroll",T),N&&e.unbind(window,"resize",N),M.toggle=!1,O&&M.container.removeChild(O),e.log("dropdown $remove")},t._select=function(t,n){var r=M.data[t].$model;if(r&&r.enable&&!r.group){var s=M.value;M.multiple?(t=M.value.indexOf(r.value),t>-1?M.value.splice(t,1):M.value.push(r.value)):M.value=r.value,M.toggle=!1,e.type(M.onSelect)==="function"&&M.onSelect.call(i,n,M.value,s,M),M.activeIndex=t}},t._refresh=function(t){M.data.clear(),M.label="";if(t>0){M._disabledScrollbar(!1),M.data.pushArray(o(M.$source.$model||M.$source));var n;(n=H(M.value))?M.activeIndex=M.data.$model.indexOf(n):(M.currentOption=M.data[0].$model,M.activeIndex=0,H(M.value=M.data[0].value)),M.menuNode&&(e(M.menuNode).css({height:""}),e(M.dropdownNode).css({height:""}),M._styleFix())}},t._keydown=function(t){if(M.keyboardEvent===!1)return;if(!M.multiple){var n=M.activeIndex||0,r=M.value;switch(t.keyCode){case 9:case 27:t.preventDefault();break;case 13:M._select(n,t);break;case 38:case 63233:t.preventDefault(),n=l(M.data,n);if(n===null)return;M.value=M.data[n].value,M.activeIndex=n,M.scrollTo(n),e.type(M.onSelect)==="function"&&M.onSelect.call(i,t,M.value,r,M);break;case 40:case 63235:t.preventDefault(),n=l(M.data,n,!0);if(n===null)return;M.value=M.data[n].value,M.activeIndex=n,M.scrollTo(n),e.type(M.onSelect)==="function"&&M.onSelect.call(i,t,M.value,r,M)}}},t._toggle=function(t){if(M.data.length===0||!M.enable||M.readOnly){M.toggle=!1;return}if(!O){var n;O=P(),n=O.firstChild,M.container.appendChild(O),e.scan(n,[M].concat(p)),O=n,M.menuNode=document.getElementById("menu-"+M.$id),M.dropdownNode=document.getElementById("list-"+M.$id)}if(typeof t!="boolean"){M.toggle=!M.toggle;return}if(!t)e.type(M.onHide)==="function"&&M.onHide.call(this,O);else{var r,i,s=M.value;e.type(s)!=="array"&&(s=[s]),M.activeIndex==null&&(e.each(M.data,function(e,t){return r===void 0&&t.enable&&(r=e),t.value===s[0]?(i=e,!1):!0}),i||(i=r),M.activeIndex=i),M.scrollWidget=e.vmodels["scrollbar-"+M.$id],M._styleFix(),M._position(),e.type(M.onShow)==="function"&&M.onShow.call(this,O)}},t.$watch("toggle",function(e){M.focusClass=e,M._toggle(e)}),t.toggle=!1,t._position=function(){var t=e(A),r=t.offset(),i=t.outerHeight(!0),s=e(O),o=e(A.firstChild),u=s.height(),a=e(window),f={},l=O.offsetParent,c=e(l);while(o.element&&o.element.nodeType!=1)o=e(o.element.nextSibling);m.position&&r.top+i+u>a.scrollTop()+a.height()&&r.top-u>a.scrollTop()?f.top=r.top-u:f.top=r.top+i-o.css("borderBottomWidth").replace(n,"$1"),l&&l.tagName!=="BODY"&&l.tagName!=="HTML"?(f.top=f.top-c.offset().top+O.offsetParent.scrollTop,f.left=r.left-c.offset().left+O.offsetParent.scrollLeft):f.left=r.left,s.css(f)},t.__cursorInList__=!1,t._listenter=function(){M.__cursorInList__=!0},t._listleave=function(){M.__cursorInList__=!1},t._blur=function(){!M.__cursorInList__&&!M.multiple&&M.toggle&&(M.toggle=!1)},t.val=function(t){return typeof t!="undefined"&&(e.type(t)!=="array"&&(t=[t]),M.value=t),M.value},t.isActive=function(e){var t=e.value,n=e.enable,r=e.group;return M.multiple?M.value.indexOf(t)>-1&&n&&!r:M.value===t&&n&&!r},t._styleFix=function(){var t=m.height||200,i=e(M.menuNode),s=M.dropdownNode.scrollHeight;M.menuWidth=r?M.listWidth:M.listWidth-i.css("borderLeftWidth").replace(n,"$1")-i.css("borderRightWidth").replace(n,"$1"),s>t?(M._disabledScrollbar(!1),s=t,e(M.dropdownNode).css({width:M.menuWidth-M.scrollWidget.getBars()[0].width()})):(M._disabledScrollbar(!0),e(M.dropdownNode).css({width:M.menuWidth})),M.menuHeight=s,M.updateScrollbar(),M.scrollTo(M.activeIndex)},t.updateScrollbar=function(){M.scrollWidget.update()},t.scrollTo=function(t){if(!M.dropdownNode)return;var n=h(M.dropdownNode.firstChild),r=e(n[t]),i=M.menuHeight,s=r.position().top-e(n[0]).position().top,o=r.height(),u=M.dropdownNode.scrollTop;(s>u+i-o||s+o<u)&&M.scrollWidget.scrollTo(0,s+o-i)},t._disabledScrollbar=function(e){M.scrollWidget&&(M.scrollWidget.disabled=!!e)}});return M.$watch("enable",function(e){e||(M.toggle=!1)}),M.$watch("readOnly",function(e){!e||(M.toggle=!1)}),M};i.version="1.0",i.defaults={container:null,width:200,listWidth:200,titleWidth:0,height:200,enable:!0,readOnly:!1,readonlyAttr:null,currentOption:null,data:[],$source:null,textFiled:"text",valueField:"value",value:[],label:"",multiple:!1,listClass:"",title:"",titleClass:"",activeIndex:null,size:1,menuNode:null,dropdownNode:null,scrollWidget:null,position:!0,onSelect:null,onShow:null,onHide:null,onChange:null,$hasDuplex:!1,multipleChange:!1,keyboardEvent:!0,getTemplate:function(e,t){return e},onInit:e.noop};var c=document.documentElement.hasAttribute?function(e,t){return e.hasAttribute(t)}:function(e,t){var n=e.outerHTML,r=n.slice(0,n.search(/\/?['"]?>(?![^<]*<['"])/));return(new RegExp("\\s"+t+"\\b","i")).test(r)};return e});