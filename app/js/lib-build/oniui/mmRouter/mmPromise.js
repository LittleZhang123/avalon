define(["avalon"],function(e){function t(e){return this.then(e)}function n(e){return this.then(null,e)}var r=window.Promise;if(/native code/.test(window.Promise))return r.prototype.done=t,r.prototype.fail=n,r.any=r.race,e.mmPromise=r;var i=function(e){this._callbacks=[];var t=this;if(typeof this!="object")throw new TypeError("Promises must be constructed via new");if(typeof e!="function")throw new TypeError("not a function");e(function(e){o(t,e)},function(e){u(t,e)})},s=typeof window.setImmediate=="function"?function(e){window.setImmediate(e)}:function(e){window.setTimeout(e,0)};i.resolve=function(e){return new i(function(t){t(e)})},i.reject=function(e){return new i(function(t,n){n(e)})},i.prototype={constructor:i,_state:"pending",_fired:!1,_fire:function(e,t){if(this._state==="rejected"){if(typeof t!="function")throw this._value;t(this._value)}else typeof e=="function"&&e(this._value)},_then:function(e,t){if(this._fired){var n=this;s(function(){n._fire(e,t)})}else this._callbacks.push({onSuccess:e,onFail:t})},then:function(e,t){var n=this;return new i(function(r,i){n._then(function(t){if(typeof e=="function")try{t=e(t)}catch(n){i(n);return}r(t)},function(e){if(typeof t=="function"){try{e=t(e)}catch(n){i(n);return}r(e)}else i(e)})})},done:t,"catch":n,fail:n};function o(e,t){if(e._state!=="pending")return;e._state="fulfilled";if(t&&typeof t.then=="function"){var n=t instanceof i?"_then":"then";t[n](function(t){a(e,t)},function(t){e._state="rejected",a(e,t)})}else a(e,t)}function u(e,t){if(e._state!=="pending")return;e._state="rejected",a(e,t)}function a(e,t){e._fired=!0,e._value=t,s(function(){e._callbacks.forEach(function(t){e._fire(t.onSuccess,t.onFail)})})}function f(e,t){t=Array.isArray(t)?t:[];var n=0,r=[],s;return new i(function(i,o){function u(u,a){u.then(function(o){if(!s){r[a]=o,n++;if(e||n>=t.length)i(e?o:r),s=!0}},function(e){s=!0,o(e)})}for(var a=0,f=t.length;a<f;a++)u(t[a],a)})}return i.all=function(e){return f(!1,e)},i.race=function(e){return f(!0,e)},i.any=i.race,window.Promise=e.mmPromise=i});