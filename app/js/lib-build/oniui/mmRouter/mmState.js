define("mmState",["mmPromise","mmRouter"],function(){function t(e){function n(e,t){var r=e.controller;avalon.vmodels[r]&&avalon.Array.ensure(t,avalon.vmodels[r]),e.parentState&&n(e.parentState,t)}var t=[];return n(e,t),t}function n(e,t,n){e[n]=t[n],delete t[n]}function r(e,t){return typeof e[t]=="function"?e[t]:avalon.noop}function i(e,t){var n=avalon.vmodels[e],r=n&&n.$events.expr||"[ms-controller='"+e+"']",i=[];t.split(".").forEach(function(){i.push("[ms-view]")});if(document.querySelectorAll)return document.querySelectorAll(r+" "+i.join(" "));var s=Array.prototype.filter.call(document.getElementsByTagName("*"),function(e){return typeof e.getAttribute("ms-view")=="string"});while(i.length>1)i.pop(),s=o(s,function(e){return typeof e.getAttribute("ms-view")=="string"});return s=o(s,function(t){return t.getAttribute("avalonctrl")===e||t.getAttribute("ms-controller")===e}),s.map(function(e){return e.node})}function s(e,t){for(var n=0,r;r=e[n++];)if(r.getAttribute("ms-view")===t)return r}function o(e,t){for(var n=0,r=e.length;n<r;n++)u(n,e,t);return e.filter(function(e){return e})}function u(e,t,n){var r=t[e];if(r.node)var i=r.node,s=r.parent;else i=r,s=r.parentNode;while(s&&s.nodeType!==9){if(n(s))return t[e]={node:i,parent:s};s=s.parentNode}t[e]=!1}function a(e,t){var n=new Promise(function(n,r){var i=typeof e=="function"?e(t):e;typeof i=="string"?n(i):r("template必须对应一个字符串或一个返回字符串的函数")});return n}function l(e,t){var n=new Promise(function(n,r){typeof e=="function"&&(e=e(t));if(typeof e!="string")return r("templateUrl必须对应一个URL");if(avalon.templateCache[e])return n(avalon.templateCache[e]);var i=f();i.onreadystatechange=function(){if(i.readyState===4){var t=i.status;t>399&&t<600?r("templateUrl对应资源不存在或没有开启 CORS"):n(avalon.templateCache[e]=i.responseText)}},i.open("GET",e,!0),"withCredentials"in i&&(i.withCredentials=!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.send()});return n}function c(e,t){var n=new Promise(function(n,r){if(typeof e=="function"){var i=e(t);i&&i.then?n(i):r("templateProvider为函数时应该返回一个Promise或thenable对象")}else e&&e.then?n(e):r("templateProvider不为函数时应该对应一个Promise或thenable对象")});return n}function h(e,t){return e.template?a(e.template,t):e.templateUrl?l(e.templateUrl,t):e.templateProvider?c(e.templateProvider,t):new Promise(function(e,t){t("必须存在template, templateUrl, templateProvider中的一个")})}function p(e){var t=e.match(/([-\.\w]+)\./)||["",""],n=t[1];if(n){var r=avalon.router.routingTable.get;for(var i=0,s;s=r[i++];)if(s.stateName===n)return s;throw new Error("必须先定义["+n+"]")}}function d(e){if(typeof e=="string")return e;var t=[];for(var n in e)t.push(n+"="+encodeURIComponent(e[n]));return t.length?"?"+t.join("&"):""}avalon.router.route=function(t,n,r){n=n.trim();var i=this.routingTable[t],s=e.currentState;for(var o=0,u;u=i[o++];){var a=n.match(u.regexp);if(a&&u.abstract!==!0){s&&u.url===s.url&&u.stateName===s.stateName&&(s=avalon.mix(!0,{},s)),u.query=r||{},u.path=n,u.params={};var f=u.keys;a.shift(),f.length&&this._parseArgs(a,u),u.stateName?e.transitionTo(s,u,a):u.callback.apply(u,a);return}}this.errorback&&this.errorback()},avalon.router.go=function(t,n){var r=e.currentState,i,s=this.routingTable.get;for(var o=0,u;u=s[o++];)if(u.stateName===t){i=u;break}if(i){r&&r.url===i.url&&r.stateName===i.stateName&&(r=avalon.mix(!0,{},r));if(!i.params||i.parentState)i.params=i.parentState?i.parentState.params||{}:{};avalon.mix(!0,i.params,n||{});var a=i.keys.map(function(e){return i.params[e.name]||""});e.transitionTo(r,i,a);if(avalon.history&&n&&r!=i){avalon.router.locked=!0;var f=n.query?d(n.query):"",l=i.url.replace(/\{[^\/\}]+\}/g,function(e){var t=e.replace(/[\{\}]/g,"");return n[t]||""}).replace(/^\//g,"")+f;avalon.history.updateLocation(l)}}};var e={prevState:null,currentState:null,transitionTo:function(t,n,r){e.prevState=t,e.currentState=n;var i=[],s=n;if(!t)while(s)i.push(s),s=s.parentState;else if(t===n)i.push(s);else while(s&&s!==t)i.push(s),s=s.parentState;i.reverse();var o=new Promise(function(e){e()});i.forEach(function(e){o=o.then(function(){return e.callback.apply(e,r)})})}};avalon.state=function(o,u){var a=p(o);u.url===void 0&&(u.abstract=!0),a&&(u.url=a.url+(u.url||""),u.parentState=a),u.stateName=o;if(!u.views){var f={};"template,templateUrl,templateProvider,onBeforeLoad,onAfterLoad".replace(/\w+/g,function(e){n(f,u,e)}),u.views={"":f}}return avalon.router.get(u.url,function(){var n=this,a=arguments,f=[],l=[],c=[];r(u,"onChange").apply(n,a);var p=t(u),d=p[p.length-1];if(!d){avalon.log("topController不存在");return}d=d.$id;var v=e.prevState&&e.prevState.stateName+".",m=e.currentState,g="viewDefaultInnerHTMLKey",y=null;return avalon.each(u.views,function(e,t){if(e.indexOf("@")>=0)var r=e.split("@"),u=r[0],a=r[1];else u=e||"",a=o;var b=o+".";if(!v||v===b||v.indexOf(b)!==0||o===m.stateName){var w=i(d,a),E=s(w,u),S="warning: "+o+"状态对象的【"+e+"】视图对象",x=-1;avalon.each(w,function(e,t){if(t===E||avalon.contains(E,t))return;y===t&&(x=e);if(y&&(x===-1||e<=x))return;var n=avalon(t),r=n.data(g);r&&(avalon.innerHTML(t,r),avalon.scan(t,p))});if(E){u||(y=E);var T=avalon(E).data(g);T===null&&avalon(E).data(g,E.innerHTML);var N=h(t,n.params);l.push(E),c.push(function(){N.then(function(e){avalon.innerHTML(E,e),avalon.scan(E,p)},function(e){avalon.log(S+" "+e)})}),f.push(N)}else avalon.log(S+"对应的元素节点不存在")}}),r(u,"onBeforeLoad").call(l,n),avalon.each(c,function(e,t){t()}),Promise.all(f).then(function(e){r(u,"onAfterLoad").call(l,n)})},u),this};var f=function(){return new(window.XMLHttpRequest||ActiveXObject)("Microsoft.XMLHTTP")}});