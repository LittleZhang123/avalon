define(["avalon","text!./avalon.at.html","css!../chameleon/oniui-common.css","css!./avalon.at.css"],function(e,t){function r(e){return e.replace(/([A-Z]+)/g,function(e,t){return"-"+t.toLowerCase()})}function i(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function s(e){var t;if(typeof e.selectionStart=="number")t=e.selectionStart;else{var n=e.selection.createRange();n.moveStart("character",-e.value.length),t=n.text.length}return t}function o(e,t){if(e.setSelectionRange)e.focus(),e.setSelectionRange(t,t);else if(e.createTextRange){var n=e.createTextRange();n.collapse(!0),n.moveEnd("character",t),n.moveStart("character",t),n.select()}}function u(e,t){var n=t._datalist.size(),r=e.which||e.keyCode;switch(r){case 13:t._select(e);break;case 9:case 27:e.preventDefault();break;case 38:case 63233:var i=t.activeIndex-1;i<0&&(i=n-1),t.activeIndex=i;break;case 40:case 63235:e.preventDefault();var i=t.activeIndex+1;i===n&&(i=0),t.activeIndex=i}}var n=e.ui.at=function(n,a,f){var l=a.atOptions,c=e(n),h,p,d,v;l.template=l.getTemplate(t,l);var m=new Date-0,g,y,b=e.define(a.atId,function(t){e.mix(t,l),t.$skipArray=["at","widgetElement","datalist","template"],t.widgetElement=n,t.$init=function(t){var r=[b].concat(f);p=c.bind("blur",function(e){!b.$model.__mouseenter__&&b.toggle&&(b.toggle=!1)}),d=c.bind("keydown",function(e){e.keyCode===13&&v&&e.preventDefault(),e.which===38&&e.preventDefault()}),h=c.bind("keyup",function(t){var n=this;if(t.shiftKey)return;setTimeout(function(){var o=s(n),a=n.value,f=l.at,c=null,h=a.charAt(o-1)===f,p=a.slice(0,o).lastIndexOf(f);if(p===-1)return b.toggle=!1;g=p+1,h&&(c="");if(!h&&typeof g=="number"){var c=a.slice(g,o);if(c.indexOf(" ")>=0||c.length>l.maxLength)return b.toggle=!1;c=c.length>=l.minLength?c:""}if(typeof c=="string"){b.query=c;if(!v){var d=a.slice(0,o),y=d;y=y.replace(new RegExp(i(f),"img"),"<bdo>"+f+"</bdo>"),v=b._popup.call(n,y),b.activeIndex=0,e.scan(v,r),e(v).bind("mouseleave",function(){b.$model.__mouseenter__=!1})}function w(){var e=b.filterData(b),t=e.join(",");b.$model.__toString__!==t&&(e=e.map(function(e){return b.highlightData(e,c)}),b._datalist=e,b.$model.__toString__=t),b.toggle=!!e.length}var E=new Date;m-E>b.delay&&typeof b.updateData=="function"&&(b.updateData(w),m=E),w(),b.$model.__keyup__=!0,u(t,b),setTimeout(function(){b.$model.__keyup__=!1},150)}})}),t?t():(e.log("请尽快升到avalon1.3.7+"),e.scan(n,r),typeof l.onInit=="function"&&l.onInit.call(n,b,l,f))},t.$remove=function(){e(n).unbind("keyup",h).unbind("blur",p).unbind("keydown",d),t.toggle=!1,e.log("at $remove")},t._popup=function(t){y=y||document.createElement("div"),y.innerHTML=t,document.body.appendChild(y);var n=window.getComputedStyle?getComputedStyle(this,null):this.currentStyle,i={};e(this).css("font-size");for(var s in n)/^[a-z]+$/i.test(s)&&n[s]!==""&&typeof n[s]!="function"&&(i[s]=n[s]);e.mix(i,{width:e(this).width()+"px",height:e(this).height()+"px",border:"1px solid red",display:"block","word-wrap":"break-word",visibility:"hidden"});var o=[];for(var s in i)o.push(r(s)+":"+i[s]);y.style.cssText=o.join("; "),y.scrollTop=this.scrollTop,y.scrollLeft=this.scrollLeft;var u=e(this).offset(),a=y.getBoundingClientRect(),f=y.getElementsByTagName("bdo"),l=f[f.length-1];if(document.createRange){var c=document.createRange();c.selectNode(l);var h=c.getBoundingClientRect()}else h=l.getBoundingClientRect();var p=h.bottom-a.top,d=h.left-a.left;return v=v||document.createElement("div"),v.innerHTML=b.template,document.body.appendChild(v),v.className="oni-at",v.setAttribute("ms-visible","toggle"),e(v).css({top:u.top+p,left:u.left+d,position:"absolute"}),v},t._hover=function(e,n){e.preventDefault();var r=b.$model;r.__mouseenter__=!0,r.__keyup__||(t.activeIndex=n)},t.$watch("toggle",function(e){e===!1&&v&&v.parentNode&&(v.parentNode.removeChild(v),v=null,document.body.removeChild(y),y=null)}),t._select=function(e){e.stopPropagation(),e.preventDefault();var t=b._datalist[b.activeIndex],r=document.createElement("span");r.innerHTML=t,t=r.textContent||r.innerText;var i=n.value;n.value=i.slice(0,g)+t+" "+i.slice(g),o(n,g+t.length+1),b.toggle=!1}});return b};return n.vertion=1,n.defaults={at:"@",datalist:[],_datalist:[],template:"",toggle:!1,activeIndex:0,query:"",limit:5,maxLength:20,minLength:1,delay:500,updateData:function(e,t){},getTemplate:function(e,t){return e},filterData:function(e){var t={},n=e.query,r=n.toLowerCase(),i=e.datalist.filter(function(e){if(e.indexOf(n)===0)return t[e]=1,!0});return e.datalist.forEach(function(e){var n=e.toLowerCase();t[e]||n.indexOf(r)>-1&&(t[e]=1,i.push(e))}),i.slice(0,e.limit)},highlightData:function(e,t){var n=i(t);return e.replace(new RegExp("("+n+")","ig"),function(e,t){return'<strong style="color:#FF6600;">'+t+"</strong>"})}},e});