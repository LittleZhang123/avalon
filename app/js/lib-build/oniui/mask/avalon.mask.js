define(["avalon"],function(){function e(n,r){var i=avalon.getWidgetData(n,"duplexMask"),s={};try{s=(new Function("return "+i.translations))()}catch(o){}avalon.mix(this,e.defaults,i),this.translations=avalon.mix({},e.defaults.translations,s),this.element=n,this.dataMask=r,t.call(this),this.valueMask=this.viewData.join("")}function t(){var e=this.dataMask.split(""),t=e.length,n=this.translations;this.viewData=e.concat(),this.caretData=e.concat(),this.vmodelData=new Array(t);for(var r=0;r<t;r++){var i=e[r];if(n[i]){var s=n[i];this.viewData[r]=s.placehoder||this.placehoder,this.caretData[r]=null,this.vmodelData[r]=null}}}function n(e){var t=0,n=0;if(typeof e.selectionStart=="number"&&typeof e.selectionEnd=="number")t=e.selectionStart,n=e.selectionEnd;else{var r=document.selection.createRange();if(r&&r.parentElement()===e){var i=e.value.length,s=e.value.replace(/\r?\n/g,"\n"),o=e.createTextRange();o.moveToBookmark(r.getBookmark());var u=e.createTextRange();u.collapse(!1),o.compareEndPoints("StartToEnd",u)>-1?t=n=i:(t=-o.moveStart("character",-i),t+=s.slice(0,t).split("\n").length-1,o.compareEndPoints("EndToEnd",u)>-1?n=i:(n=-o.moveEnd("character",-i),n+=s.slice(0,n).split("\n").length-1))}}return{start:t,end:n}}function r(e,t,n){if(!e.value||e.readOnly)return;n||(n=t);if(e.setSelectionRange)e.selectionStart=t,e.selectionEnd=n,e.focus();else{var r=e.createTextRange();r.collapse(!0),r.moveStart("character",t),r.moveEnd("character",n-t),r.select()}}avalon.duplexHooks.mask={init:function(t,i){var s=i.element,o=s.getAttribute("data-duplex-mask");if(!o)throw"请指定data-duplex-mask";var u=i.msMask=new e(s,o);i.bound("keydown",function(e){s.userTrigger=!1;var t=e.which||e.keyCode;if(e.ctrlKey||e.altKey||e.metaKey||t<32)return;var i=n(s);if(t===39){var o=u.caretData.indexOf(null,i.end);o===-1&&(o=u.caretData.indexOf(null)),setTimeout(function(){r(s,o,o+1)})}else if(t==37){var a=u.caretData.slice(0,i.start),o=a.lastIndexOf(null);o===-1&&(o=u.caretData.indexOf(null)),setTimeout(function(){r(s,o,o+1)})}else s.userTrigger=!0}),i.bound("click",function(e){setTimeout(function(){s.userTrigger=!1});if(s.userTrigger===!0)return;var t=n(s),i=u.caretData.indexOf(null,t.end);i===-1&&(i=u.caretData.indexOf(null)),setTimeout(function(){r(s,i,i+1)})});function a(e){s.value=u.valueMask,s.userTrigger=!0;var t=u.vmodelData.indexOf(null);t!==-1&&r(s,t,t+1)}function f(){var e=u.vmodelData.some(function(e){return e===null});if(u.hideIfInvalid&&e||u.hideIfPristine&&s.value===u.valueMask)s.value=s.oldValue=""}u.showAlways?a():(u.showIfFocus&&(i.bound("focus",a),i.bound("blur",f)),u.showIfHover&&(i.bound("mouseover",a),i.bound("mouseout",f)))},get:function(e,t){var i=t.element,s=t.msMask;if(i.userTrigger){s.getter(e),i.oldValue=e,i.userTrigger=!1;var o=s.vmodelData.indexOf(null);if(o===-1){var u=n(i),o=s.caretData.indexOf(null,u.end);o===-1&&(o=s.caretData.indexOf(null)),r(i,o,o+1)}else setTimeout(function(){r(i,o,o+1)})}return i.oldValue=e,s.vmodelData.join("")},set:function(e,t){var n=t.element,r=t.msMask;return e!==""?(r.match(e)||(n.oldValue=r.fix(e)),t.msMask.viewData.join("")):""}},e.defaults={placehoder:"_",hideIfInvalid:!1,hideIfPristine:!0,showIfHover:!1,showIfFocus:!0,showAlways:!1,translations:{9:{pattern:/\d/},A:{pattern:/[a-zA-Z]/},"*":{pattern:/[a-zA-Z0-9]/}}},e.prototype={match:function(e){if(e.length===this.valueMask.length){var t=e.split(""),n=this.translations;for(var r=0,i=t.length;r<i;r++){var s=t[r];if(n[s]){var o=n[s],u=o.pattern,a=o.placehoder||this.placehoder;if(s===a)continue;if(!u.test(s))return!1}else if(s!==this.valueMask.charAt(r))return!1}return!0}return!1},fix:function(e){var t=this.dataMask.split(""),n=e.split(""),r=this.translations;for(var i=0,s=t.length;i<s;i++){var o=t[i];if(r[o]){var u=r[o],a=u.pattern;a.test(n[0])?t[i]=n.shift():t[i]=u.placehoder||this.placehoder}}return this.viewData=t,t.join("")},getter:function(e){var t=this.dataMask.split(""),n=e.split(""),r=this.translations,i=[],s=[];while(t.length){var o=t.shift(),u=n.shift();if(r[o]){var a=r[o],f=a.pattern;u&&u.match(f)?(s.push(u),i.push(u)):(s.push(null),i.push(a.placehoder||this.placehoder))}else i.push(u),s.push(void 0)}this.viewData=i,this.vmodelData=s}}});