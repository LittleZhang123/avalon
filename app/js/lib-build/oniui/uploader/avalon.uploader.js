define(["browser/avalon.browser","text!./avalon.uploader.html","uploader/mmRequest","./swfobject/swfobject"],function(e,t){function r(e,t){return window.getComputedStyle?getComputedStyle(e)[t]:e.currentStyle[t]}var n=e.ui.uploader=function(n,i,s){function g(){var r=e.parseHTML(t.split("MS_OPTION_COM")[0]).firstChild;r.onchange=function(e){var t=this.files;if(t)for(var n=0,r=t.length;n<r;n++)b(t[n]);else this.select(),this.blur(),m.files.push({src:document.selection.createRange().text});this.value="";if(this.value){var i=document.createElement("form"),s=this.nextSibling,o=this.parentNode;i.appendChild(this),i.reset(),s?s.parentNode.insertBefore(this,s):o.appendChild(this)}},c=e.bind(l,"click",function(){r.click()}),d>0&&d<10?l.appendChild(r):(r.style.display="none",n.appendChild(r))}function y(){var n=e.parseHTML(t.split("MS_OPTION_COM")[1]).firstChild;v?l.removeChild(l.lastChild):r(l,"position")=="static"&&(l.style.position="relative"),d==6&&(n.style.height=r(l,"height")),l.appendChild(n);var i={js_handler:"avalon.vmodels."+o+".$jsHandler",uploadAPI:m.action,maxFileSize:m.maxFileSize,maxFileNum:m.maxFileCount,imgMaxWidth:m.imgMaxWidth,imgMaxHeight:m.imgMaxHeight},s={menu:"false",scale:"noScale",allowFullscreen:"true",allowScriptAccess:"always",bgcolor:"",wmode:"transparent"},a={id:u};e.swfobject.embedSWF("swfobject/multiPicUpload.swf","altContent","100%","100%","10.0.0","expressInstall.swf",i,s,a),v=!0}function b(e){if(/image/.test(e.type)){var t=new FileReader;t.readAsDataURL(e),t.onprogress=function(e){},t.onload=function(){m.files.length<m.maxFileCount&&(m.files.push({src:t.result,name:e.name,size:e.size}),f.push(e))}}}var o=i.uploaderId,u=o+"Swf",a,f=[],l,c,h=["action","browseButton"],p=!0,d=e.browser.ie,v=!1,m=e.define(i.uploaderId,function(t){t.files=[],e.mix(t,i.uploaderOptions),l=document.getElementById(t.browseButton),t.deleteFile=function(t){e.post(m.action,{id:m.files[t].id},function(e){e.errcode==0?(m.files.removeAt(t),a.setUploadSuccessNum&&a.setUploadSuccessNum(m.files.length),m.onDeleteSuccess(e)):m.onDeleteFailed(e)},"json")},t.$init=function(){for(var t=0,r=h.length;t<r;t++){var o=h[t];if(!m[o]){e.log("avalon.uploader 缺少配置项："+o),p=!1;break}}p&&y(),e.scan(n,[m].concat(s)),typeof m.onInit=="function"&&m.onInit.call(n,m,i.uploaderOptions,s)},t.$remove=function(){},t.$jsHandler=function(e){switch(e.type){case"uploading":break;case"singleSuccess":break;case"singleError":m.onSingleFailed(e.data.name);break;case"uploaded":var t=e.data.sucAry,n=[];for(var r=0,i=t.length;r<i;r++){var s={name:t[r].name,src:t[r].source.data.images[0].url,id:t[r].source.data.images[0].id};m.files.push(s),n.push(s)}m.onSuccess(n,e.data);break;case"flashInit":a=document.getElementById(u),a.setMaxFileNum(m.maxFileCount),a.setUploadSuccessNum(m.files.length);break;case"onSizeErr":m.onFileSizeErr(e.data);break;case"fileNumErr":m.onFileCountErr(m.maxFileCount-m.files.length,e.data)}}});return e.browser.chrome||m.files.$watch("length",function(e){e==m.maxFileCount&&m.$init()}),m};return n.version=1.2,n.defaults={maxFileSize:1048576,maxFileCount:100,imgMaxWidth:1e4,imgMaxHeight:1e4,onSuccess:e.noop,onSingleFailed:function(e){alert("文件"+e+"上传失败")},onFileSizeErr:function(e){alert("文件"+e+"太大了")},onFileCountErr:function(e,t){alert("还可选择"+e+"个，你选择了"+t+"个，超出了")},onDeleteSuccess:e.noop,onDeleteFailed:e.noop},e});