define(["../promise/avalon.promise"],function(e){function t(e){if(/^\d{15}$/.test(e))return!0;if(/^\d{17}[0-9xX]$/.test(e)){var t="1,0,x,9,8,7,6,5,4,3,2".split(","),n="7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2".split(","),r=e.toLowerCase().split(""),i=0;for(var s=0;s<17;s++)i+=n[s]*r[s];return t[i%11]==r[17]}}function n(e){if(r.test(e)){var t=parseInt(RegExp.$1,10),n=parseInt(RegExp.$2,10),i=parseInt(RegExp.$3,10),s=new Date(i,n-1,t,12,0,0,0);if(s.getUTCFullYear()===i&&s.getUTCMonth()===n-1&&s.getUTCDate()===t)return!0}return!1}function a(e){if(e.target)return e;var t={};for(var n in e)t[n]=e[n];var r=t.target=e.srcElement;if(e.type.indexOf("key")===0)t.which=e.charCode!=null?e.charCode:e.keyCode;else if(/mouse|click/.test(e.type)){var i=r.ownerDocument||document,s=i.compatMode==="BackCompat"?i.body:i.documentElement;t.pageX=e.clientX+(s.scrollLeft>>0)-(s.clientLeft>>0),t.pageY=e.clientY+(s.scrollTop>>0)-(s.clientTop>>0),t.wheelDeltaY=t.wheelDelta,t.wheelDeltaX=0}return t.timeStamp=new Date-0,t.originalEvent=e,t.preventDefault=function(){e.returnValue=!1},t.stopPropagation=function(){e.cancelBubble=!0},t}function c(){var e=this.data||{};return this.message.replace(l,function(t,n){return e[n]==null?"":e[n]})}if(!e.duplexHooks)throw new Error("你的版本少于avalon1.3.7，不支持ms-duplex2.0，请使用avalon.validation.old.js");var r=/^\d{4}\-\d{1,2}\-\d{1,2}$/,i=/^([A-Z0-9]+[_|\_|\.]?)*[A-Z0-9]+@([A-Z0-9]+[_|\_|\.]?)*[A-Z0-9]+\.[A-Z]{2,3}$/i,s=/^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)$/i,o=/^((([0-9A-Fa-f]{1,4}:){7}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){6}:[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){5}:([0-9A-Fa-f]{1,4}:)?[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){4}:([0-9A-Fa-f]{1,4}:){0,2}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){3}:([0-9A-Fa-f]{1,4}:){0,3}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){2}:([0-9A-Fa-f]{1,4}:){0,4}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){6}((\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b)\.){3}(\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b))|(([0-9A-Fa-f]{1,4}:){0,5}:((\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b)\.){3}(\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b))|(::([0-9A-Fa-f]{1,4}:){0,5}((\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b)\.){3}(\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b))|([0-9A-Fa-f]{1,4}::([0-9A-Fa-f]{1,4}:){0,5}[0-9A-Fa-f]{1,4})|(::([0-9A-Fa-f]{1,4}:){0,6}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){1,7}:))$/i,u={cm:/^(?:0?1)((?:3[56789]|5[0124789]|8[278])\d|34[0-8]|47\d)\d{7}$/,cu:/^(?:0?1)(?:3[012]|4[5]|5[356]|8[356]\d|349)\d{7}$/,ce:/^(?:0?1)(?:33|53|8[079])\d{8}$/,cn:/^(?:0?1)[3458]\d{9}$/};e.mix(e.duplexHooks,{trim:{get:function(e,t){return t.element.type!=="password"&&(e=String(e||"").trim()),e}},required:{message:"必须填写",get:function(e,t,n){return n(e!==""),e}},norequired:{message:"可以不写",get:function(e,t,n){return n(!0),t.norequired=e==="",e}},"int":{message:"必须是整数",get:function(e,t,n){return n(/^\-?\d+$/.test(e)),e}},phone:{message:"手机号码不合法",get:function(e,t,n){var r=!1;for(var i in u)if(u[i].test(e)){r=!0;break}return n(r),e}},decimal:{message:"必须是小数",get:function(e,t,n){return n(/^\-?\d*\.?\d+$/.test(e)),e}},alpha:{message:"必须是字母",get:function(e,t,n){return n(/^[a-z]+$/i.test(e)),e}},alpha_numeric:{message:"必须为字母或数字",get:function(e,t,n){return n(/^[a-z0-9]+$/i.test(e)),e}},alpha_dash:{message:"必须为字母或数字及下划线等特殊字符",validate:function(e,t,n){return n(/^[a-z0-9_\-]+$/i.test(e)),e}},chs:{message:"必须是中文字符",get:function(e,t,n){return n(/^[\u4e00-\u9fa5]+$/.test(e)),e}},chs_numeric:{message:"必须是中文字符或数字及下划线等特殊字符",get:function(e,t,n){return n(/^[\\u4E00-\\u9FFF0-9_\-]+$/i.test(e)),e}},qq:{message:"腾讯QQ号从10000开始",get:function(e,t,n){return n(/^[1-9]\d{4,10}$/.test(e)),e}},id:{message:"身份证格式错误",get:function(e,n,r){return r(t(e)),e}},ipv4:{message:"ip地址不正确",get:function(e,t,n){return n(s.test(e)),e}},ipv6:{message:"ip地址不正确",get:function(e,t,n){return n(o.test(e)),e}},email:{message:"邮件地址错误",get:function(e,t,n){return n(i.test(e)),e}},url:{message:"URL格式错误",get:function(e,t,n){return n(/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/.test(e)),e}},repeat:{message:"密码输入不一致",get:function(t,n,r){var i=n.element.getAttribute("data-duplex-repeat")||"",s=e(document.getElementById(i)).val()||"";return r(t===s),t}},date:{message:"必须符合日期格式 YYYY-MM-DD",get:function(e,t,r){return r(n(e)),e}},passport:{message:"护照格式错误或过长",get:function(e,t,n){return n(/^[a-zA-Z0-9]{4,20}$/i.test(e)),e}},minlength:{message:"最少输入{{min}}个字",get:function(e,t,n){var r=t.element,i=parseInt(r.getAttribute("minlength"),10);isFinite(i)||(i=parseInt(r.getAttribute("data-duplex-minlength"),10));var s=t.data.min=i;return n(e.length>=s),e}},maxlength:{message:"最多输入{{max}}个字",get:function(e,t,n){var r=t.element,i=parseInt(r.getAttribute("maxlength"),10);isFinite(i)||(i=parseInt(r.getAttribute("data-duplex-maxlength"),10));var s=t.data.max=i;return n(e.length<=s),e}},gt:{message:"必须大于{{max}}",get:function(e,t,n){var r=t.element,i=parseInt(r.getAttribute("max"),10);isFinite(i)||(i=parseInt(r.getAttribute("data-duplex-gt"),10));var s=t.data.max=i;return n(parseFloat(e)>s),e}},lt:{message:"必须小于{{min}}",get:function(e,t,n){var r=t.element,i=parseInt(r.getAttribute("min"),10);isFinite(i)||(i=parseInt(r.getAttribute("data-duplex-lt"),10));var s=t.data.min=i;return n(parseFloat(e)<s),e}},eq:{message:"必须等于{{eq}}",get:function(e,t,n){var r=t.element,i=parseInt(r.getAttribute("data-duplex-eq"),10),s=t.data.eq=i;return n(parseFloat(e)==s),e}},contains:{message:"必须包含{{array}}中的一个",get:function(e,t,n){var r=[].concat(e).map(String),i=(t.element.getAttribute("data-duplex-contains")||"").split(",");t.data.array=i;var s=!1;for(var o=0,u=r.length;o<u;o++){var a=r[o];if(i.indexOf(a)>=0){s=!0;break}}return n(s),e}},contain:{message:"必须包含{{array}}",get:function(e,t,n){var r=[].concat(e).map(String),i=(t.element.getAttribute("data-duplex-contain")||"").split(",");t.data.array=i.join("与");if(!r.length)var s=!1;else{s=!0;for(var o=0,u=i.length;o<u;o++){var a=i[o];if(r.indexOf(a)===-1){s=!1;break}}}return n(s),e}},pattern:{message:"必须匹配/{{pattern}}/这样的格式",get:function(e,t,n){var r=t.element,i=r.getAttribute("pattern"),s=r.getAttribute("data-duplex-pattern"),o=t.data.pattern=i||s,u=new RegExp("^(?:"+o+")$");return n(u.test(e)),e}}});var f=e.ui.validation=function(t,n,r){var i=n.validationOptions,s,o=e.define(n.validationId,function(n){e.mix(n,i),n.$skipArray=["widgetElement","data","validationHooks","validateInKeyup","validateAllInSubmit","resetInBlur"],n.widgetElement=t,n.data=[],n.$init=function(){t.setAttribute("novalidate","novalidate"),e.scan(t,[o].concat(r)),n.validateAllInSubmit&&(s=e.bind(t,"submit",function(e){e.preventDefault(),n.validateAll(n.onValidateAll)})),typeof i.onInit=="function"&&i.onInit.call(t,o,i,r)},n.$destory=function(){n.data=[],s&&e.unbind(t,"submit",s),t.textContent=t.innerHTML=""},n.validateAll=function(e){var t=typeof e=="function"?e:n.onValidateAll,r=n.data.filter(function(e){return e.element&&!e.element.disabled&&o.widgetElement.contains(e.element)}).map(function(e){return n.validate(e,!0)});Promise.all(r).then(function(e){var r=[];for(var i=0,s;s=e[i++];)r=r.concat(s);t.call(n.widgetElement,r)})},n.resetAll=function(e){n.data.filter(function(e){return e.element}).forEach(function(e){try{n.onReset.call(e.element,{type:"reset"},e)}catch(t){}});var t=typeof e=="function"?e:n.onResetAll;t.call(n.widgetElement)},n.validate=function(t,r,i){var s=t.valueAccessor(),u=o.validationHooks,a=e.duplexHooks,f=[],l=t.element;t.validateParam.replace(/\w+/g,function(e){var n=u[e]||a[e];if(!l.disabled){var r,i;f.push(new Promise(function(e,t){r=e,i=t}));var o=function(i){t.norequired&&(i=!0),delete t.norequired;if(i)r(!0);else{var s={element:l,data:t.data,message:l.getAttribute("data-duplex-message")||n.message,validateRule:e,getMessage:c};r(s)}};t.data={},n.get(s,t,o)}});var h=Promise.all(f).then(function(e){var t=[];for(var s=0,o;o=e[s++];)typeof o=="object"&&t.push(o);return r||(t.length?n.onError.call(l,t,i):n.onSuccess.call(l,t,i),n.onComplete.call(l,t,i)),t});return h},n.$watch("avalon-ms-duplex-init",function(r){var i=o.validationHooks;r.valueAccessor=r.evaluator.apply(null,r.args);switch(e.type(r.valueAccessor())){case"array":r.valueResetor=function(){this.valueAccessor([])};break;case"boolean":r.valueResetor=function(){this.valueAccessor(!1)};break;case"number":r.valueResetor=function(){this.valueAccessor(0)};break;default:r.valueResetor=function(){this.valueAccessor("")}}var s=e.duplexHooks;if(typeof r.pipe!="function"&&e.contains(t,r.element)){var u=[],f=[];r.param.replace(/\w+/g,function(e){var t=i[e]||s[e];t&&typeof t.get=="function"&&t.message?f.push(e):u.push(e)}),r.validate=n.validate,r.param=u.join("-"),r.validateParam=f.join("-");if(f.length){n.validateInKeyup&&r.bound("keyup",function(e){var t=a(e);setTimeout(function(){n.validate(r,0,t)})}),n.validateInBlur&&r.bound("blur",function(e){n.validate(r,0,a(e))}),n.resetInFocus&&r.bound("focus",function(e){n.onReset.call(r.element,a(e),r)});var l=n.data.filter(function(e){return e.element});e.Array.ensure(l,r),n.data=l}return!1}})});return o},l=/\\?{{([^{}]+)\}}/gm;f.defaults={validationHooks:{},onSuccess:e.noop,onError:e.noop,onComplete:e.noop,onValidateAll:e.noop,onReset:e.noop,onResetAll:e.noop,validateInBlur:!0,validateInKeyup:!0,validateAllInSubmit:!0,resetInFocus:!0}});