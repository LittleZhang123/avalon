define(["avalon","text!./avalon.dropdownlist.html","text!./avalon.suggest.html","../scrollbar/avalon.scrollbar.js","../textbox/avalon.textbox.js","css!../chameleon/oniui-common.css","css!./avalon.dropdownlist.css"],function(e,t,n){var r=null,i=e.ui.dropdownlist=function(i,s,o){var u=s.dropdownlistOptions,a=e(i),f=u.limit,l=[],c={suggestion:{suggestCtr:{_minIndex:0,_maxIndex:0,listIndex:0,_items:"",moveUp:function(e){e<this._minIndex?(this.listIndex=this.listIndex-1,this._minIndex=l[this.listIndex],this._maxIndex=l[this.listIndex+f-1],this._update(),this.scroll.pre()):e>=this._maxIndex?(this.listIndex=l.length-f,this._minIndex=l[this.listIndex],this._maxIndex=l[l.length-1],this._update(),this.scroll.set(this._getHeight(0,this._minIndex-1))):this.scroll.isScolled&&this.scroll.recover()},moveDown:function(e){e>=this._maxIndex&&l.length>f?(this.listIndex=this.listIndex+1,this.listIndex+f>l.length&&(this.listIndex=l.length-f),this._minIndex=l[this.listIndex],this._maxIndex=l[this.listIndex+f-1],this._update(),this.scroll.next()):e<=this._minIndex&&l.length>f?(this.listIndex=0,this._minIndex=l[0],l.length>f?this._maxIndex=l[f-1]:this._maxIndex=l[l.length-1],this._update(),this.scroll.set(0)):this.scroll.isScolled&&this.scroll.recover()},reset:function(){var e=this.suggest;this.listIndex=0,this._minIndex=l[0],this._maxIndex=l[f-1],e.scrollTop=0,this._items=e.getElementsByTagName("li"),this._update()},fixMinMaxIndex:function(e){var t=l.indexOf(e),n=l.length>f,r=this.suggest.style.height;if(t!==-1)if(n){this.listIndex=t-Math.floor(f/2),this.listIndex<0&&(this.listIndex=0),this.listIndex+f>l.length&&(this.listIndex=l.length-f),this._minIndex=l[this.listIndex],this._maxIndex=l[this.listIndex+f-1],r=="auto"&&this._update();if(this.listIndex==0)return;this.scroll.scrollTo(l[this.listIndex-1])}else this.listIndex=0,this._minIndex=l[0],this._maxIndex=l[l.length-1],r!="auto"&&this._update();else this.listIndex=0,this._minIndex=l[0],n?(this._maxIndex=l[f-1],r=="auto"&&this._update()):(this._maxIndex=l[l.length-1],r!="auto"&&this._update())},scroll:{isScolled:!1,set:function(e){var t=r.suggestVM.suggestCtr;t.suggest.scrollTop=e,this.isScolled=!1},pre:function(){var e=r.suggestVM.suggestCtr;this.isScolled?this.recover():e.suggest.scrollTop-=e._items[e._minIndex].offsetHeight},next:function(){var e=r.suggestVM.suggestCtr;this.isScolled?this.recover():e.suggest.scrollTop+=e._items[l[e.listIndex-1]].offsetHeight},scrollTo:function(e){var t=r.suggestVM.suggestCtr;t.suggest.scrollTop=t._getHeight(0,e)},recover:function(){var e=r.suggestVM.suggestCtr;this.set(e._getHeight(0,e._minIndex-1))}},_update:function(e){var t=e||l.length,n=this.suggest;t>f?(n.style.overflowY="scroll",n.style.height=this._getHeight(this._minIndex,this._maxIndex)+"px"):(n.style.overflowY="auto",n.style.height="auto")},_getHeight:function(e,t){var n=0,r=this._items;for(var i=e;i<=t;i++){if(r[i].style.display=="none")continue;n+=r[i].offsetHeight}return n}},limit:u.limit,onChangeCallback:function(e){r&&(r.searchItem=e)},onSelectItem:function(e,t){r&&(r.textboxToggle=!1),t.value=""},getTemplate:function(e){return n},setSelectedClass:function(e,t,n){return n?e[t]==n:!1},toggleItem:function(e){return e?e.toggle:!1},renderItem:function(e){return e?e.value:""},updateSource:function(t,n,r,i){var s=[],o=[];l=[];if(i&&n.list.length!==r.data.length){o=r.data,o.forEach(function(e,t){l.push(t),typeof e=="string"&&s.push({value:e,toggle:!0})}),n.selectedIndex=0,n.list=s;return}if(i){n.list.forEach(function(e,t){l.push(t),e.toggle=!0});return}e.each(n.list,function(e,n){!~n.value.indexOf(t)&&t?n.toggle=!1:(n.toggle=!0,l.push(e))}),n.suggestCtr.fixMinMaxIndex(n.selectedIndex)},keyDownOperation:function(t,n,r){var i=t.list[t.selectedIndex]&&t.list[t.selectedIndex].value,s=t.selectedIndex;switch(n.which){case 13:n.preventDefault();if(!t.toggle){typeof t.onSelectItem=="function"&&t.onSelectItem.call(null,i,t.inputElement);return}t.toggle=!1,t.onChangeCallback(i,t.inputElement,n),typeof t.onSelectItem=="function"&&t.onSelectItem.call(null,i,t.inputElement);break;case 38:n.preventDefault();if(!t.toggle)return;for(var o=s-1,u=t.list.$model;o>=0;o--){var a=u[o];s--;if(a.toggle)break}if(o==-1){var f=u.length;s=f-1;for(o=s;o>0;o--){a=u[o];if(a.toggle)break;s--}}t.selectedIndex=s,r&&l.length&&t.suggestCtr.moveUp(s),t.onChangeCallback(i,t.inputElement,n);break;case 40:n.preventDefault();if(!t.toggle)return;for(var o=s+1,u=t.list.$model,f=u.length;o<f;o++){var a=u[o];s++;if(a.toggle)break}if(o==f){s=0;for(o=0;o<f;o++){a=u[o];if(a.toggle)break;s++}}t.selectedIndex=s,r&&l.length&&t.suggestCtr.moveDown(s),t.onChangeCallback(t.list[t.selectedIndex].value,t.inputElement,n);break;default:var c=e.bind(t.inputElement,"keyup",function(){t.searchText=this.value,e.unbind(t.inputElement,"keyup",c)})}},onInit:function(e){e.$watch("toggle",function(t){t&&e.suggestCtr.reset()}),h.suggestVM=e,e.updateSource("",e,h,!0)}},getTemplate:function(e){return e.replace(/MS_OPTION_ICON/,'<i class="oni-icon oni-textbox-icon" ms-visible="textboxToggle">&#xf002;</i>')}};u.textbox=e.mix(u.textbox,c),u.template=u.getTemplate(t);var h=e.define(s.dropdownlistId,function(t){e.mix(t,u),t.$skipArray=["widgetElement","data","textbox","searchBox","suggestVM","template"],t.widgetElement=i,t.searchItem="",t.textboxToggle=!1,t.searchBox=null,t.suggestVM=null,t.toggleDropdownList=function(e,t){e.stopPropagation(),t=!t,r&&r!=h&&r.textboxToggle&&(r.textboxToggle=!1),t?r=h:r&&(r.searchBox&&(r.searchBox.value=""),r.suggestVM.selectedIndex=0),h.textboxToggle=t},t.render=function(t){suggestVM=h.suggestVM,e.type(t)=="array"&&(h.data=t),suggestVM.updateSource("",suggestVM,h,!0)},t.$init=function(){i.innerHTML=u.template,a.addClass("oni-dropdownlist"),h.searchBox=i.getElementsByTagName("input")[0],e.scan(i,[h].concat(o)),e.bind(h.searchBox,"focus",function(){var e=h.suggestVM;e.updateSource("",e,h,!0),e.toggle=!0}),i.clickCallback=e.bind(document.body,"click",function(e){var t=e.target;i.contains(t)||(h.textboxToggle=!1)})},t.$remove=function(){i.innerHTML=i.textContent="",e.unbind(document.body,"click",i.clickCallback)}});return h};return i.version=1,i.defaults={data:[],limit:10,getTemplate:function(e,t){return e}},e});