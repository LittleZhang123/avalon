define(["avalon","text!./avalon.simplegrid.html","../pager/avalon.pager","../dropdown/avalon.dropdown","../loading/avalon.loading","../scrollbar/avalon.scrollbar","css!../chameleon/oniui-common.css","css!./avalon.simplegrid.css"],function(e,t){function d(e,t,n){var r="",i=t.offset(),s=t[0].offsetWidth,o=n.edge;return e.pageX<i.left+s&&e.pageX>i.left+s-o&&(r="e"),r==="e"?r:""}function v(e,t,n){n=!!n,e[t]=typeof e[t]=="boolean"?e[t]:n}function m(t){do{if(e(t).css("display")==="none"){var n,r=e(t);return[function(){r.css("display","block"),n=r.css("visibility")},function(){r.css("display","none"),r.css("visibility",n)}]}if(t.tagName==="BODY")break}while(t=t.parentNode);return[e.noop,e.noop]}function g(e,t,n){e[t]=typeof e[t]=="function"?e[t](n,e):typeof e[t]=="string"?e[t]:n}var n=t,r,i;n=n.replace(/MS_OPTION_THEAD_BEGIN([\s\S]+)MS_OPTION_THEAD_END/,function(e,t){return r=t,"MS_OPTION_THEAD_HOLDER"}),n=n.replace(/MS_OPTION_TBODY_BEGIN([\s\S]+)MS_OPTION_TBODY_END/,function(e,t){return i=t,"MS_OPTION_TBODY_HOLDER"});var s=document.body||document.documentElement,o=/^function\s+\w*\s*\([^)]*\)\s*{\s*}$/m,u=e.ui.simplegrid=function(t,s,u){function j(e,t){var n=e,r=n>H?"down":"up";H=n;var i=Math.abs(B-n),s=M._rowHeight;if(i>=M._rowHeightNoBorders){var o=i/s,u=Math.floor(o),a=o-u;a>.55&&(u+=1);var f=M.data.length,l=0,c=M.showRows;if(r==="down")while(M.endIndex+1<f){M.endIndex+=1,M.startIndex+=1,l+=1;var h=M.data[M.endIndex];u-l<=c&&(M._data.push(h),M._data.shift());if(l===u)break}else while(M.startIndex>=0){M.endIndex-=1,M.startIndex-=1,l+=1;var h=M.data[M.startIndex];u-l<=c&&(M._data.unshift(h),M._data.pop());if(l===u)break}B=M.tbodyScrollTop=M.startIndex*s}}var l=s.simplegridOptions,c=+(new Date),y;l.columns=l.getColumns(l.columns,l),g(l,"theadTemplate",r),g(l,"tbodyTemplate",i);var b=n.replace(/MS_OPTION_THEAD_HOLDER/,l.theadTemplate).replace(/MS_OPTION_TBODY_HOLDER/,l.tbodyTemplate);l.template=l.getTemplate(b,l).replace(/\{\{MS_OPTION_ID\}\}/g,c),typeof l.pager!="object"?l.pager={}:l.pageable=!0;var w=l.pager;w.perPages=l.pageable?w.perPages||l.data.length:l.data.length,w.nextText=w.nextText||"下一页",w.prevText=w.prevText||"上一页",Array.isArray(w.options)&&(w.getTemplate=typeof w.getTemplate=="function"?w.getTemplate:function(e){return e+'<div class="oni-simplegrid-pager-options">每页显示<select ms-widget="dropdown" data-dropdown-list-width="50" data-dropdown-width="50" ms-duplex="perPages"><option ms-repeat="options" ms-value="el.value">{{el.text}}</option></select>条,共{{totalItems}}条结果</div>'}),v(w,"showJumper",!0),l.pager=l.getPager(w,l),l.showRows=l.showRows||w.perPages;if(!Array.isArray(l.columnsOrder)){var E=[];for(var S=0,x;x=l.columns[S++];)E.push(x.field);l.columnsOrder=E}else if(l.syncTheadColumnsOrder){E=l.columnsOrder.concat();var T=[],N=l.columns,C;while(x=E.shift())e:for(var k=0,L=N.length;k<L;k++){C=N[k];if(C.field==x){T.push(C),N.splice(k,1);break e}}l.columns=T}var A,O={toggle:!1,onInit:function(e,t,n){M.loadingVModel=e}};l.loading=e.type(l.loading)==="object"?e.mix(l.loading,O):O;var M=e.define(s.simplegridId,function(n){e.mix(n,l),n.$skipArray=["_init","widgetElement","data","addColumnCallbacks","scrollPanel","topTable","bottomTable","startIndex","pager","endIndex","template","loading","loadingVModel"],n.loadingVModel=null,n.widgetElement=t,n.gridWidth="100%",n.startIndex=0,n.endIndex=l.showRows,n.cssLeft="0",n.barRight=0,n.scrollerHeight=void 0,n.paddingBottom="0",n.barUpdated=!1,n._data=[],n._init=!0,n.$init=function(){e.ready(function(){t.innerHTML=l.template.replace(/MS_OPTION_ID/g,M.$id),A=[M].concat(u),e.scan(t,A),typeof l.onInit=="function"&&l.onInit.call(t,M,l,u)})},n._theadRenderedCallback=function(){var t=m(n.widgetElement);t[0]();var r=this,i=this.parentNode,s=i.parentNode,o=r.children,a=0;for(var f=0,c;c=o[f++];)if(c.nodeType===1&&c["data-vm"]){var h=n.columns[a++];String(h.width).indexOf("%")===-1&&(h.width=c.offsetWidth)}n.topTable=s,n.theadHeight=e(s).innerHeight(),n.scrollPanel=s.parentNode.parentNode,n.gridWidth=Math.min(s.offsetWidth,n.scrollPanel.offsetWidth)+1,t[1](),n.theadRenderedCallback.call(i,M,l,u)},n._tbodyRenderedCallback=function(t){function i(){var t=r.getElementsByTagName("td")[0]||r.getElementsByTagName("th")[0],i=m(n.widgetElement);i[0]();var s=n.bottomTable=r.parentNode,o=M._data.size()?0:M.noResultHeight;n.tbodyHeight=e(s).innerHeight()+o;var a=r.rows.length;n._rowHeight=a?n.tbodyHeight/a:35;var f=n.pageable?n.pager.perPages:n.data.length;n.tbodyScrollHeight=n._rowHeight*f;var c=t?Math.max(e.css(t,"borderTopWidth",!0),e.css(t,"borderBottomWidth",!0)):0;n._rowHeightNoBorders=n._rowHeight-c*2,i[1](),n.tbodyRenderedCallback.call(r,M,l,u),setTimeout(function(){M.updateScrollbar(!M.barUpdated),M.barUpdated=!0})}var r=this;setTimeout(i,100)},n.showLoading=function(){M.loadingVModel.toggle=!0},n.hideLoading=function(){M.loadingVModel.toggle=!1},n.startResize=function(t,n){if(l._drag||!n.resizable)return;var r=e(this),i=d(t,r,l);l._cursor=r.css("cursor"),i===""?(l.canResize=!1,r.css("cursor","default")):(l.canResize=r,r.css("cursor",i+"-resize"))},n.stopResize=function(){l.canResize&&(l.canResize.css("cursor",l._cursor),M.updateScrollbar("forceUpdate"),delete l.canResize)},n.resizeColumn=function(t,r){var i=l.canResize;if(i){typeof r.width!="number"&&(r.width=i[0].offsetWidth);var s=r.width,o=t.pageX;l._drag=!0,a();var u=n.gridWidth,c=e.bind(document,"mousemove",function(e){if(l._drag){e.preventDefault();var t=e.pageX-o;n.gridWidth=u+t,r.width=s+t,M.updateScrollbar("forceUpdate")}}),h=e.bind(document,"mouseup",function(t){t.preventDefault(),l._drag&&(f(),delete l._drag,n.gridWidth=u+t.pageX-o,r.width=s+t.pageX-o,e.unbind(document,"mousemove",c),e.unbind(document,"mouseup",h))})}},n.sortIndex=NaN,n.getArrow=function(e,t){var r=n.sortIndex,i=e.sortAsc;return t!==r?"ndb":i?"asc":"desc"},n.sortColumn=function(e,t){n.sortIndex=t;var r=e.sortAsc=!e.sortAsc,i=e.field,s=M.$model;r=r?1:-1,typeof s.remoteSort=="function"&&!o.test(s.remoteSort)?M.remoteSort(i,r,M):typeof e.localSort=="function"&&!o.test(e.localSort)?(M._data.sort(function(t,n){return r*e.localSort(t,n,i,s)||0}),typeof M.onSort=="function"&&setTimeout(function(){M.onSort(M)},500)):M._data.sort(function(e,t){return r*(e[i]-t[i])||0})},n.getColumnsOrder=function(){return n.columnsOrder},n.addColumn=function(e,t){var r=l.getColumns([e],n)[0],i=r.field;if(n.columnsOrder.indexOf(i)===-1){var s=parseInt(t,10)||0,o=r.defaultValue||"";n.columns.splice(s,0,r),n.columnsOrder.splice(s,0,i),n.addColumnCallbacks[i]=function(e){e.forEach(function(e){e.hasOwnProperty(i)||(e[i]=o)})}}n.reRender(n.data,n)},n.getCellProperty=function(e,t){for(var r=0,i;i=n.columns[r++];)if(i.field===e)return i[t]},n.throttleRenderTbody=function(e,t){M.tbodyScrollTop=e,p(P),P=h(function(){j(e,t)})},n.getScrollerHeight=function(){var e=M.tbodyScrollHeight+M.tbodyScrollTop-M.theadHeight,t=M._rowHeight*M.data.length;return e=e>t?t:e,setTimeout(function(t){var n=M.getScrollbar().getScroller().css("height");if(e!=n&&!t){arguments.callee(1);return}M.scrollerHeight=e},100),e},n.$spgScrollbarOpts={onScroll:function(e,t,n){n=="v"?(clearTimeout(y),y=setTimeout(function(){M.throttleRenderTbody(e,t)},16)):M.cssLeft=e==void 0?"auto":-e+"px"},viewHeightGetter:function(e){return e.innerHeight()-M.theadHeight},show:n.showScrollbar},n.getScrollbar=function(){return e.vmodels["$simplegrid"+c]},n.updateScrollbar=function(e){if(!e)return;var t=M.getScrollbar(),n=t.getScroller();t&&t.update()},n.$watch("showRows",function(e){M.endIndex=e})});M._data=M.getStore(M.data,M);if(M.pageable)var _=!1,D=setInterval(function(){var t=document.getElementById("pager-"+M.$id);t&&!_&&(t.setAttribute("ms-widget","pager,pager-"+M.$id),e(t).addClass("oni-simplegrid-pager-wrapper"),e.scan(t,M),_=!0);var n=e.vmodels["pager-"+M.$id];n&&(M.pager=n,clearInterval(D))},100);var P,H=0,B=0;return M.$watch("scrollerHeight",function(e){e>0?(M.getScrollbar().disabled=!1,M.getScrollbar().toggle=!0,M.updateScrollbar("forceUpdate")):(M.getScrollbar().disabled=!0,M.getScrollbar().toggle=!1)}),M};u.defaults={theadHeight:35,noResultHeight:100,tbodyScrollHeight:"auto",rowClass:"even",showScrollbar:"always",tbodyScrollTop:0,tbodyHeight:"auto",evenClass:"even",_rowHeight:35,_rowHeightNoBorders:0,columnWidth:160,edge:15,_data:[],topTable:{},bottomTable:{},scrollPanel:{},addColumnCallbacks:{},pageable:!1,syncTheadColumnsOrder:!0,remoteSort:e.noop,noResultContent:"暂无结果",theadRenderedCallback:function(e,t,n){},tbodyRenderedCallback:function(e,t,n){e._init?e._init=!1:e.widgetElement.scrollIntoView()},renderCell:function(e,t,n){return e},getColumnTitle:function(){return""},getTemplate:function(e,t){return e},reRender:function(t,n){e.each(n.addColumnCallbacks,function(e,n){n(t)}),n.data=t,n._data=n.getStore(t,n),typeof n.onSort=="function"&&setTimeout(function(){n.onSort(n)},500)},getStore:function(e,t){return e.slice(t.startIndex,t.endIndex)},getColumn:function(e,t){return e},getPager:function(e,t){return e},getColumns:function(e,t){var n=[];for(var r=0,i;i=e[r++];)typeof i=="string"&&(i={field:i}),i.text=i.text||i.field,i.title=t.getColumnTitle(i),i.width=i.width||t.columnWidth,i.className=i.className||"",i.align=i.align||"",i.localSort=typeof i.localSort=="function"?i.localSort:!1,v(i,"sortable",!0),v(i,"resizable",!1),v(i,"sortAsc",!0),v(i,"toggle",!0),v(i,"disabledToggle"),v(i,"disabledResize"),t.getColumn(i,t),n.push(i);return n}};var a=function(){e(s).addClass("oni-helper-noselect")},f=function(){e(s).removeClass("oni-helper-noselect")};if(window.VBArray&&!("msUserSelect"in document.documentElement.style)){var l;function c(e){e.returnValue=!1}a=function(){l=s.onselectstart,s.onselectstart=c},f=function(){s.onselectstart=l}}var h=window.requestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)},p=window.cancelAnimationFrame||function(e){clearTimeout(e)};return e});