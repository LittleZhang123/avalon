define(["avalon"],function(e){function h(t){t=e.mix({},t);var n,a,f,l,h,g,y=e(t.of),E=w(t.within),S=b(E),x=(t.collision||"flip").split(" "),T={};g=d(y),y[0].preventDefault&&(t.at="left top"),a=g.width,f=g.height,l=g.offset,h=e.mix({},l),c.forEach(function(e){var n=(t[e]||"").split(" "),r,a;n.length===1&&(n=i.test(n[0])?n.concat(["center"]):s.test(n[0])?["center"].concat(n):["center","center"]),n[0]=i.test(n[0])?n[0]:"center",n[1]=s.test(n[1])?n[1]:"center",r=o.exec(n[0]),a=o.exec(n[1]),T[e]=[r?r[0]:0,a?a[0]:0],t[e]=[u.exec(n[0])[0],u.exec(n[1])[0]]}),x.length===1&&(x[1]=x[0]),t.at[0]==="right"?h.left+=a:t.at[0]==="center"&&(h.left+=a/2),t.at[1]==="bottom"?h.top+=f:t.at[1]==="center"&&(h.top+=f/2),n=v(T.at,a,f),h.left+=n[0],h.top+=n[1];var N,C=this[0],k=C.offsetWidth,L=C.offsetHeight,A=m(this,"marginLeft"),O=m(this,"marginTop"),M=k+A+m(this,"marginRight")+S.width,_=L+O+m(this,"marginBottom")+S.height,D=e.mix({},h),P=v(T.my,k,L);return t.my[0]==="right"?D.left-=k:t.my[0]==="center"&&(D.left-=k/2),t.my[1]==="bottom"?D.top-=L:t.my[1]==="center"&&(D.top-=L/2),D.left+=P[0],D.top+=P[1],D.left=r(D.left),D.top=r(D.top),N={marginLeft:A,marginTop:O},["left","top"].forEach(function(e){p[e](D,{targetWidth:a,targetHeight:f,elemWidth:k,elemHeight:L,collisionPosition:N,collisionWidth:M,collisionHeight:_,offset:[n[0]+P[0],n[1]+P[1]],my:t.my,at:t.at,within:E,elem:C})}),this.offset(D)}function d(t){var n=t[0];return n.nodeType===9?{width:t.width(),height:t.height(),offset:{top:0,left:0}}:e.isWindow(n)?{width:t.width(),height:t.height(),offset:{top:t.scrollTop(),left:t.scrollLeft()}}:n.preventDefault?{width:0,height:0,offset:{top:n.pageY,left:n.pageX}}:{width:n.offsetWidth,height:n.offsetHeight,offset:t.offset()}}function v(e,t,n){return[parseFloat(e[0])*(a.test(e[0])?t/100:1),parseFloat(e[1])*(a.test(e[1])?n/100:1)]}function m(e,t){return parseInt(e.css(t),10)||0}function g(e){var t=this[0],n,r,i,s,o,u,a,f=this.css("position");return f==="static"&&(t.style.position="relative"),o=this.offset(),i=this.css("top"),u=this.css("left"),a=(f==="absolute"||f==="fixed")&&(i+u).indexOf("auto")>-1,a?(n=this.position(),s=n.top,r=n.left):(s=parseFloat(i)||0,r=parseFloat(u)||0),e.top!=null&&(t.style.top=e.top-o.top+s+"px"),e.left!=null&&(t.style.left=e.left-o.left+r+"px"),this}function y(){if(t!==void 0)return t;var n,r,i=e.parseHTML("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>").firstChild,s=i.children[0];return document.body.appendChild(i),n=s.offsetWidth,i.style.overflow="scroll",r=s.offsetWidth,n===r&&(r=i.clientWidth),document.body.removeChild(i),t=n-r}function b(e){var t=e.isWindow?"":e.element.css("overflow-x"),n=e.isWindow?"":e.element.css("overflow-y"),r=t==="scroll"||t==="auto"&&e.width<e.element[0].scrollWidth,i=n==="scroll"||n==="auto"&&e.height<e.element[0].scrollHeight;return{width:i?y():0,height:r?y():0}}function w(t){var n=e(t||window),r=e.isWindow(n[0]);return{element:n,isWindow:r,offset:n.offset()||{left:0,top:0},scrollLeft:n.scrollLeft(),scrollTop:n.scrollTop(),width:r?n.width():n[0].offsetWidth,height:r?n.height():n[0].offsetHeight}}var t,n=Math.abs,r=Math.round,i=/left|center|right/,s=/top|center|bottom/,o=/[\+\-]\d+(\.[\d]+)?%?/,u=/^\w+/,a=/%$/,t,f=e.fn.position,l=e.fn.offset;e.fn.offset=function(t){return e.type(t)==="object"?g.call(this,t):l.call(this)};var c=["my","at"],p={left:function(e,t){var r=t.within,i=r.offset.left+r.scrollLeft,s=r.width,o=r.isWindow?r.scrollLeft:r.offset.left,u=e.left-t.collisionPosition.marginLeft,a=u-o,f=u+t.collisionWidth-s-o,l=t.my[0]==="left"?-t.elemWidth:t.my[0]==="right"?t.elemWidth:0,c=t.at[0]==="left"?t.targetWidth:t.at[0]==="right"?-t.targetWidth:0,h=-2*t.offset[0],p,d;if(a<0){p=e.left+l+c+h+t.collisionWidth-s-i;if(p<0||p<n(a))e.left+=l+c+h}else if(f>0){d=e.left-t.collisionPosition.marginLeft+l+c+h-o;if(d>0||n(d)<f)e.left+=l+c+h}},top:function(e,t){var r=t.within,i=r.offset.top+r.scrollTop,s=r.height,o=r.isWindow?r.scrollTop:r.offset.top,u=e.top-t.collisionPosition.marginTop,a=u-o,f=u+t.collisionHeight-s-o,l=t.my[1]==="top",c=l?-t.elemHeight:t.my[1]==="bottom"?t.elemHeight:0,h=t.at[1]==="top"?t.targetHeight:t.at[1]==="bottom"?-t.targetHeight:0,p=-2*t.offset[1],d,v;a<0?(v=e.top+c+h+p+t.collisionHeight-s-i,e.top+c+h+p>a&&(v<0||v<n(a))&&(e.top+=c+h+p)):f>0&&(d=e.top-t.collisionPosition.marginTop+c+h+p-o,e.top+c+h+p>f&&(d>0||n(d)<f)&&(e.top+=c+h+p))}};return e.fn.position=function(t){return e.type(t)==="object"?h.call(this,t):f.call(this)},e});