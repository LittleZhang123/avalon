define(["draggable/avalon.draggable","text!./avalon.colorpicker.html","css!./avalon.colorpicker.css"],function(e,t){function s(e){var t=/#[0-9,a-f]{6}$/i;return t.test(e)}function o(e,t,n){function a(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}var r,i,s;if(t==0)r=i=s=n;else{var o=n<.5?n*(1+t):n+t-n*t,u=2*n-o;r=a(u,o,e+1/3),i=a(u,o,e-1/3),s=a(u,o,e)}return[Math.round(r*255),Math.round(i*255),Math.round(s*255)]}function u(e,t,n){e/=255,t/=255,n/=255;var r=Math.max(e,t,n),i=Math.min(e,t,n),s,o,u=(r+i)/2;if(r==i)s=o=0;else{var a=r-i;o=u>.5?a/(2-r-i):a/(r+i);switch(r){case e:s=(t-n)/a+(t<n?6:0);break;case t:s=(n-e)/a+2;break;case n:s=(e-t)/a+4}s/=6}return[s,o,u]}function a(e,t,n){return f(o(e,t,n))}function f(e){function t(e){return e<16?"0"+e.toString(16):e.toString(16)}return"#"+e.map(t).join("")}function l(e,t){var n=t.parentNode;n.lastChild==t?n.appendChild(e):n.insertBefore(e,t.nextSibling)}var n={},r="#ffffff",i=e.ui.colorpicker=function(i,o,f){var c=e.define(o.colorpickerId,function(h){function T(e){function n(){var t=E.offset().left+p,n=E.offset().top+p,r=e.pageX-t,i=n-e.pageY,s=Math.atan(i/r);return r<0&&(s=Math.PI+s),s}var t=n();m=t/(2*Math.PI)-.25,N(t),L(),A()}function N(e){var t={x:Math.round(d*Math.cos(e)),y:Math.round(d*Math.sin(e))};h.wheel_m.left=p+t.x,h.wheel_m.top=p-t.y}function C(e){function i(e){return e<0?0:e>v?v:e}var t={x:e.pageX-S.offset().left,y:e.pageY-S.offset().top},n=i(t.x),r=i(t.y);k(n,r),g=1-n/v,y=1-r/v,A()}function k(e,t){var n=h.overlay_m;n.left=e,n.top=t}function L(){h.hue_color=a(m,1,.5)}function A(){i.value=h.cp_color=a(m,g,y),h.input_color=y>.5?"black":"white"}function O(){"ms-duplex"in i.msData||i.setAttribute("ms-duplex","defaultColor"),i.setAttribute("data-duplex-changed","setByIp"),i.setAttribute("ms-css-background","cp_color"),i.setAttribute("ms-css-color","input_color");var n=t.split("MS_OPTION_COM").map(function(t){return e.parseHTML(t).firstChild}),r=n[1],s=n[2],o=n[3];w=n[0],E=e(s),S=e(o),w.appendChild(r),w.appendChild(s),w.appendChild(o),h.autoHide?(e(w).addClass("oni-colorpicker-auto-hide"),w.setAttribute("ms-visible","toggle"),w.setAttribute("ms-click","cpClick"),i.setAttribute("ms-click","ipClick"),x=e.bind(document,"click",function(){h.toggle=!1}),document.body.appendChild(w)):l(w,i),e.scan(i,[c].concat(f)),e.scan(w,[c].concat(f))}function M(){var e=b.offset();w.style.left=e.left+"px",w.style.top=i.offsetHeight+e.top+"px"}var p=97,d=84,v=100,m,g,y,b=e(i),w,E,S,x;h.$skipArray=["autoHide"],h.wheel_m={left:0,top:0},h.overlay_m={left:0,top:0},h.cp_color="",h.input_color="",h.hue_color="",h.toggle=!1,e.mix(h,o.colorpickerOptions),h.$init=function(){O(),s(i.value)||(e.log(i.value+" 不是合法的十六进制颜色表示法"),i.value=r),h.setByIp(i.value)},h.$remove=function(){w.innerHTML="",e.unbind(document,"click",x)},h.setByIp=function(e){if(e!==h.cp_color&&s(e)){var t=parseInt(e.substr(1,2),16),n=parseInt(e.substr(5,2),16),r=parseInt(e.substr(3,2),16);m=u(t,n,r)[0],g=u(t,n,r)[1],y=u(t,n,r)[2];var i=2*Math.PI*(m+.25),o=(1-g)*v,a=(1-y)*v;N(i),k(o,a),L(),h.cp_color=e,h.input_color=y>.5?"black":"white"}},h.wheelDragStart=function(e,t){t.dragX=!1,t.dragY=!1,T(e)},h.wheelDrag=function(e){T(e)},h.overlayDragStart=function(e,t){t.dragX=!1,t.dragY=!1,C(e)},h.overlayDrag=function(e){C(e)},h.ipClick=function(e){h.toggle=!0,M(),h!==n&&(n.toggle=!1,n=h),e.stopPropagation()},h.cpClick=function(e){e.stopPropagation()}});return c};return i.version=1,i.defaults={autoHide:!0,defaultColor:"#ffffff",bgColor:""},e});