define(["avalon","text!./avalon.scrollbar.html","../draggable/avalon.draggable","css!./avalon.scrollbar.css","css!../chameleon/oniui-common.css"],function(e,t){function n(t,n){var n=n||document.body;if(n.getElementsByClassName)return n.getElementsByClassName(t);var r=n.getElementsByTagName("*"),i=[];return e.each(r,function(n,r){var s=e(r);s.hasClass(t)&&i.push(r)}),i}function r(e){return Math.round(parseFloat(e))||0}var i,s=[],o=[],u=e.ui.scrollbar=function(u,a,f){var l=a.scrollbarOptions;l.template=l.getTemplate(t,l);var c=e.define(a.scrollbarId,function(t){e.mix(t,l),t.widgetElement=u,t.draggerHeight=t.draggerWidth="",t.inFocuse=!1,t._position=[],t.viewElement=u,t.dragging=!1;var a,h=[],p;t.$init=function(t){if(a)return;a=!0,c.widgetElement.style.position="relative",c.viewElement=c.widgetElement==document.body?document.getElementsByTagName("html")[0]:c.widgetElement,c.viewElement.style.overflow=c.viewElement.style.overflowX=c.viewElement.style.overflowY="hidden",c.widgetElement==document.body&&(c.widgetElement.style.overflow=c.widgetElement.style.overflowX=c.widgetElement.style.overflowY="hidden"),c._position=c.position.split(",");var n=e.parseHTML(l.template);c.widgetElement.appendChild(n),t?t():(e.log("avalon请尽快升到1.3.7+"),e.scan(u,[c].concat(f)),typeof l.onInit=="function"&&l.onInit.call(u,c,l,f));var d=c.widgetElement.childNodes;e.each(d,function(t,n){var r=e(n);if(r.hasClass("oni-scrollbar")||r.hasClass("ui-scrollbar"))h.push(r);else if(r.hasClass("oni-scrollbar-scroller")||r.hasClass("ui-scrollbar-scroller"))p=r});if(c.position.match(/left|right/g)){var v=[],m=[];e.each(c._position,function(e,t){t.match(/left|right/g)?v.push([e,t]):m.push([e,t])});function g(t,n,r,i){e.each(n,function(e,n){if(!h[e].data("oni-scrollbar-needed"))return;c._computer(i||function(e){return c._clickComputer(e,t)},n[0],n[1],function(e){e||r.preventDefault()},"breakOutCallbackCannotIgnore")})}function y(e){if(c.disabled)return;c.inFocuse&&g(e.wheelDelta>0?"up":"down",v,e)}function b(e){if(c.disabled)return;var t=e.keyCode;if(t>32&&t<41&c.inFocuse)if(t in{37:1,39:1,38:1,40:1})g(t in{37:1,38:1}?"up":"down",t in{38:1,40:1}?v:m,e);else{var n=t in{33:1,36:1}?"up":"down";g(n,v,e,function(i){var s=p[0].scrollTop;t in{33:1,36:1}?s&&e.preventDefault():s<i.scrollerH-i.viewH&&e.preventDefault();if(t in{36:1,35:1})return{x:0,y:t==36?0:i.draggerparHeight-i.draggerHeight+100};var o=(i.draggerparHeight-i.draggerHeight)*i.viewH/(i.scrollerH-i.viewH);return c._clickComputer(i,n,r(o)||1)})}}c.widgetElement==document.body?(c.inFocuse=!0,s.push(y),o.push(b)):(e.bind(u,"mouseenter",function(e){c.inFocuse=!0,s.push(y),o.push(b)}),e.bind(u,"mouseleave",function(e){c.inFocuse=!1;for(var t=0,n=s.length;t<n;t++)if(s[t]===y){s.splice(t,1),o.splice(t,1);break}})),i||(i=!0,e.bind(document,"mousewheel",function(e){var t=s[s.length-1];t&&t(e)}),e.bind(document,"keydown",function(e){var t=o[o.length-1];t&&t(e)}))}e.bind(u,"mouseenter",function(){e.each(h,function(e,t){c._show("e",!1,t)})}),e.bind(u,"mouseleave",function(){c._hide()}),c.update("init")},t.$draggableOpts={beforeStart:function(){c.dragging=!0},drag:function(t,n){var i=e(n.element);c._computer(function(e){var t={x:r(i.css("left"))>>0,y:r(i.css("top"))>>0};return t.x==e.draggerparWidth-e.draggerWidth&&(t.x+=100),t.y==e.draggerparHeight-e.draggerHeight&&(t.y+=100),t},i.attr("oni-scrollbar-index"),i.attr("oni-scrollbar-pos"))},handle:function(e,t){return!c.disabled&&this},containment:"parent"},t.$draggableOpts.stop=function(t,n){c.$draggableOpts.drag(t,n),c.dragging=!1,e(n.element).removeClass("oni-state-active")},t.$remove=function(){e.each(h,function(e,t){t[0]&&t[0].parentNode&&t[0].parentNode.removeChild(t[0])})},t._onScroll=function(){if(c.show!="scrolling")return;e.each(h,function(e,t){c._show("e",!1,t)})},t._show=function(e,t,n){if(c.show!="scrolling")return;e.stopPropagation&&e.stopPropagation();var r=n.css?n:h[n];r&&(clearTimeout(r.data("oni-scrollbar-hidetimer")),r.css("visibility","visible"),r.css("opacity",1),t||r.data("oni-scrollbar-hidetimer",setTimeout(function(){r.css("opacity",0)},1e3)))},t._hide=function(t,n){if(c.show!="scrolling")return;n&&h[n]?h[n].css("opacity",0):e.each(h,function(e,t){t.css("opacity",0)})},t.getBars=function(){return h},t.getScroller=function(){return p},t.update=function(t,i,s){if(c.disabled)return;var o=e(c.viewElement),u,a,f=c.widgetElement===document.body?c.viewElement.clientHeight:r(o.css("height")),l=r(o.css("width")),d=c.viewHeightGetter(o),v=c.viewWidthGetter(o),m=c.position,g,y={},s=s==void 0?c.scrollTop:s,i=i==void 0?c.scrollLeft:i;c.viewElement!=c.widgetElement&&m.match(/right|left/g)&&e(c.widgetElement).css("height",f);var b=p.width()-p.innerWidth(),w=p.height()-p.innerHeight();p.css("height",d+w),p.css("width",v+b),u=p[0].scrollWidth,a=p[0].scrollHeight,g={top:m.match(/top/g)&&u>v,right:m.match(/right/g)&&a>d,bottom:m.match(/bottom/g)&&u>v,left:m.match(/left/g)&&a>d};if(h.length>1){var E=["top","right","bottom","left"];for(var S=0;S<4;S++)y[E[S]]=[(g[S?E[S-1]:E[3]]&&1)>>0,(g[S<3?E[S+1]:E[0]]&&1)>>0],S>1&&(y[E[S]]=y[E[S]].reverse())}d=p.innerHeight(),v=p.innerWidth(),e.each(c._position,function(o,m){var E=h[o],S=m.match(/left|right/),T;E&&(T=e(n("oni-scrollbar-dragger",E.element)[0])),t&&T&&(T.attr("ms-draggable","$,$draggableOpts"),T.attr("oni-scrollbar-pos",m),T.attr("oni-scrollbar-index",o),e.scan(T[0],c));if(!g[m]){E&&(E.css("opacity",0),E.css("visibility","hidden"),E.data("oni-scrollbar-needed",!1));return}E&&(E.data("oni-scrollbar-needed",!0),E.css("visibility","visible"),c.show=="scrolling"||c.show=="never"?E.css("opacity",0):E.css("opacity",1));if(E){var N=r(E.css("height")),C=r(E.css("width")),k=N,L=C,A=e(n("oni-scrollbar-draggerpar",E[0])[0]),O=c.showBarHeader?2:0,M=[];if(h.length>1){var _=[],D=y[m];S?(_=[["top",D[0]*L],["height",f-L*(D[0]+D[1])]],M=[["top",O/2*L],["height",f-L*(D[0]+D[1]+O)]]):(_=[["left",D[0]*k],["width",l-k*(D[0]+D[1])]],M=[["left",O/2*k],["width",l-k*(O+D[0]+D[1])]]),e.each(_,function(e,t){E.css.apply(E,t)}),k=E.height(),L=E.width()}else S?M=[["top",L],["height",f-L*2]]:M=[["left",k],["width",l-k*2]];var P;S?(P=c.show=="always"?L:0,p.css("width",v+b-P)):(P=c.show=="always"?k:0,p.css("height",d+w-P)),e.each(M,function(e,t){A.css.apply(A,t)}),N=k-O*L,C=L-O*k;var H;if(S){var B=s,j=r(d*N/a);j=c.limitRateV*L>j&&c.limitRateV*L||j,B=B<0?0:B,B=B>a-d?a-d:B,B=r((N-j)*B/(a-d)),B=Math.min(N-j,B),H=[["width","100%"],["height",j],["top",B]],s=s>0?s>a-d+P?a-d+P:s:0}else{var F=i,I=r(v*C/u);I=c.limitRateH*k>I&&c.limitRateH*k||I,F=F<0?0:F,F=F>u-v?u-v:F,F=r((C-I)*F/(u-v)),F=Math.min(C-I,F),H=[["height","100%"],["width",I],["left",F]],i=i>0?i>u-v+P?u-v+P:i:0}e.each(H,function(e,t){T.css.apply(T,t)}),t&&(S?c._scrollTo(void 0,s):c._scrollTo(i,void 0)),c.showBarHeader&&(s==0&&S||!S&&i==0?e(n("oni-scrollbar-arrow-up",E[0])[0]).addClass("oni-state-disabled"):e(n("oni-scrollbar-arrow-up",E[0])[0]).removeClass("oni-state-disabled"),s>=A.innerHeight()-T.innerHeight()&&S||!S&&i>=A.innerWidth()-T.innerWidth()?!c.breakOutCallback&&e(n("oni-scrollbar-arrow-down",E[0])[0]).addClass("oni-state-disabled"):e(n("oni-scrollbar-arrow-down",E[0])[0]).removeClass("oni-state-disabled"))}})},t._arrClick=function(e,t,n,r){if(c.disabled)return;c._computer(function(e){return c._clickComputer(e,t)},r,n)},t._clickComputer=function(e,t,n){var n=n||e.step||40,i=r(e.dragger.css("left"))>>0,s=r(e.dragger.css("top"))>>0,o=t=="down"?i+n:i-n,u=t=="down"?s+n:s-n;return{x:o,y:u}},t._arrDown=function(t,n,r,i,s){if(c.disabled)return;var o=this,u=e(o);clearInterval(u.data("mousedownTimer")),clearTimeout(u.data("setTimer"));var a=h[i];if(s||u.hasClass("oni-state-disabled"))return u.removeClass("oni-state-active");u.data("setTimer",setTimeout(function(){u.addClass("oni-state-active"),u.data("mousedownTimer",setInterval(function(){return c._computer(function(e){return c._clickComputer(e,n)},i,r,function(e){if(!e)return;clearInterval(u.data("mousedownTimer")),clearTimeout(u.data("setTimer"))})},120))},10))},t._barClick=function(t,n,r){if(c.disabled)return;var i=e(this);if(i.hasClass("oni-scrollbar-dragger"))return;c._computer(function(e){return{x:Math.ceil(t.pageX-e.offset.left-e.draggerWidth/2),y:Math.ceil(t.pageY-e.offset.top-e.draggerHeight/2)}},r,n)},t._computer=function(t,i,s,o,u){if(c.disabled)return;var a=h[i];if(a&&a.data("oni-scrollbar-needed")){var f={},l=s.match(/left|right/g);f.dragger=e(n("oni-scrollbar-dragger",a[0])[0]),f.draggerWidth=r(f.dragger.css("width")),f.draggerHeight=r(f.dragger.css("height")),f.draggerpar=e(f.dragger[0].parentNode),f.draggerparWidth=r(f.draggerpar.css("width")),f.draggerparHeight=r(f.draggerpar.css("height")),f.offset=f.draggerpar.offset(),f.up=e(n("oni-scrollbar-arrow-up",a[0])[0]),f.down=e(n("oni-scrollbar-arrow-down",a[0])[0]),f.viewer=e(c.viewElement),f.viewH=p.innerHeight(),f.viewW=p.innerWidth(),f.scrollerH=p[0].scrollHeight,f.scrollerW=p[0].scrollWidth,f.step=l?40*(f.draggerparHeight-f.draggerHeight)/(f.scrollerH-f.viewH):40*(f.draggerparWidth-f.draggerWidth)/(f.scrollerW-f.viewW),f.step=r(f.step)||1;var d=t(f),v;d.x=r(d.x),d.y=r(d.y);if(l){d.y<0?(d.y=0,f.up.addClass("oni-state-disabled"),v=["v","up"]):f.up.removeClass("oni-state-disabled"),d.y>f.draggerparHeight-f.draggerHeight?(d.y=f.draggerparHeight-f.draggerHeight,v=["v","down"],f.down.addClass("oni-state-disabled")):f.down.removeClass("oni-state-disabled");var m=r((f.scrollerH-f.viewH)*d.y/(f.draggerparHeight-f.draggerHeight))-c.scrollTop;f.dragger.css("top",d.y),c._scrollTo(void 0,r((f.scrollerH-f.viewH)*d.y/(f.draggerparHeight-f.draggerHeight)))}else d.x<0?(d.x=0,v=["h","up"],f.up.addClass("oni-state-disabled")):f.up.removeClass("oni-state-disabled"),d.x>f.draggerparWidth-f.draggerWidth?(d.x=f.draggerparWidth-f.draggerWidth,v=["h","down"],!c.breakOutCallback&&f.down.addClass("oni-state-disabled")):f.down.removeClass("oni-state-disabled"),f.dragger.css("left",d.x),c._scrollTo(r((f.scrollerW-f.viewW)*d.x/(f.draggerparWidth-f.draggerWidth)),void 0)}(!c.breakOutCallback||u)&&o&&o(v),c.breakOutCallback&&c.breakOutCallback(v,c,f)},t._scrollTo=function(e,t){t!=void 0&&(p[0].scrollTop=t,c.scrollTop=p[0].scrollTop),e!=void 0&&(p[0].scrollLeft=e,c.scrollLeft=p[0].scrollLeft)},t.scrollTo=function(e,n){c.update(!1,e,n),t._scrollTo(e,n)},t._initWheel=function(e,t){t=="enter"?c.inFocuse=!0:c.inFocuse=!1},t._draggerDown=function(t,n){if(c.disabled)return;var r=e(this);n?r.addClass("oni-state-active"):r.removeClass("oni-state-active")},t._stopPropagation=function(e){e.stopPropagation()}});return c.$watch("scrollLeft",function(e,t){c._onScroll(),c.onScroll&&c.onScroll(e,t,"h",c)}),c.$watch("scrollTop",function(e,t){c._onScroll(),c.onScroll&&c.onScroll(e,t,"v",c)}),c};u.defaults={disabled:!1,toggle:!0,position:"right",limitRateV:1.5,limitRateH:1.5,scrollTop:0,scrollLeft:0,show:"always",showBarHeader:!0,draggerHTML:"",breakOutCallback:!1,onInit:e.noop,viewHeightGetter:function(e){return e.innerHeight()},viewWidthGetter:function(e){return e.innerWidth()},getTemplate:function(e,t){return e},onScroll:function(e,t,n,r){},size:"normal",$author:"skipper@123"}});