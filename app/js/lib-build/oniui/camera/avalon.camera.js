define(["avalon","text!./avalon.camera.html","css!./avalon.camera.css","css!../chameleon/oniui-common.css"],function(e,t){var n=["slideX","slideY","fadeIn","crossX","crossY","stepX","stepY","rotateFadeIn"],r=e.ui.camera=function(r,o,u){var a=o.cameraOptions,f,l;a.template=a.getTemplate(t,a);var c=e.define(o.cameraId,function(t){e.mix(t,a),t.widgetElement=r,t.pictureWidth=e.css(r,"width"),t.pictureHeight=e.css(r,"height"),t.selections=e.range(t.pictures.length),t.selectionWrapOffset=-t.pictures.length*20/2,t.arrowVisible=t.alwaysShowArrow?!0:!1,t.pictureIndex=0,t.selectionIndex=0,t.fakehoverVisible=!1,t.nextPicture=function(){m(g(1),t.effect,1)},t.lastPicture=function(){m(g(-1),t.effect,-1)};var n=0;t.navselect=function(e,r){if(e===t.selectionIndex)return;n=e;if(r.type===t.eventType||t.eventType==="both")r.type==="mouseenter"?setTimeout(function(){m(e,t.effect)},300):m(e,t.effect);var i=setInterval(function(){t.selectionIndex!==n?m(n,t.effect):clearInterval(i)},800)},t.stopPlay=function(){t.hoverStop&&clearInterval(p)},t.restartPlay=function(){t.hoverStop&&d()},t.$skipArray=["widgetElement","template","selectionWrapOffset","pictures","effect","alwaysShowArrow","timeout","speed","alwaysShowSelection","hoverStop","adaptiveWidth","adaptiveHeight","eventType","arrowLeftClass","arrowRightClass","slicedCols","slicedRows"];var i;t.$init=function(n){if(i)return;i=!0;var s=a.template;r.style.display="none",r.innerHTML=s,r.style.display="block",t.adaptiveWidth&&(t.pictureWidth=r.offsetWidth);if(t.adaptiveHeight){r.style.height="100%",t.pictureHeight=e.css(r,"height");var o=r.children;for(var f=0,l=o.length;f<l;f++)o[f].id==="oni-camera"&&(o[f].style.height="100%")}n?n():(e.log("请尽快升到avalon1.3.7+"),e.scan(r,_vmodels),typeof a.onInit=="function"&&a.onInit.call(r,c,a,u))},t.$remove=function(){r.innerHTML=r.textContent=""}}),h=function(){f=c.pictureWidth/c.slicedCols,l=c.pictureHeight/c.slicedRows,require(["jquery"],function(e){var t=e(r).find(".oni-camera-fakehover");t.css("display","none");for(var n=0;n<c.slicedRows;n++){for(var i=0;i<c.slicedCols;i++)t.append("<div class='fakepart'></div>"),e(".oni-camera-fakehover .fakepart:last").css({background:"url("+c.pictures[0]+")","background-position":-i*f+"px "+ -n*l+"px"});t.append("<br>")}e(r).find(".oni-camera-fakehover .fakepart").css({width:f,height:l});for(var n=0;n<c.slicedRows;n++)for(var i=0;i<c.slicedCols;i++)e(r).find(".oni-camera-fakehover .fakepart").eq(n*c.slicedCols+i).css({width:f,height:l});d()})},p,d=function(){p=setInterval(function(){m(g(1),c.effect,1)},c.timeout)},v=!1,m=function(e,t,s){s=s||1;if(v)return;v=!0,c.selectionIndex=e;var o=$(r).find(".oni-camera-fakehover .fakepart"),u=0,t=t==="random"?n[Math.floor(Math.random()*n.length)]:t;for(var a=0;a<c.slicedRows;a++)for(var h=0;h<c.slicedCols;h++){var p=o.eq(a*c.slicedCols+h),d=c.speed,m=0,g=h%2===0?1:-1;p.css({background:"url("+c.pictures[e]+")","background-position":-h*f+"px "+ -a*l+"px","background-size":c.pictureWidth+"px "+c.pictureHeight+"px",top:a*l+"px",left:h*f+"px"});var y=parseFloat(p.css("top")),b=parseFloat(p.css("left"));switch(t){case"slideX":p.css({left:b+c.pictureWidth*s});break;case"slideY":p.css({top:y+c.pictureHeight*s});break;case"fadeIn":p.css({opacity:0});break;case"crossX":g=a%2===0?1:-1,p.css({left:b+g*c.pictureWidth*s});break;case"crossY":p.css({top:y+g*c.pictureHeight*s});break;case"stepX":p.css({left:b+(c.pictureWidth+c.pictureWidth/c.slicedRows*a)*s}),d+=a*(c.speed/c.slicedRows);break;case"stepY":p.css({top:y+(c.pictureHeight+c.pictureHeight/c.slicedCols*h)*s}),d+=h*(c.speed/c.slicedCols);break;case"rotateFadeIn":p.css({opacity:0});var w=i(c.slicedCols,c.slicedRows);m=w[a][h]*(c.speed/(c.slicedCols*c.slicedRows));break;default:}c.fakehoverVisible=!0,p.delay(m).animate({top:y+"px",left:b+"px",opacity:1},d,function(){u+=1,u===c.slicedRows*c.slicedCols&&(c.fakehoverVisible=!1,c.pictureIndex=e,v=!1)})}},g=function(e){var t=c.pictureIndex;return t=e===1?t+1:t-1,t===c.pictures.length?t=0:t===-1&&(t=c.pictures.length-1),t};return e.css(r,"height")===0?s(c.pictures[0],function(){c.pictureHeight=this.height,c.pictureWidth=this.width,h()}):h(),c},i=function(e,t){var n=[];for(var r=0;r<t;r++)n[r]=new Array(e);var i=0,s=0,o=e-1,u=t-1,a=0,f=0;for(var r=0;r<e*t;r++)n[a][f]=r+1,a==s&&f<o?f++:a<u&&f==o?a++:a==u&&f>i?f--:a>s&&f==i&&a--,a-1==s&&f==i&&(s++,i++,o--,u--);return n},s=function(){var e=[],t=null,n=function(){var t=0;for(;t<e.length;t++)e[t].end?e.splice(t--,1):e[t]();!e.length&&r()},r=function(){clearInterval(t),t=null};return function(r,i,s,o){var u,a,f,l,c,h=new Image;h.src=r;if(h.complete){i.call(h),s&&s.call(h);return}a=h.width,f=h.height,h.onerror=function(){o&&o.call(h),u.end=!0,h=h.onload=h.onerror=null},u=function(){l=h.width,c=h.height;if(l!==a||c!==f||l*c>1024)i.call(h),u.end=!0},u(),h.onload=function(){!u.end&&u(),s&&s.call(h),h=h.onload=h.onerror=null},u.end||(e.push(u),t===null&&(t=setInterval(n,40)))}}();r.vertion=1.1,r.defaults={pictures:[],effect:"random",timeout:2500,speed:600,alwaysShowArrow:!0,alwaysShowSelection:!0,hoverStop:!0,adaptiveWidth:!1,adaptiveHeight:!1,eventType:"click",arrowLeftClass:"",arrowRightClass:"",slicedCols:5,slicedRows:4,onInit:e.noop,getTemplate:function(e,t,n){return e},$author:"heiwu805@hotmail.com"}});