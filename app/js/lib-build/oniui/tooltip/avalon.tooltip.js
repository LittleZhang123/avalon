define(["avalon","text!./avalon.tooltip.html","../position/avalon.position","css!./avalon.tooltip.css","css!../chameleon/oniui-common.css"],function(e,t){var n,r=e.ui.tooltip=function(r,i,s){function S(e){var t="left",e=e==n?o.position:e;if(!h||!c)switch(e){case"tc":h="center bottom-"+v,c="center top",t="bottom";break;case"tl":h="left bottom-"+v,c="left top",t="bottom";break;case"tr":h="right bottom-"+v,c="right top",t="bottom";break;case"lt":h="right-"+m+" top",c="left top",t="right";break;case"lc":h="right-"+m+" center",c="left center",t="right";break;case"lb":h="right-"+m+" bottom",c="left bottom",t="right";break;case"rt":h="left+"+m+" top",c="right top",t="left";break;case"rc":h="left+"+m+" center",c="right center",t="left";break;case"rb":h="left+"+m+" bottom",c="right bottom",t="left";break;case"bl":h="left top+"+v,c="left bottom",t="top";break;case"bc":h="center top+"+v,c="center bottom",t="top";break;case"br":h="right top+"+v,c="right bottom",t="top";break;case"cc":h=c="center center",t="bottom";break;default:h="left top+"+v,c="left bottom",t="bottom"}else{var r=c.replace(/[0-9\+\-]+/g,"").split(/\s+/),i=h.replace(/[0-9\+\-]+/g,"").split(/\s+/);r[0]==i[0]?r[1]=="top"?t="bottom":t="top":r[1]==i[1]?r[0]=="left"?t="right":t="left":t=i[1]||"bottom"}return t}function T(){var t=e.parseHTML(x.template),n=t.childNodes[0];return document.body.appendChild(t),n}var o=i.tooltipOptions,u="",a,f,l,c=o.positionAt,h=o.positionMy,p=2,d=1,v=10,m=10,g=o.position,y,b,w,E;o.template=o.getTemplate(t,o);var x=e.define(i.tooltipId,function(t){e.mix(t,o),t.content==n&&(t.content=r.getAttribute("title")),t.widgetElement=r,t.arrClass="left";var i={};t.$skipArray=["widgetElement","template","delegate"],t.toggle="";var u;t.$init=function(t){if(u)return;u=!0,x.arrClass=S(x.position),x.widgetElement.setAttribute("oni-tooltip-id",x.$id),x.event=="mouseenter"&&x.delegate&&(x.event="mouseover"),l=T(),e.scan(l,[x].concat(s)),x.event&&r.setAttribute("ms-"+x.event+"-101","_showHandlder($event)"),t?t():(e.log("avalon请尽快升到1.3.7+"),e.scan(r,[x].concat(s)),typeof o.onInit=="function"&&o.onInit.call(r,x,o,s))},t.$remove=function(){l&&l.parentNode&&l.parentNode.removeChild(l)},t.show=function(t){if(x.disabled||!l)return;t==n&&(t=b);if(t){b=t;var r=e(l),i=e(t),s=c,o=h,u=l.getElementsByTagName("b"),a,v;for(var m=0,g=u.length;m<g;m++){var y=e(u[m]);y.hasClass("oni-tooltip-arrow-out")?a=y:y.hasClass("oni-tooltip-arrow-in")&&(v=y)}e.nextTick(function(){l.style.display="block",r.position({of:t,at:s,my:o,collision:x.collision,within:document.body});if(t.nodeName){r.position().top>i.position().top+t.offsetHeight&&x.arrClass=="bottom"?(x.arrClass="top",r.removeClass("oni-tooltip-bottom").addClass("oni-tooltip-top")):r.position().top+l.offsetHeight<i.position().top&&x.arrClass=="top"&&(x.arrClass="bottom",r.removeClass("oni-tooltip-top").addClass("oni-tooltip-bottom"));if(a&&v){var n=x.arrClass=="bottom"||x.arrClass=="left",u=e(t),f=r.position().left+l.offsetWidth/2>u.position().left+t.offsetWidth,c=r.position().left+l.offsetWidth/2<u.position().left;if(x.arrClass!="top"&&x.arrClass!="bottom"||!c&&!f)if((x.arrClass=="bottom"||x.arrClass=="top")&&l.offsetWidth<t.offsetWidth)a.position({of:l,at:"center "+(n?"bottom":"top"),my:"center "+(n?"top":"bottom"),within:document.body}),v.position({of:l,at:"center "+(n?"bottom":"top"),my:"center "+(n?"top-":"bottom+")+p,within:document.body});else if((x.arrClass=="left"||x.arrClass=="right")&&l.offsetHeight<t.offsetHeight)a.position({of:l,at:(n?"left":"right")+" center",my:(n?"right":"left")+" center",within:document.body}),v.position({of:l,at:(n?"left":"right")+" center",my:(n?"right+":"left-")+d+" center",within:document.body});else{var h=r.offset(),m=e(t).offset(),g=t.offsetHeight,y=t.offsetWidth,b;switch(x.arrClass){case"left":case"right":x.arrClass=="left"?(a[0].style.left="-6px",v[0].style.left="-5px"):(a[0].style.right="-5px",v[0].style.right="-4px"),b=Math.floor(g/2)-h.top+m.top,a[0].style.top=b+"px",v[0].style.top=b+1+"px";break;case"top":case"bottom":default:x.arrClass=="top"?(a[0].style.top="-6px",v[0].style.top="-5px"):(a[0].style.top=v[0].style.top="auto",a[0].style.bottom="-6px",v[0].style.bottom="-5px"),b=Math.floor(y/2)-h.left+m.left,a[0].style.left=b+"px",v[0].style.left=b+1+"px"}}else a.position({of:l,at:(c?"right":"left")+" "+(n?"bottom":"top"),my:(c?"right-10":"left+10")+" "+(n?"top":"bottom"),within:document.body}),v.position({of:l,at:(c?"right":"left")+" "+(n?"bottom":"top"),my:(c?"right-11":"left+11")+" "+(n?"top-":"bottom+")+p/2,within:document.body})}}})}if(x.animated&&!!-[1]){clearInterval(f);var w=e(l).css("opacity")*100>>0;if(w!=100){var E=x._animateArrMaker(w,100);E.splice(0,1),f=setInterval(function(){if(E.length<=0)return clearInterval(f);e(l).css("opacity",E[0]/100),E.splice(0,1)},16)}}},t.hide=function(e){e&&e.preventDefault&&e.preventDefault(),x.toggle?x.toggle=!1:x._hide()},t._hide=function(t){if(!l)return;if(x.animated&&!!-[1]){clearInterval(f);var n=e(l).css("opacity")*100>>0;if(n){var r=x._animateArrMaker(n,0);f=setInterval(function(){if(r.length<=0)return l.style.display="none",e(l).addClass("oni-tooltip-hidden"),clearInterval(f);e(l).css("opacity",r[0]/100),r.splice(0,1)},50)}}else l.style.display="none"},t._hideHandlder=function(){x.toggle?x.toggle=!1:x._hide()},t._showHandlder=function(e,t){x._show(e,n,this)},t._show=function(t,r,i){var o=i||w||x.widgetElement,u=t&&(t.srcElement||t.target)||b||x.widgetElement,r=r||E;if(r===n)if(x.delegate){r=x.contentGetter.call(x,u);while(!r&&u&&u!=o)u=u.parentNode,r=x.contentGetter.call(x,u);o=u}else r=x.contentGetter.call(x,o);else o=u;if(r==n)return;b=o,clearTimeout(a),clearTimeout(f);var c=o.getAttribute("oni-tooltip-inited"),h=o.title;x.content!=r&&(x.content=r),o.title&&(o.title=""),l||(l=T(),e.scan(l,[x].concat(s))),e(l).removeClass("oni-tooltip-hidden"),x.track||S(x.arrClass),x.show(x.track?t||o:o);var c=o.getAttribute("oni-tooltip-inited");c||(o.setAttribute("oni-tooltip-inited",1),x.autohide&&e(o).bind(x.event!="focus"?"mouseout":"blur",function(e){h&&(o.title=h),clearTimeout(a),x.autohide&&(a=setTimeout(x._hideHandlder,x.hiddenDelay))}),x.track&&(x.event=="mouseover"||x.event=="mouseenter")&&e(o).bind("mousemove",function(t){t.stopPropagation(),b=t,x.show(t),e(l).removeClass("oni-tooltip-hidden")}))},t.showBy=function(e,t){var r=e&&e.tagName?e:e.target||e.srcElement;x.toggle&&(x.content=t||x.contentGetter.call(x,r)),w=b=r,E=t,x.toggle?x.show():x.toggle=!0,E=n},t._isShown=function(){var t=e(l);return t.css("display")!="none"&&!t.hasClass("oni-tooltip-hidden")},t.appendTo=function(e){e&&(e.appendChild(l),x.toggle&&x.show())}});return x.$watch("position",function(e){S(x.position),x._isShown()&&x.show()}),x.$watch("positionAt",function(e){c=e,S(x.position),x._isShown()&&x.show()}),x.$watch("positionMy",function(e){h=e,S(x.position),x._isShown()&&x.show()}),x.$watch("toggle",function(e){e?x._show():x._hide()}),x};r.defaults={toggle:!1,collision:"none",event:"mouseenter",content:void 0,width:"auto",height:"auto",arrow:!0,autohide:!0,delegate:!1,disabled:!1,track:!1,animated:!0,position:"rt",positionMy:!1,positionAt:!1,hiddenDelay:16,onInit:e.noop,contentGetter:function(e){if(e.tagName.toLowerCase()!="a")return;return e.title},_animateArrMaker:function(e,t){var n=[],r=10,e=Math.floor(e/r)*r,t=Math.floor(t/r)*r,i=t-e,s=i>0?r:-r;while(e!=t)e+=s,e=e>100?100:e,i=parseInt(i-s),Math.abs(i)<=1&&(e=t),n.push(e);return n.length||(n=[t]),n},getTemplate:function(e,t){return e},$author:"skipper@123"}});