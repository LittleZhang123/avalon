define(["avalon"],function(e){function r(e,n){if(e._state!=="pending")return;e._state="fulfilled";if(n&&typeof n.then=="function"){var r=n instanceof t?"_then":"then";n[r](function(t){s(e,t)},function(t){e._state="rejected",s(e,t)})}else s(e,n)}function i(e,t){if(e._state!=="pending")return;e._state="rejected",s(e,t)}function s(e,t){e._fired=!0,e._value=t,n(function(){e._callbacks.forEach(function(t){e._fire(t.onSuccess,t.onFail)})})}function o(e,n){n=Array.isArray(n)?n:[];var r=0,i=[],s;return new t(function(t,o){function u(u,a){u.then(function(o){if(!s){i[a]=o,r++;if(e||r>=n.length)t(e?o:i),s=!0}},function(e){s=!0,o(e)})}for(var a=0,f=n.length;a<f;a++)u(n[a],a);n.length+e===0&&t([])})}var t=function(e){this._callbacks=[];var t=this;if(typeof this!="object")throw new TypeError("Promises must be constructed via new");if(typeof e!="function")throw new TypeError("not a function");e(function(e){r(t,e)},function(e){i(t,e)})},n=typeof window.setImmediate=="function"?function(e){window.setImmediate(e)}:function(e){window.setTimeout(e,0)};t.resolve=function(e){return new t(function(t){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.prototype={constructor:t,_state:"pending",_fired:!1,_fire:function(e,t){if(this._state==="rejected"){if(typeof t!="function")throw this._value;t(this._value)}else typeof e=="function"&&e(this._value)},_then:function(e,t){if(this._fired){var r=this;n(function(){r._fire(e,t)})}else this._callbacks.push({onSuccess:e,onFail:t})},then:function(e,n){var r=this;return new t(function(t,i){r._then(function(n){if(typeof e=="function")try{n=e(n)}catch(r){i(r);return}t(n)},function(e){if(typeof n=="function"){try{e=n(e)}catch(r){i(r);return}t(e)}else i(e)})})},"catch":function(e){return this.then(null,e)},done:function(e){return this.then(e)},fail:function(e){return this.then(null,e)}},t.all=function(e){return o(!1,e)},t.race=function(e){return o(!0,e)};var u=window.Promise;return/native code/.test(window.Promise)?(u.prototype.done=t.prototype.done,u.prototype.fail=t.prototype.fail,u.any=u.race):(t.any=t.race,window.Promise=t),e.mmPromise=t,e});