define(["../avalon.getModel","text!./avalon.suggest.html","css!../chameleon/oniui-common.css","css!./avalon.suggest.css"],function(e,t){function r(e,t){return e?e==t?!0:r(e.parentNode,t):!1}function i(t,n,r){switch(n.which){case 9:if(!t.toggle)return;t.toggle=!1;break;case 27:if(!t.toggle)return;t.toggle=!1;break;case 13:n.preventDefault();if(!t.toggle)return;t.toggle=!1,t.onChangeCallback(t.list[t.selectedIndex].value,t.inputElement,n);break;case 38:if(!t.toggle)return;--t.selectedIndex,r&&t.suggestCtr.moveUp(t.selectedIndex),t.selectedIndex===-1&&(t.selectedIndex=t.list.length-1),t.onChangeCallback(t.list[t.selectedIndex].value,t.inputElement,n),n.preventDefault();break;case 40:if(!t.toggle)return;++t.selectedIndex,r&&t.suggestCtr.moveDown(t.selectedIndex),t.selectedIndex===t.list.length&&(t.selectedIndex=0),t.onChangeCallback(t.list[t.selectedIndex].value,t.inputElement,n),n.preventDefault();break;default:var i=e.bind(t.inputElement,"keyup",function(){t.searchText=this.value||String.fromCharCode(n.which),e.unbind(t.inputElement,"keyup",i)})}}function s(t,n,r){if(n.loading==1)return;var i=e.ui.suggest.strategies[n.strategy];if(!i)return;n.loading=!0,i(t,function(t){n.selectedIndex=0,n.list.removeAll(),e.each(t,function(e,t){typeof t=="string"?n.list.push({text:t,value:t}):n.list.push(t)}),n.loading=!1,t.length==0?n.toggle=!1:n.toggle=!0,r&&n.suggestCtr.reset()})}function o(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var n=e.ui.suggest=function(n,i,s){var o=e(n),u=i.suggestOptions,a=u.getTemplate(t),f=e.parseHTML(a).firstChild,l=i.value.split(","),c=l[2]?e.getModel(l[2],s)||0:0,h=/^(\d+).*$/;c=u.notpuresuggest?c[1][c[0]]:0,c&&e.mix(u,c),u.inputElement=u.notpuresuggest?u.inputElement:document.getElementById(u.inputElement),u.textboxContainer=u.textboxContainer==""?u.inputElement:u.textboxContainer;var p=u.limit,d,v=u.suggestCtr||{_minIndex:0,_maxIndex:p-1,_items:"",moveUp:function(e){e<this._minIndex?this._minIndex==0?(this._minIndex=m.list.length-p,this._maxIndex=m.list.length-1,this._update(),this.scroll.set(this._getHeight(0,this._minIndex-1))):(this._minIndex--,this._maxIndex--,this._update(),this.scroll.pre()):this.scroll.isScolled&&this.scroll.recover()},moveDown:function(e){e>this._maxIndex?this._maxIndex==m.list.length-1?(this._minIndex=0,this._maxIndex=p-1,this._update(),this.scroll.set(0)):(this._minIndex++,this._maxIndex++,this._update(),this.scroll.next()):this.scroll.isScolled&&this.scroll.recover()},reset:function(){this._minIndex=0,this._maxIndex=p-1,d.scrollTop=0,this._items=d.getElementsByTagName("li"),this._update()},scroll:{isScolled:!1,set:function(e){d.scrollTop=e,this.isScolled=!1},pre:function(){this.isScolled?this.recover():d.scrollTop-=v._items[v._minIndex].offsetHeight},next:function(){this.isScolled?this.recover():d.scrollTop+=v._items[v._minIndex-1].offsetHeight},recover:function(){this.set(v._getHeight(0,v._minIndex-1))}},_update:function(){m.list.length>p?(d.style.overflowY="scroll",d.style.height=this._getHeight(this._minIndex,this._maxIndex)+"px"):(d.style.overflowY="auto",d.style.height="auto")},_getHeight:function(e,t){var n=0,r=this._items;for(var i=e;i<=t;i++)n+=r[i].offsetHeight;return n}},m=e.define(i.suggestId,function(t){e.mix(t,u),t.$skipArray=["widgetElement","puresuggest","limit","suggestCtr"],t.widgetElement=n,t.list=[],t.searchText="",t.toggle=!1,t.loading=!1,t.selectedIndex=0,t.suggestCtr=v,t._renderItem=function(e){if(!e)return;return m.renderItem(e,m)},t.$watch("toggle",function(t){var r=u.inputElement,i=u.textboxContainer,s=e(r),a=e(i);if(t){if(i===r){var l=o.offset(),c=s.width()+"px";n.style.cssText="position: absolute; left:"+l.left+"px;top:"+l.top+"px;",f.style.cssText="margin:0;left:0;top:0;width:"+c;return}f.style.width=a.outerWidth()-2-e(f).css("paddingLeft").replace(h,"$1")-e(f).css("paddingRight").replace(h,"$1")+"px"}}),t.$watch("searchText",function(e){m.updateSource(e,m,p)}),t.clickcallback=function(e,t){var n=m.list[e].value;m.onChangeCallback(n,m.inputElement,t),typeof m.onSelectItem=="function"&&m.onSelectItem.call(null,n,m.inputElement),m.toggle=!1},t.hidepromptinfo=function(e){if(!m.toggle)return!1;if(r(e.target,u.textboxContainer))return;m.toggle=!1},t.$init=function(){e.bind(u.inputElement,"keydown",function(e){m.keyDownOperation(m,e,p)}),e.bind(document,"click",t.hidepromptinfo),e.nextTick(function(){n.appendChild(f),e.scan(n,[m].concat(s)),v.suggest=d=n.getElementsByTagName("ul")[0],e.bind(d,"scroll",function(){v.scroll.isScolled=!0}),typeof u.onInit=="function"&&u.onInit.call(n,m,u,s)})},t.$remove=function(){n.innerHTML=""}});u.focus&&e.bind(u.inputElement,"focus",function(e){var t=this.value;m.searchText==t?m.updateSource(t,m,p):m.searchText=t});if(u.onChange){var g=e.getModel(u.onChange,s),y=m.onChangeCallback;m.onChangeCallback=function(){y.apply(null,arguments),g[1][g[0]].apply(g[1],arguments)}}return m};return n.defaults={inputElement:"",strategy:"__getVal",textboxContainer:"",focus:!1,changed:!1,onSelectItem:"",emphasize:!0,getTemplate:function(e){return e},keyDownOperation:i,onChangeCallback:function(e,t){t.value=e},updateSource:s,renderItem:function(e,t){if(!t.emphasize)return e.text;e=e.text;var n=o(t.searchText);return e.replace(new RegExp("("+n+")","ig"),function(e,t){return t.charCodeAt(0)<32&&(t=""+t.slice(1)),"<b style='color:#f55'>"+t+"</b>"})}},e.ui.suggest.strategies={__getVal:function(e,t){t(e?[e+"1",e+"2",e+"3",e+"4",e+"5",e+"6",e+"7",e+"8",e+"9"]:[])}},e});